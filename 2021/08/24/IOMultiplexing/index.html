<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="golang,golang source,network,">










<meta name="description" content="æ“ä½œç³»ç»Ÿä¸Šçš„ I/O æ˜¯ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´çš„æ•°æ®äº¤äº’ï¼Œé€šå¸¸åŒ…å«ä»¥ä¸‹ä¸¤ä¸ªæ­¥éª¤ï¼š   ç­‰å¾…ç½‘ç»œæ•°æ®åˆ°è¾¾ç½‘å¡(è¯»å°±ç»ª)/ç­‰å¾…ç½‘å¡å¯å†™(å†™å°±ç»ª) â€“&amp;gt; è¯»å–/å†™å…¥åˆ°å†…æ ¸ç¼“å†²åŒº ä»å†…æ ¸ç¼“å†²åŒºå¤åˆ¶æ•°æ® â€“&amp;gt; ç”¨æˆ·ç©ºé—´(è¯»)/ä»ç”¨æˆ·ç©ºé—´å¤åˆ¶æ•°æ® -&amp;gt; å†…æ ¸ç¼“å†²åŒº(å†™)   è€Œåˆ¤å®šä¸€ä¸ª I/O æ¨¡å‹æ˜¯åŒæ­¥è¿˜æ˜¯å¼‚æ­¥ï¼Œä¸»è¦çœ‹ç¬¬äºŒæ­¥ï¼šæ•°æ®åœ¨ç”¨æˆ·å’Œå†…æ ¸ç©ºé—´ä¹‹é—´å¤åˆ¶çš„æ—¶å€™æ˜¯ä¸æ˜¯ä¼šé˜»å¡å½“å‰è¿›ç¨‹ï¼Œå¦‚æœä¼šï¼Œåˆ™æ˜¯">
<meta name="keywords" content="golang,golang source,network">
<meta property="og:type" content="article">
<meta property="og:title" content="æ·±å…¥ç†è§£Golangç½‘ç»œè½®è¯¢å™¨NetPoller">
<meta property="og:url" content="http://yoursite.com/2021/08/24/IOMultiplexing/index.html">
<meta property="og:site_name" content="Wxning">
<meta property="og:description" content="æ“ä½œç³»ç»Ÿä¸Šçš„ I/O æ˜¯ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´çš„æ•°æ®äº¤äº’ï¼Œé€šå¸¸åŒ…å«ä»¥ä¸‹ä¸¤ä¸ªæ­¥éª¤ï¼š   ç­‰å¾…ç½‘ç»œæ•°æ®åˆ°è¾¾ç½‘å¡(è¯»å°±ç»ª)/ç­‰å¾…ç½‘å¡å¯å†™(å†™å°±ç»ª) â€“&amp;gt; è¯»å–/å†™å…¥åˆ°å†…æ ¸ç¼“å†²åŒº ä»å†…æ ¸ç¼“å†²åŒºå¤åˆ¶æ•°æ® â€“&amp;gt; ç”¨æˆ·ç©ºé—´(è¯»)/ä»ç”¨æˆ·ç©ºé—´å¤åˆ¶æ•°æ® -&amp;gt; å†…æ ¸ç¼“å†²åŒº(å†™)   è€Œåˆ¤å®šä¸€ä¸ª I/O æ¨¡å‹æ˜¯åŒæ­¥è¿˜æ˜¯å¼‚æ­¥ï¼Œä¸»è¦çœ‹ç¬¬äºŒæ­¥ï¼šæ•°æ®åœ¨ç”¨æˆ·å’Œå†…æ ¸ç©ºé—´ä¹‹é—´å¤åˆ¶çš„æ—¶å€™æ˜¯ä¸æ˜¯ä¼šé˜»å¡å½“å‰è¿›ç¨‹ï¼Œå¦‚æœä¼šï¼Œåˆ™æ˜¯">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://yoursite.com/images/io-1.png">
<meta property="og:image" content="http://yoursite.com/images/io-2.png">
<meta property="og:image" content="http://yoursite.com/images/io-3.png">
<meta property="og:updated_time" content="2021-08-30T09:30:18.173Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="æ·±å…¥ç†è§£Golangç½‘ç»œè½®è¯¢å™¨NetPoller">
<meta name="twitter:description" content="æ“ä½œç³»ç»Ÿä¸Šçš„ I/O æ˜¯ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´çš„æ•°æ®äº¤äº’ï¼Œé€šå¸¸åŒ…å«ä»¥ä¸‹ä¸¤ä¸ªæ­¥éª¤ï¼š   ç­‰å¾…ç½‘ç»œæ•°æ®åˆ°è¾¾ç½‘å¡(è¯»å°±ç»ª)/ç­‰å¾…ç½‘å¡å¯å†™(å†™å°±ç»ª) â€“&amp;gt; è¯»å–/å†™å…¥åˆ°å†…æ ¸ç¼“å†²åŒº ä»å†…æ ¸ç¼“å†²åŒºå¤åˆ¶æ•°æ® â€“&amp;gt; ç”¨æˆ·ç©ºé—´(è¯»)/ä»ç”¨æˆ·ç©ºé—´å¤åˆ¶æ•°æ® -&amp;gt; å†…æ ¸ç¼“å†²åŒº(å†™)   è€Œåˆ¤å®šä¸€ä¸ª I/O æ¨¡å‹æ˜¯åŒæ­¥è¿˜æ˜¯å¼‚æ­¥ï¼Œä¸»è¦çœ‹ç¬¬äºŒæ­¥ï¼šæ•°æ®åœ¨ç”¨æˆ·å’Œå†…æ ¸ç©ºé—´ä¹‹é—´å¤åˆ¶çš„æ—¶å€™æ˜¯ä¸æ˜¯ä¼šé˜»å¡å½“å‰è¿›ç¨‹ï¼Œå¦‚æœä¼šï¼Œåˆ™æ˜¯">
<meta name="twitter:image" content="http://yoursite.com/images/io-1.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'åšä¸»'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2021/08/24/IOMultiplexing/">





  <title>æ·±å…¥ç†è§£Golangç½‘ç»œè½®è¯¢å™¨NetPoller | Wxning</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>
    <a href="https://github.com/wxning1107" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewbox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Wxning</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            é¦–é¡µ
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            æ ‡ç­¾
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            åˆ†ç±»
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            å½’æ¡£
          </a>
        </li>
      
        
        <li class="menu-item menu-item-ä¸ªäººç®€å†">
          <a href="/ä¸ªäººç®€å†/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            ä¸ªäººç®€å†
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/08/24/IOMultiplexing/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wxning">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wxning">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">æ·±å…¥ç†è§£Golangç½‘ç»œè½®è¯¢å™¨NetPoller</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2021-08-24T17:10:59+08:00">
                2021-08-24
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/golang-è®¡ç®—æœºç½‘ç»œ/" itemprop="url" rel="index">
                    <span itemprop="name">golang - è®¡ç®—æœºç½‘ç»œ</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i> é˜…è¯»æ•°
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>æ¬¡
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>æ“ä½œç³»ç»Ÿä¸Šçš„ I/O æ˜¯ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´çš„æ•°æ®äº¤äº’ï¼Œé€šå¸¸åŒ…å«ä»¥ä¸‹ä¸¤ä¸ªæ­¥éª¤ï¼š</p>
<blockquote>
<ol>
<li>ç­‰å¾…ç½‘ç»œæ•°æ®åˆ°è¾¾ç½‘å¡(è¯»å°±ç»ª)/ç­‰å¾…ç½‘å¡å¯å†™(å†™å°±ç»ª) â€“&gt; è¯»å–/å†™å…¥åˆ°å†…æ ¸ç¼“å†²åŒº</li>
<li>ä»å†…æ ¸ç¼“å†²åŒºå¤åˆ¶æ•°æ® â€“&gt; ç”¨æˆ·ç©ºé—´(è¯»)/ä»ç”¨æˆ·ç©ºé—´å¤åˆ¶æ•°æ® -&gt; å†…æ ¸ç¼“å†²åŒº(å†™)</li>
</ol>
</blockquote>
<p>è€Œåˆ¤å®šä¸€ä¸ª I/O æ¨¡å‹æ˜¯åŒæ­¥è¿˜æ˜¯å¼‚æ­¥ï¼Œä¸»è¦çœ‹ç¬¬äºŒæ­¥ï¼šæ•°æ®åœ¨ç”¨æˆ·å’Œå†…æ ¸ç©ºé—´ä¹‹é—´å¤åˆ¶çš„æ—¶å€™æ˜¯ä¸æ˜¯ä¼šé˜»å¡å½“å‰è¿›ç¨‹ï¼Œå¦‚æœä¼šï¼Œåˆ™æ˜¯åŒæ­¥ I/Oï¼Œå¦åˆ™ï¼Œå°±æ˜¯å¼‚æ­¥ I/Oã€‚</p>
<h2 id="é˜»å¡I-Oä¸éé˜»å¡I-O"><a href="#é˜»å¡I-Oä¸éé˜»å¡I-O" class="headerlink" title="é˜»å¡I/Oä¸éé˜»å¡I/O"></a>é˜»å¡I/Oä¸éé˜»å¡I/O</h2><p>å½“æˆ‘ä»¬é€šè¿‡ <code>read</code> æˆ–è€… <code>write</code> ç­‰ç³»ç»Ÿè°ƒç”¨è¯»å†™æ–‡ä»¶æˆ–è€…ç½‘ç»œæ—¶ï¼Œåº”ç”¨ç¨‹åºä¼šè¢«é˜»å¡ï¼Œå½“æˆ‘ä»¬æ‰§è¡Œ <code>read</code> ç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œåº”ç”¨ç¨‹åºä¼šä»ç”¨æˆ·æ€é™·å…¥å†…æ ¸æ€ï¼Œå†…æ ¸ä¼šæ£€æŸ¥æ–‡ä»¶æè¿°ç¬¦æ˜¯å¦å¯è¯»ï¼Œå½“æ–‡ä»¶æè¿°ç¬¦ä¸­å­˜åœ¨æ•°æ®æ—¶ï¼Œæ“ä½œç³»ç»Ÿå†…æ ¸ä¼šå°†å‡†å¤‡å¥½çš„æ•°æ®æ‹·è´ç»™åº”ç”¨ç¨‹åºå¹¶äº¤å›æ§åˆ¶æƒã€‚</p>
<p>éé˜»å¡I/Oå°±æ˜¯æ‰€æœ‰ I/O æ“ä½œéƒ½æ˜¯ç«‹åˆ»è¿”å›è€Œä¸ä¼šé˜»å¡å½“å‰ç”¨æˆ·è¿›ç¨‹ï¼Œå½“è¿›ç¨‹æŠŠä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦è®¾ç½®æˆéé˜»å¡æ—¶ï¼Œæ‰§è¡Œ <code>read</code> å’Œ <code>write</code> ç­‰ I/O æ“ä½œä¼šç«‹åˆ»è¿”å›ï¼Œä¸‹é¢æ˜¯Cè¯­è¨€ä»£ç ï¼Œ<a href="https://github.com/torvalds/linux/blob/f757165705e92db62f85a1ad287e9251d1f2cd82/fs/fcntl.c#L448" target="_blank" rel="noopener"><code>fcntl</code></a> ä¸ºæˆ‘ä»¬æä¾›äº†æ“ä½œæ–‡ä»¶æè¿°ç¬¦çš„èƒ½åŠ›ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å®ƒä¿®æ”¹æ–‡ä»¶æè¿°ç¬¦çš„ç‰¹æ€§ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> flags = fcntl(fd, F_GETFL, <span class="number">0</span>);</span><br><span class="line">fcntl(fd, F_SETFL, flags | O_NONBLOCK);</span><br></pre></td></tr></table></figure>

<p>å½“æˆ‘ä»¬å°†æ–‡ä»¶æè¿°ç¬¦ä¿®æ”¹æˆéé˜»å¡åï¼Œè¯»å†™æ–‡ä»¶ä¼šç»å†ä»¥ä¸‹æµç¨‹ï¼š</p>
<p><img src="/images/io-1.png" alt="io"></p>
<p>å¦‚æœ kernel ä¸­çš„æ•°æ®è¿˜æ²¡æœ‰å‡†å¤‡å¥½ï¼Œé‚£ä¹ˆå®ƒå¹¶ä¸ä¼š block ç”¨æˆ·è¿›ç¨‹ï¼Œè€Œæ˜¯ç«‹åˆ»è¿”å›ä¸€ä¸ª <code>EAGAIN</code> errorï¼Œ<code>EAGAIN</code> æ„å‘³ç€è¯¥æ–‡ä»¶æè¿°ç¬¦è¿˜åœ¨ç­‰å¾…ç¼“å†²åŒºä¸­çš„æ•°æ®ï¼Œéšåï¼Œåº”ç”¨ç¨‹åºä¼šä¸æ–­è½®è¯¢è°ƒç”¨ <code>read</code> ç›´åˆ°å®ƒçš„è¿”å›å€¼å¤§äº 0ï¼Œè¿™æ—¶åº”ç”¨ç¨‹åºå°±å¯ä»¥å¯¹è¯»å–æ“ä½œç³»ç»Ÿç¼“å†²åŒºä¸­çš„æ•°æ®å¹¶è¿›è¡Œæ“ä½œã€‚ä»ç”¨æˆ·è¿›ç¨‹è§’åº¦è®² ï¼Œå®ƒå‘èµ·ä¸€ä¸ª read æ“ä½œåï¼Œå¹¶ä¸éœ€è¦ç­‰å¾…ï¼Œè€Œæ˜¯é©¬ä¸Šå°±å¾—åˆ°äº†ä¸€ä¸ªç»“æœã€‚ç”¨æˆ·è¿›ç¨‹åˆ¤æ–­ç»“æœæ˜¯ä¸€ä¸ª error æ—¶ï¼Œå®ƒå°±çŸ¥é“æ•°æ®è¿˜æ²¡æœ‰å‡†å¤‡å¥½ï¼Œäºæ˜¯å®ƒå¯ä»¥å†æ¬¡å‘é€ read æ“ä½œã€‚ä¸€æ—¦ kernel ä¸­çš„æ•°æ®å‡†å¤‡å¥½äº†ï¼Œå¹¶ä¸”åˆå†æ¬¡æ”¶åˆ°äº†ç”¨æˆ·è¿›ç¨‹çš„ system callï¼Œé‚£ä¹ˆå®ƒé©¬ä¸Šå°±å°†æ•°æ®æ‹·è´åˆ°äº†ç”¨æˆ·å†…å­˜ï¼Œç„¶åè¿”å›ã€‚è¿›ç¨‹ä½¿ç”¨éé˜»å¡çš„ I/O æ“ä½œæ—¶ï¼Œå¯ä»¥åœ¨ç­‰å¾…è¿‡ç¨‹ä¸­æ‰§è¡Œå…¶ä»–ä»»åŠ¡ï¼Œæé«˜ CPU çš„åˆ©ç”¨ç‡ã€‚</p>
<h2 id="I-Oå¤šè·¯å¤ç”¨"><a href="#I-Oå¤šè·¯å¤ç”¨" class="headerlink" title="I/Oå¤šè·¯å¤ç”¨"></a>I/Oå¤šè·¯å¤ç”¨</h2><p><strong>æ‰€è°“ I/O å¤šè·¯å¤ç”¨æŒ‡çš„å°±æ˜¯ select/poll/epoll è¿™ä¸€ç³»åˆ—çš„å¤šè·¯é€‰æ‹©å™¨ï¼šæ”¯æŒå•ä¸€çº¿ç¨‹åŒæ—¶ç›‘å¬å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼ˆI/O äº‹ä»¶ï¼‰ï¼Œé˜»å¡ç­‰å¾…ï¼Œå¹¶åœ¨å…¶ä¸­æŸä¸ªæ–‡ä»¶æè¿°ç¬¦å¯è¯»å†™æ—¶æ”¶åˆ°é€šçŸ¥ã€‚ I/O å¤ç”¨å…¶å®å¤ç”¨çš„ä¸æ˜¯ I/O è¿æ¥ï¼Œè€Œæ˜¯å¤ç”¨çº¿ç¨‹ï¼Œè®©ä¸€ä¸ª thread of control èƒ½å¤Ÿå¤„ç†å¤šä¸ªè¿æ¥ï¼ˆI/O äº‹ä»¶ï¼‰ã€‚</strong></p>
<h2 id="select-amp-poll"><a href="#select-amp-poll" class="headerlink" title="select &amp; poll"></a>select &amp; poll</h2><p>select æ˜¯ epoll ä¹‹å‰ Linux ä½¿ç”¨çš„ I/O äº‹ä»¶é©±åŠ¨æŠ€æœ¯ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/select.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"> <span class="comment">/* According to earlier standards */</span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"> <span class="comment">// nfdsæ˜¯ç›‘å¬çš„æ–‡ä»¶æè¿°ç¬¦çš„é›†åˆä¸­çš„æœ€å¤§æ–‡ä»¶æè¿°ç¬¦åŠ 1ã€‚readsetæ˜¯è¯»äº‹ä»¶é›†åˆï¼Œwritesetæ˜¯å†™äº‹ä»¶é›†åˆï¼Œexceptsetæ˜¯å¼‚å¸¸äº‹ä»¶é›†åˆï¼Œè‹¥å¦‚æœå¯¹æŸä¸€ä¸ªé›†åˆä¸æ„Ÿå…´è¶£ï¼Œå°±å¯ä»¥æŠŠå®ƒè®¾ä¸ºNULL</span></span><br><span class="line"> <span class="comment">// è¿”å›å€¼ï¼šè‹¥æœ‰å°±ç»ªæè¿°ç¬¦è¿”å›å…¶æ•°ç›®ï¼Œè‹¥è¶…æ—¶åˆ™ä¸º0ï¼Œè‹¥å‡ºé”™åˆ™ä¸º-1</span></span><br><span class="line"> <span class="function"><span class="keyword">int</span> <span class="title">select</span><span class="params">(<span class="keyword">int</span> nfds, fd_set *readfds, fd_set *writefds, fd_set *exceptfds, struct timeval *timeout)</span></span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// å’Œ select ç´§å¯†ç»“åˆçš„å››ä¸ªå®ï¼š</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FD_CLR</span><span class="params">(<span class="keyword">int</span> fd, fd_set *<span class="built_in">set</span>)</span></span>; <span class="comment">// åœ¨æ–‡ä»¶æè¿°ç¬¦é›†åˆä¸­åˆ é™¤ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">FD_ISSET</span><span class="params">(<span class="keyword">int</span> fd, fd_set *<span class="built_in">set</span>)</span></span>; <span class="comment">//æŒ‡å®šçš„æ–‡ä»¶æè¿°ç¬¦æ˜¯å¦åœ¨è¯¥é›†åˆä¸­ï¼Œå¦‚fdåœ¨æ–‡ä»¶æè¿°ç¬¦é›†ä¸­ï¼Œè¿”å›é0å€¼ï¼Œå¦åˆ™è¿”å›0</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FD_SET</span><span class="params">(<span class="keyword">int</span> fd, fd_set *<span class="built_in">set</span>)</span></span>; <span class="comment">// åœ¨æ–‡ä»¶æè¿°ç¬¦é›†åˆä¸­å¢åŠ ä¸€ä¸ªæ–°çš„æ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FD_ZERO</span><span class="params">(fd_set *<span class="built_in">set</span>)</span></span>; <span class="comment">// æ¸…ç©ºæ–‡ä»¶æè¿°ç¬¦é›†</span></span><br></pre></td></tr></table></figure>

<p>ä¸‹é¢æ˜¯ä¸€ä¸ª<code>select</code>ä¾‹å­ï¼Œåˆ›å»º 5 ä¸ªå­è¿›ç¨‹ï¼Œæ¯ä¸ªè¿›ç¨‹è¿æ¥åˆ°æœåŠ¡å™¨å¹¶å‘æœåŠ¡å™¨å‘é€æ¶ˆæ¯ï¼ŒæœåŠ¡å™¨è¿›ç¨‹ä½¿ç”¨ accept ä¸ºæ¯ä¸ªå®¢æˆ·ç«¯åˆ›å»ºä¸åŒçš„æ–‡ä»¶æè¿°ç¬¦ï¼Œ<code>select</code> ä¸­çš„ç¬¬ä¸€ä¸ªå‚æ•°åº”è¯¥æ˜¯ä¸‰ä¸ªé›†åˆä¸­ä»»ä½•ä¸€ä¸ªä¸­ç¼–å·æœ€å¤§çš„æ–‡ä»¶æè¿°ç¬¦åŠ ä¸Š 1ã€‚åˆ›å»ºä¸€ç»„æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦ï¼Œè°ƒç”¨ <code>select</code> å¹¶åœ¨è¿”å›æ—¶æ£€æŸ¥å“ªä¸ªæ–‡ä»¶æè¿°ç¬¦å·²å‡†å¤‡å¥½è¯»å–ã€‚<code>select</code> è¿”å›æ—¶ï¼Œ å°†é›†åˆæ›´æ”¹ä¸ºä»…åŒ…å«å‡†å¤‡å¥½çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦åœ¨æ¯æ¬¡è¿­ä»£æ—¶å†æ¬¡æ„å»ºè¯¥é›†åˆã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/select.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXBUF 256</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">child_process</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  sleep(<span class="number">2</span>);</span><br><span class="line">  <span class="keyword">char</span> msg[MAXBUF];</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">addr</span> = &#123;</span><span class="number">0</span>&#125;;</span><br><span class="line">  <span class="keyword">int</span> n, sockfd,num=<span class="number">1</span>;</span><br><span class="line">  srandom(getpid());</span><br><span class="line">  <span class="comment">/* Create socket and connect to server */</span></span><br><span class="line">  sockfd = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">  addr.sin_family = AF_INET;</span><br><span class="line">  addr.sin_port = htons(<span class="number">2000</span>);</span><br><span class="line">  addr.sin_addr.s_addr = inet_addr(<span class="string">"127.0.0.1"</span>);</span><br><span class="line"></span><br><span class="line">  connect(sockfd, (struct sockaddr*)&amp;addr, <span class="keyword">sizeof</span>(addr));</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"child &#123;%d&#125; connected \n"</span>, getpid());</span><br><span class="line">  <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        <span class="keyword">int</span> sl = (random() % <span class="number">10</span> ) +  <span class="number">1</span>;</span><br><span class="line">        num++;</span><br><span class="line">     	sleep(sl);</span><br><span class="line">  	<span class="built_in">sprintf</span> (msg, <span class="string">"Test message %d from client %d"</span>, num, getpid());</span><br><span class="line">  	n = write(sockfd, msg, <span class="built_in">strlen</span>(msg));	<span class="comment">/* Send message */</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buffer[MAXBUF];</span><br><span class="line">  <span class="keyword">int</span> fds[<span class="number">5</span>];</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">addr</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">client</span>;</span></span><br><span class="line">  <span class="comment">// ç”¨äºè®°å½•æœ€å¤§çš„fdä½ç½®</span></span><br><span class="line">  <span class="keyword">int</span> addrlen, n,i,max=<span class="number">0</span>;;</span><br><span class="line">  <span class="keyword">int</span> sockfd, commfd;</span><br><span class="line">  fd_set rset;</span><br><span class="line">  <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++)</span><br><span class="line">  &#123;</span><br><span class="line">  	<span class="keyword">if</span>(fork() == <span class="number">0</span>)</span><br><span class="line">  	&#123;</span><br><span class="line">  		child_process();</span><br><span class="line">  		<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  	&#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  sockfd = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;addr, <span class="number">0</span>, <span class="keyword">sizeof</span> (addr));</span><br><span class="line">  addr.sin_family = AF_INET;</span><br><span class="line">  addr.sin_port = htons(<span class="number">2000</span>);</span><br><span class="line">  addr.sin_addr.s_addr = INADDR_ANY;</span><br><span class="line">  bind(sockfd,(struct sockaddr*)&amp;addr ,<span class="keyword">sizeof</span>(addr));</span><br><span class="line">  listen (sockfd, <span class="number">5</span>); </span><br><span class="line">	<span class="comment">// åˆ›å»º5ä¸ªæ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line">  <span class="keyword">for</span> (i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++) </span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;client, <span class="number">0</span>, <span class="keyword">sizeof</span> (client));</span><br><span class="line">    addrlen = <span class="keyword">sizeof</span>(client);</span><br><span class="line">    <span class="comment">// å£°æ˜æ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line">    fds[i] = accept(sockfd,(struct sockaddr*)&amp;client, &amp;addrlen);</span><br><span class="line">    <span class="keyword">if</span>(fds[i] &gt; max)</span><br><span class="line">    	max = fds[i];</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">  <span class="comment">// ç”±äºselectåçš„rsetä¼šè¢«ç½®ä½ï¼Œæ‰€æœ‰æ¯æ¬¡å¾ªç¯éœ€è¦å¯¹rsetç½®ç©ºï¼Œç„¶åå†å°†fdsèµ‹ç»™rset</span></span><br><span class="line">	FD_ZERO(&amp;rset);</span><br><span class="line">  	<span class="keyword">for</span> (i = <span class="number">0</span>; i&lt; <span class="number">5</span>; i++ ) &#123;</span><br><span class="line">  		FD_SET(fds[i],&amp;rset);</span><br><span class="line">  	&#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"round again"</span>);</span><br><span class="line">  <span class="comment">// rsetæ˜¯ä¸€ä¸ªbitmap  </span></span><br><span class="line">  <span class="comment">// é˜»å¡ï¼Œæ¯æ¬¡éœ€è¦æŠŠfdä»ç”¨æˆ·æ€æ‹·è´åˆ°å†…æ ¸æ€ </span></span><br><span class="line">  <span class="comment">// å½“æœ‰I/Oæ•°æ®æ—¶ï¼Œselectè¿”å›ï¼Œå¹¶ä¸”å°†rsetç½®ä½ï¼Œæ²¡æ•°æ®çš„ä½ä¼šè¢«æ¸…ç©º  </span></span><br><span class="line">	select(max+<span class="number">1</span>, &amp;rset, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">  <span class="comment">// éå†ï¼Œåˆ¤æ–­å“ªä¸ªfdè¢«ç½®ä½</span></span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++) &#123;</span><br><span class="line">		<span class="keyword">if</span> (FD_ISSET(fds[i], &amp;rset))&#123;</span><br><span class="line">			<span class="built_in">memset</span>(buffer,<span class="number">0</span>,MAXBUF);</span><br><span class="line">      <span class="comment">// è¯»æ•°æ®</span></span><br><span class="line">			read(fds[i], buffer, MAXBUF);</span><br><span class="line">			<span class="built_in">puts</span>(buffer);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;	</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç†è§£ select çš„å…³é”®åœ¨äºç†è§£ <code>fd_set</code>ï¼Œä¸ºè¯´æ˜æ–¹ä¾¿ï¼Œå– <code>fd_set</code> é•¿åº¦ä¸º 1 å­—èŠ‚ï¼Œfd_set ä¸­çš„æ¯ä¸€ bit å¯ä»¥å¯¹åº”ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ <code>fd</code>ï¼Œåˆ™ 1 å­—èŠ‚é•¿çš„ <code>fd_set</code> æœ€å¤§å¯ä»¥å¯¹åº” 8 ä¸ª fdã€‚select çš„è°ƒç”¨è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<blockquote>
<ol>
<li>æ‰§è¡Œ FD_ZERO(&amp;set), åˆ™ set ç”¨ä½è¡¨ç¤ºæ˜¯ <code>0000,0000</code></li>
<li>è‹¥ fdï¼5, æ‰§è¡Œ FD_SET(fd, &amp;set); å set å˜ä¸º 0001,0000(ç¬¬ 5 ä½ç½®ä¸º 1)</li>
<li>å†åŠ å…¥ fdï¼2, fd=1ï¼Œåˆ™ set å˜ä¸º <code>0001,0011</code></li>
<li>æ‰§è¡Œ select(6, &amp;set, 0, 0, 0) é˜»å¡ç­‰å¾…ï¼ˆè¿™é‡Œmaxæ˜¯5+1ï¼Œè¿™æ˜¯å› ä¸ºsetæœ€å¤§åªèƒ½æ˜¯5ï¼Œå†…æ ¸æ²¡å¿…è¦æŠŠæ‰€æœ‰setä½éƒ½å–å‡ºæ¥ï¼Œåªéœ€è¦æœ€å¤§åˆ°6çš„ä½ç½®ï¼‰</li>
<li>è‹¥ fd=1, fd=2 ä¸Šéƒ½å‘ç”Ÿå¯è¯»äº‹ä»¶ï¼Œåˆ™ select è¿”å›ï¼Œæ­¤æ—¶ set å˜ä¸º <code>0000,0011</code> (æ³¨æ„ï¼šæ²¡æœ‰äº‹ä»¶å‘ç”Ÿçš„ fd=5 è¢«æ¸…ç©º)</li>
</ol>
</blockquote>
<p><strong>æ ¹æ®ä¸Šé¢ä¾‹å­æˆ‘ä»¬å¯ä»¥å¾—å‡º<code>select</code>çš„ç‰¹ç‚¹ï¼š</strong></p>
<hr>
<blockquote>
<ul>
<li>å¯ç›‘æ§çš„æ–‡ä»¶æè¿°ç¬¦ä¸ªæ•°å–å†³äº sizeof(fd_set) çš„å€¼ã€‚å‡è®¾æœåŠ¡å™¨ä¸Š sizeof(fd_set)ï¼512ï¼Œæ¯ bit è¡¨ç¤ºä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œåˆ™æœåŠ¡å™¨ä¸Šæ”¯æŒçš„æœ€å¤§æ–‡ä»¶æè¿°ç¬¦æ˜¯ 512*8=4096ã€‚</li>
<li>å°† fd åŠ å…¥ select ç›‘æ§é›†çš„åŒæ—¶ï¼Œè¿˜è¦å†ä½¿ç”¨ä¸€ä¸ªæ•°æ®ç»“æ„ array ä¿å­˜æ”¾åˆ° select ç›‘æ§é›†ä¸­çš„ fdï¼Œä¸€æ˜¯ç”¨äºåœ¨ select è¿”å›åï¼Œarray ä½œä¸ºæºæ•°æ®å’Œ fd_set è¿›è¡Œ FD_ISSET åˆ¤æ–­ã€‚äºŒæ˜¯ select è¿”å›åä¼šæŠŠä»¥å‰åŠ å…¥çš„ä½†å¹¶æ— äº‹ä»¶å‘ç”Ÿçš„ fd æ¸…ç©ºï¼Œåˆ™æ¯æ¬¡å¼€å§‹ select å‰éƒ½è¦é‡æ–°ä» array å–å¾— fd é€ä¸€åŠ å…¥ï¼ˆFD_ZERO æœ€å…ˆï¼‰ï¼Œæ‰«æ array çš„åŒæ—¶å–å¾— fd æœ€å¤§å€¼ maxfdï¼Œç”¨äº select çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œå¯è§ select æ¨¡å‹å¿…é¡»åœ¨ select å‰å¾ªç¯ arrayï¼ˆåŠ  fdï¼Œå– maxfdï¼‰ï¼Œselect è¿”å›åå¾ªç¯ arrayï¼ˆFD_ISSET åˆ¤æ–­æ˜¯å¦æœ‰äº‹ä»¶å‘ç”Ÿï¼‰</li>
<li>selectä¼šå°†rsetå…¨é‡æ‹·è´åˆ°å†…æ ¸æ€ï¼Œç”±å†…æ ¸æ€åˆ¤è¯»rsetæ˜¯å¦æœ‰æ•°æ®ï¼Œè¿™æ˜¯å› ä¸ºå¦‚æœç”±ç”¨æˆ·æ€åˆ¤æ–­ï¼Œä¹Ÿæ˜¯äº¤ç»™å†…æ ¸æ€çœŸæ­£æ‰§è¡Œï¼Œæ¯ä¸€ä¸ªä½çš„åˆ¤æ–­éƒ½éœ€è¦ç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„åˆ‡æ¢ï¼Œæ‰€ä»¥selectç›´æ¥å°†rsetæ‹·è´åˆ°å†…æ ¸æ€</li>
</ul>
</blockquote>
<hr>
<p><strong>æ‰€ä»¥ï¼Œselect æœ‰å¦‚ä¸‹çš„ç¼ºç‚¹ï¼š</strong></p>
<hr>
<blockquote>
<ul>
<li>ç›‘å¬èƒ½åŠ›æœ‰é™ï¼šä½¿ç”¨ 32 ä¸ªæ•´æ•°çš„ 32 ä½ï¼Œå³ 32*32=1024 æ¥æ ‡è¯† fdï¼Œæœ€å¤šåªèƒ½ç›‘å¬ 1024 ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼ˆå¯è°ƒæ•´ï¼‰</li>
<li>å†…å­˜æ‹·è´å¼€é”€å¤§ï¼šæ¯æ¬¡è°ƒç”¨ selectï¼Œéƒ½éœ€è¦æŠŠ fd é›†åˆä»ç”¨æˆ·æ€æ‹·è´åˆ°å†…æ ¸æ€ï¼Œè¿™ä¸ªå¼€é”€åœ¨ fd å¾ˆå¤šæ—¶ä¼šå¾ˆå¤§</li>
<li>æ—¶é—´å¤æ‚åº¦ ğ‘‚(ğ‘›)ï¼šæ¯æ¬¡ kernel éƒ½éœ€è¦çº¿æ€§æ‰«ææ•´ä¸ª fd_setï¼Œæ‰€ä»¥éšç€ç›‘æ§çš„æè¿°ç¬¦ fd æ•°é‡å¢é•¿ï¼Œå…¶ I/O æ€§èƒ½ä¼šçº¿æ€§ä¸‹é™ï¼Œè€Œä¸”ï¼Œrsetä¸å¯é‡ç”¨ï¼Œæ¯æ¬¡å¾ªç¯éƒ½è¦å¯¹rsetç½®ç©ºå†èµ‹å€¼ï¼Œæ€§èƒ½æœ‰æŸè€—</li>
</ul>
</blockquote>
<hr>
<p>å¯¹æ¯”<code>select</code>ï¼Œpoll çš„å®ç°å’Œ select éå¸¸ç›¸ä¼¼ï¼Œåªæ˜¯æè¿° fd é›†åˆçš„æ–¹å¼ä¸åŒï¼Œpoll ä½¿ç”¨ pollfd ç»“æ„è€Œä¸æ˜¯ select çš„ fd_set ç»“æ„ï¼Œ <code>poll</code> å‡½æ•°ä½¿ç”¨é“¾è¡¨å­˜å‚¨æ–‡ä»¶æè¿°ç¬¦ï¼Œæ‘†è„±äº† 1024 çš„æ•°é‡ä¸Šé™ã€‚ä½†æ˜¯åŒæ ·éœ€è¦ä»ç”¨æˆ·æ€æ‹·è´æ‰€æœ‰çš„ fd åˆ°å†…æ ¸æ€ï¼Œä¹Ÿéœ€è¦çº¿æ€§éå†æ‰€æœ‰çš„ fd é›†åˆ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// fdsæ˜¯ä¸€ä¸ªpollå‡½æ•°ç›‘å¬çš„ç»“æ„åˆ—è¡¨ï¼Œnfdsè¡¨ç¤ºfdsæ•°ç»„çš„é•¿åº¦</span></span><br><span class="line"><span class="comment">// è¿”å›å€¼ï¼šå°äº0ï¼Œè¡¨ç¤ºå‡ºé”™ï¼Œç­‰äº0ï¼Œè¡¨ç¤ºpollå‡½æ•°ç­‰å¾…è¶…æ—¶ï¼Œå¤§äº0ï¼Œè¡¨ç¤ºstruct pollfdç»“æ„ä½“æ•°ç»„ä¸­æœ‰å¤šå°‘ä¸ªé0çš„reventsï¼Œä¹Ÿå°±æ˜¯è¿™ä¸€æ¬¡è°ƒç”¨polläº§ç”Ÿäº‹ä»¶çš„æè¿°ç¬¦çš„æ•°é‡ã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">poll</span> <span class="params">(struct pollfd *fds, <span class="keyword">unsigned</span> <span class="keyword">int</span> nfds, <span class="keyword">int</span> timeout)</span></span>;</span><br></pre></td></tr></table></figure>

<p>ä¸<code>select</code>ä¸åŒï¼Œpollä¼ å…¥çš„æ˜¯pollfdç»“æ„ä½“æ•°ç»„ï¼Œæ‰€ä»¥æ²¡æœ‰1024ä¸ªæè¿°ç¬¦çš„é™åˆ¶</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> &#123;</span></span><br><span class="line">      <span class="keyword">int</span> fd; <span class="comment">// æ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line">      <span class="keyword">short</span> events; <span class="comment">// å…³å¿ƒçš„äº‹ä»¶ç±»å‹</span></span><br><span class="line">      <span class="keyword">short</span> revents; <span class="comment">// å®é™…å‘ç”Ÿäº†çš„äº‹ä»¶ç±»å‹</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>äº‹ä»¶ç±»å‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> POLLIN         0x001        <span class="comment">// æœ‰æ•°æ®å¯è¯»</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> POLLPRI        0x002        <span class="comment">// æœ‰ç´§è¿«æ•°æ®å¯è¯»</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> POLLOUT        0x004        <span class="comment">// ç°åœ¨å†™æ•°æ®ä¸ä¼šå¯¼è‡´é˜»å¡</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> POLLRDNORM    0x040        <span class="comment">// æœ‰æ™®é€šæ•°æ®å¯è¯»</span></span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> POLLRDBAND    0x080        <span class="comment">// æœ‰ä¼˜å…ˆæ•°æ®å¯è¯»</span></span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> POLLWRNORM    0x100        <span class="comment">// å†™æ™®é€šæ•°æ®ä¸ä¼šå¯¼è‡´é˜»å¡</span></span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> POLLWRBAND    0x200        <span class="comment">// å†™ä¼˜å…ˆæ•°æ®ä¸ä¼šå¯¼è‡´é˜»å¡</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> POLLERR        0x008        <span class="comment">// å‘ç”Ÿé”™è¯¯</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> POLLHUP        0x010        <span class="comment">// æŒ‚èµ·</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> POLLNVAL       0x020        <span class="comment">// æ— æ•ˆæ–‡ä»¶æè¿°ç¬¦</span></span></span><br></pre></td></tr></table></figure>

<p>å½“ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦è¦åŒæ—¶ç›‘å¬è¯»å†™äº‹ä»¶æ—¶ï¼Œå¯ä»¥å†™æˆ events = POLLIN | POLLOUT</p>
<p>ä¸‹é¢æ˜¯<code>poll</code>çš„ä¾‹å­ï¼Œä¸<code>select</code>ç”¨æ³•ç›¸ä¼¼ï¼Œä»ç„¶éœ€è¦ä»ç”¨æˆ·æ€æ‹·è´æ‰€æœ‰çš„ <code>fd</code> åˆ°å†…æ ¸æ€ï¼Œä¹Ÿéœ€è¦çº¿æ€§éå†æ‰€æœ‰çš„ <code>fd</code> é›†åˆ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// 5ä¸ªæ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line"> <span class="keyword">for</span> (i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++) </span><br><span class="line"> &#123;</span><br><span class="line">   <span class="built_in">memset</span>(&amp;client, <span class="number">0</span>, <span class="keyword">sizeof</span> (client));</span><br><span class="line">   addrlen = <span class="keyword">sizeof</span>(client);</span><br><span class="line">   <span class="comment">// å£°æ˜æ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line">   pollfds[i].fd = accept(sockfd,(struct sockaddr*)&amp;client, &amp;addrlen);</span><br><span class="line">   <span class="comment">// eventsæ˜¯è¯»äº‹ä»¶</span></span><br><span class="line">   pollfds[i].events = POLLIN;</span><br><span class="line"> &#125;</span><br><span class="line"> sleep(<span class="number">1</span>);</span><br><span class="line"> <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line"> <span class="built_in">puts</span>(<span class="string">"round again"</span>);</span><br><span class="line"> <span class="comment">// ä¼ å…¥pollfdæ•°ç»„ï¼Œå¹¶ä¸”æ•°ç»„ä¸­æœ‰5ä¸ªå…ƒç´ ï¼Œ50000æ˜¯è¶…æ—¶</span></span><br><span class="line">poll(pollfds, <span class="number">5</span>, <span class="number">50000</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++) &#123;</span><br><span class="line">   <span class="comment">// åˆ¤æ–­reventsæ˜¯å¦è¢«ç½®ä½ä¸ºPOLLIN</span></span><br><span class="line">	<span class="keyword">if</span> (pollfds[i].revents &amp; POLLIN)&#123;</span><br><span class="line">     <span class="comment">// æ¢å¤ä¸º0</span></span><br><span class="line">		pollfds[i].revents = <span class="number">0</span>;</span><br><span class="line">		<span class="built_in">memset</span>(buffer,<span class="number">0</span>,MAXBUF);</span><br><span class="line">		read(pollfds[i].fd, buffer, MAXBUF);</span><br><span class="line">		<span class="built_in">puts</span>(buffer);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>ä¸<code>select</code>ä¸åŒçš„æ˜¯ï¼Œ<code>poll</code>ä¸æ˜¯å¯¹bitmapç½®ä½ï¼Œè€Œä¸”æ”¹å˜<code>revents</code>å­—æ®µï¼ˆ<code>select</code>å¯¹bitmapç½®ä½å¯¼è‡´rsetä¸å¯é‡ç”¨ï¼‰ï¼Œè¿™é‡Œä¼šå¯¹<code>revents</code>å­—æ®µèµ‹å€¼ä¸º<code>POLLIN</code>ï¼Œå³è¯»äº‹ä»¶ï¼Œ<code>poll</code>è¿”å›åéœ€è¦å¯¹<code>revents</code>å­—æ®µæ¢å¤ä¸º0ã€‚<code>poll</code>è§£å†³äº†<code>select</code>ç›‘å¬èƒ½åŠ›å—é™çš„é—®é¢˜ï¼Œä¹Ÿè§£å†³äº†bitmapé‡ç”¨çš„é—®é¢˜ï¼Œä½†æ˜¯ä»ç„¶éœ€è¦å†…å­˜æ‹·è´ä»¥åŠæ—¶é—´å¤æ‚åº¦ğ‘‚(ğ‘›)çš„é—®é¢˜ã€‚</p>
<h2 id="epoll"><a href="#epoll" class="headerlink" title="epoll"></a>epoll</h2><p>I/O å¤šè·¯å¤ç”¨çš„æ ¸å¿ƒè®¾è®¡æ˜¯ 1 ä¸ªçº¿ç¨‹å¤„ç†æ‰€æœ‰è¿æ¥çš„ <code>ç­‰å¾…æ¶ˆæ¯å‡†å¤‡å¥½</code> I/O äº‹ä»¶ï¼Œè¿™ä¸€ç‚¹ä¸Š <code>epoll</code> å’Œ <code>select</code>&amp;<code>poll</code> æ˜¯å¤§åŒå°å¼‚çš„ã€‚ä½† <code>select</code>&amp;<code>poll</code>åœ¨åä¸‡å¹¶å‘è¿æ¥å­˜åœ¨æ—¶ï¼Œå¯èƒ½æ¯ä¸€æ¯«ç§’åªæœ‰æ•°ç™¾ä¸ªæ´»è·ƒçš„è¿æ¥ï¼ŒåŒæ—¶å…¶ä½™æ•°åä¸‡è¿æ¥åœ¨è¿™ä¸€æ¯«ç§’æ˜¯éæ´»è·ƒçš„ã€‚<code>select&amp;</code>&amp;<code>poll</code> çš„ä½¿ç”¨æ–¹æ³•æ˜¯è¿™æ ·çš„ï¼š <code>è¿”å›çš„æ´»è·ƒè¿æ¥ == select(å…¨éƒ¨å¾…ç›‘æ§çš„è¿æ¥)</code> ã€‚ä»€ä¹ˆæ—¶å€™ä¼šè°ƒç”¨ <code>select</code>&amp;<code>poll</code> å‘¢ï¼Ÿåœ¨ä½ è®¤ä¸ºéœ€è¦æ‰¾å‡ºæœ‰æŠ¥æ–‡åˆ°è¾¾çš„æ´»è·ƒè¿æ¥æ—¶ï¼Œå°±åº”è¯¥è°ƒç”¨ã€‚æ‰€ä»¥ï¼Œ<code>select</code>&amp;<code>poll</code> åœ¨é«˜å¹¶å‘æ—¶æ˜¯ä¼šè¢«é¢‘ç¹è°ƒç”¨çš„ã€‚è¿™æ ·ï¼Œè¿™ä¸ªé¢‘ç¹è°ƒç”¨çš„æ–¹æ³•å°±å¾ˆæœ‰å¿…è¦çœ‹çœ‹å®ƒæ˜¯å¦æœ‰æ•ˆç‡ï¼Œå› ä¸ºï¼Œå®ƒçš„è½»å¾®æ•ˆç‡æŸå¤±éƒ½ä¼šè¢« <code>é«˜é¢‘</code> äºŒå­—æ‰€æ”¾å¤§ã€‚å®ƒæœ‰æ•ˆç‡æŸå¤±å—ï¼Ÿæ˜¾è€Œæ˜“è§ï¼Œå…¨éƒ¨å¾…ç›‘æ§è¿æ¥æ˜¯æ•°ä»¥åä¸‡è®¡çš„ï¼Œè¿”å›çš„åªæ˜¯æ•°ç™¾ä¸ªæ´»è·ƒè¿æ¥ï¼Œè¿™æœ¬èº«å°±æ˜¯æ— æ•ˆç‡çš„è¡¨ç°ã€‚è¢«æ”¾å¤§åå°±ä¼šå‘ç°ï¼Œå¤„ç†å¹¶å‘ä¸Šä¸‡ä¸ªè¿æ¥æ—¶ï¼Œ<code>select</code>&amp;<code>poll</code> å°±å®Œå…¨åŠ›ä¸ä»å¿ƒäº†ã€‚è¿™ä¸ªæ—¶å€™å°±è¯¥ <code>epoll</code> ä¸Šåœºäº†ï¼Œ<code>epoll</code> é€šè¿‡ä¸€äº›æ–°çš„è®¾è®¡å’Œä¼˜åŒ–ï¼ŒåŸºæœ¬ä¸Šè§£å†³äº† <code>select</code>&amp;<code>poll</code> çš„é—®é¢˜ã€‚</p>
<p>epoll çš„ API éå¸¸ç®€æ´ï¼Œæ¶‰åŠåˆ°çš„åªæœ‰ 3 ä¸ªç³»ç»Ÿè°ƒç”¨ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/epoll.h&gt;  </span></span></span><br><span class="line"><span class="comment">// sizeè¡¨æ˜å†…æ ¸è¦ç›‘å¬çš„æè¿°ç¬¦æ•°é‡</span></span><br><span class="line"><span class="comment">// è¿”å›ä¸€ä¸ªepollå¥æŸ„æè¿°ç¬¦ï¼Œå¤±è´¥æ—¶è¿”å›-1</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">epoll_create</span><span class="params">(<span class="keyword">int</span> size)</span></span>; <span class="comment">// int epoll_create1(int flags);</span></span><br><span class="line"><span class="comment">// epfd è¡¨ç¤ºepollå¥æŸ„</span></span><br><span class="line"><span class="comment">// op è¡¨ç¤ºfdæ“ä½œç±»å‹ï¼Œæœ‰å¦‚ä¸‹3ç§ï¼š</span></span><br><span class="line"><span class="comment">// 1.EPOLL_CTL_ADD æ³¨å†Œæ–°çš„fdåˆ°epfdä¸­</span></span><br><span class="line"><span class="comment">// 2.EPOLL_CTL_MOD ä¿®æ”¹å·²æ³¨å†Œçš„fdçš„ç›‘å¬äº‹ä»¶</span></span><br><span class="line"><span class="comment">// 3.EPOLL_CTL_DEL ä»epfdä¸­åˆ é™¤ä¸€ä¸ªfd</span></span><br><span class="line"><span class="comment">// fd æ˜¯è¦ç›‘å¬çš„æè¿°ç¬¦</span></span><br><span class="line"><span class="comment">// event è¡¨ç¤ºè¦ç›‘å¬çš„äº‹ä»¶</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">epoll_ctl</span><span class="params">(<span class="keyword">int</span> epfd, <span class="keyword">int</span> op, <span class="keyword">int</span> fd, struct epoll_event *event)</span></span>;</span><br><span class="line"><span class="comment">// epfd æ˜¯epollå¥æŸ„</span></span><br><span class="line"><span class="comment">// events è¡¨ç¤ºä»å†…æ ¸å¾—åˆ°çš„å°±ç»ªäº‹ä»¶é›†åˆ</span></span><br><span class="line"><span class="comment">// maxevents å‘Šè¯‰å†…æ ¸eventsçš„å¤§å°</span></span><br><span class="line"><span class="comment">// timeout è¡¨ç¤ºç­‰å¾…çš„è¶…æ—¶äº‹ä»¶</span></span><br><span class="line"><span class="comment">// è¿”å›å€¼ï¼šè¿”å›å°±ç»ªçš„äº‹ä»¶æ•°ç›®ï¼Œè°ƒç”¨å¤±è´¥æ—¶è¿”å› -1ï¼Œç­‰å¾…è¶…æ—¶è¿”å› 0ã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">epoll_wait</span><span class="params">(<span class="keyword">int</span> epfd, struct epoll_event *events, <span class="keyword">int</span> maxevents, <span class="keyword">int</span> timeout)</span></span>;</span><br></pre></td></tr></table></figure>

<p><code>epoll_create</code> åˆ›å»ºä¸€ä¸ª <code>epoll</code> å®ä¾‹å¹¶è¿”å› <code>epollfd</code>ï¼Œ<code>epoll_ctl</code> æ³¨å†Œ file descriptor ç­‰å¾…çš„ I/O äº‹ä»¶(æ¯”å¦‚ EPOLLINã€EPOLLOUT ç­‰) åˆ° <code>epoll</code> å®ä¾‹ä¸Šï¼Œ<code>epoll_wait</code> åˆ™æ˜¯é˜»å¡ç›‘å¬ <code>epoll</code> å®ä¾‹ä¸Šæ‰€æœ‰çš„ file descriptor çš„ I/O äº‹ä»¶ï¼Œå®ƒæ¥æ”¶ä¸€ä¸ªç”¨æˆ·ç©ºé—´ä¸Šçš„ä¸€å—å†…å­˜åœ°å€ (events æ•°ç»„)ï¼Œkernel ä¼šåœ¨æœ‰ I/O äº‹ä»¶å‘ç”Ÿçš„æ—¶å€™æŠŠæ–‡ä»¶æè¿°ç¬¦åˆ—è¡¨å¤åˆ¶åˆ°è¿™å—å†…å­˜åœ°å€ä¸Šï¼Œç„¶å <code>epoll_wait</code> è§£é™¤é˜»å¡å¹¶è¿”å›ï¼Œæœ€åç”¨æˆ·ç©ºé—´ä¸Šçš„ç¨‹åºå°±å¯ä»¥å¯¹ç›¸åº”çš„ <code>fd</code> è¿›è¡Œè¯»å†™äº†ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="keyword">ssize_t</span> read(<span class="keyword">int</span> fd, <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> count);</span><br><span class="line"><span class="keyword">ssize_t</span> write(<span class="keyword">int</span> fd, <span class="keyword">const</span> <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> count);</span><br></pre></td></tr></table></figure>

<p><code>epoll</code>èƒ½æ˜¾è‘—æé«˜ç¨‹åºåœ¨å¤§é‡å¹¶å‘è¿æ¥ä¸­åªæœ‰å°‘é‡æ´»è·ƒçš„æƒ…å†µä¸‹çš„ç³»ç»ŸCPUåˆ©ç”¨ç‡ã€‚åŸå› å°±æ˜¯è·å–äº‹ä»¶çš„æ—¶å€™ï¼Œå®ƒ<code>æ— é¡»éå†æ•´ä¸ªè¢«ä¾¦å¬çš„æè¿°ç¬¦é›†</code>ï¼Œåªè¦éå†é‚£äº›è¢«å†…æ ¸IOäº‹ä»¶å¼‚æ­¥å”¤é†’è€ŒåŠ å…¥Readyé˜Ÿåˆ—çš„æè¿°ç¬¦é›†åˆå°±è¡Œäº†ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span> <span class="title">events</span>[5];</span></span><br><span class="line">  <span class="keyword">int</span> epfd = epoll_create(<span class="number">10</span>);</span><br><span class="line">  ...</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">for</span> (i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++) </span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span> <span class="title">ev</span>;</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;client, <span class="number">0</span>, <span class="keyword">sizeof</span> (client));</span><br><span class="line">    addrlen = <span class="keyword">sizeof</span>(client);</span><br><span class="line">    ev.data.fd = accept(sockfd,(struct sockaddr*)&amp;client, &amp;addrlen);</span><br><span class="line">    ev.events = EPOLLIN;</span><br><span class="line">    epoll_ctl(epfd, EPOLL_CTL_ADD, ev.data.fd, &amp;ev); </span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">  	<span class="built_in">puts</span>(<span class="string">"round again"</span>);</span><br><span class="line">  	nfds = epoll_wait(epfd, events, <span class="number">5</span>, <span class="number">10000</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;nfds;i++) &#123;</span><br><span class="line">			<span class="built_in">memset</span>(buffer,<span class="number">0</span>,MAXBUF);</span><br><span class="line">      <span class="comment">// ä»eventsæ•°ç»„ä¸­è·å–å¯¹åº”fdå³å¯ï¼Œæ— éœ€éå†æ‰€æœ‰æè¿°ç¬¦é›†</span></span><br><span class="line">			read(events[i].data.fd, buffer, MAXBUF);</span><br><span class="line">			<span class="built_in">puts</span>(buffer);</span><br><span class="line">	&#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p><code>epoll</code> çš„å·¥ä½œåŸç†å¦‚ä¸‹ï¼š</p>
<p><img src="/images/io-2.png" alt="io"></p>
<p>ä¸ <code>select</code>&amp;<code>poll</code> ç›¸æ¯”ï¼Œ<code>epoll</code> åˆ†æ¸…äº†é«˜é¢‘è°ƒç”¨å’Œä½é¢‘è°ƒç”¨ã€‚ä¾‹å¦‚ï¼Œ<code>epoll_ctl</code> ç›¸å¯¹æ¥è¯´å°±æ˜¯éé¢‘ç¹è°ƒç”¨çš„ï¼Œè€Œ <code>epoll_wait</code> åˆ™æ˜¯ä¼šè¢«é«˜é¢‘è°ƒç”¨çš„ã€‚æ‰€ä»¥ <code>epoll</code> åˆ©ç”¨ <code>epoll_ctl</code> æ¥æ’å…¥æˆ–è€…åˆ é™¤ä¸€ä¸ª fdï¼Œå®ç°ç”¨æˆ·æ€åˆ°å†…æ ¸æ€çš„æ•°æ®æ‹·è´ï¼Œè¿™ç¡®ä¿äº†æ¯ä¸€ä¸ª fd åœ¨å…¶ç”Ÿå‘½å‘¨æœŸåªéœ€è¦è¢«æ‹·è´ä¸€æ¬¡ï¼Œè€Œä¸æ˜¯æ¯æ¬¡è°ƒç”¨ <code>epoll_wait</code> çš„æ—¶å€™éƒ½æ‹·è´ä¸€æ¬¡ã€‚ <code>epoll_wait</code> åˆ™è¢«è®¾è®¡æˆå‡ ä¹æ²¡æœ‰å…¥å‚çš„è°ƒç”¨ï¼Œç›¸æ¯”  <code>select</code>&amp;<code>poll</code>éœ€è¦æŠŠå…¨éƒ¨ç›‘å¬çš„ fd é›†åˆä»ç”¨æˆ·æ€æ‹·è´è‡³å†…æ ¸æ€çš„åšæ³•ï¼Œ<code>epoll</code> çš„æ•ˆç‡å°±é«˜å‡ºäº†ä¸€å¤§æˆªã€‚</p>
<p>åœ¨å®ç°ä¸Š <code>epoll</code> é‡‡ç”¨<code>çº¢é»‘æ ‘</code>æ¥å­˜å‚¨æ‰€æœ‰ç›‘å¬çš„ fdï¼Œ<strong>è€Œçº¢é»‘æ ‘æœ¬èº«æ’å…¥å’Œåˆ é™¤æ€§èƒ½æ¯”è¾ƒç¨³å®šï¼Œæ—¶é—´å¤æ‚åº¦ O(logN)</strong>ã€‚é€šè¿‡ <code>epoll_ctl</code> å‡½æ•°æ·»åŠ è¿›æ¥çš„ fd éƒ½ä¼šè¢«æ”¾åœ¨çº¢é»‘æ ‘çš„æŸä¸ªèŠ‚ç‚¹å†…ï¼Œæ‰€ä»¥ï¼Œé‡å¤æ·»åŠ æ˜¯æ²¡æœ‰ç”¨çš„ã€‚å½“æŠŠ fd æ·»åŠ è¿›æ¥çš„æ—¶å€™æ—¶å€™ä¼šå®Œæˆå…³é”®çš„ä¸€æ­¥ï¼šè¯¥ fd ä¼šä¸ç›¸åº”çš„è®¾å¤‡ï¼ˆç½‘å¡ï¼‰é©±åŠ¨ç¨‹åºå»ºç«‹å›è°ƒå…³ç³»ï¼Œä¹Ÿå°±æ˜¯åœ¨å†…æ ¸ä¸­æ–­å¤„ç†ç¨‹åºä¸ºå®ƒæ³¨å†Œä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œåœ¨ fd ç›¸åº”çš„äº‹ä»¶è§¦å‘ï¼ˆä¸­æ–­ï¼‰ä¹‹åï¼ˆè®¾å¤‡å°±ç»ªäº†ï¼‰ï¼Œå†…æ ¸å°±ä¼šè°ƒç”¨è¿™ä¸ªå›è°ƒå‡½æ•°ï¼Œè¯¥å›è°ƒå‡½æ•°åœ¨å†…æ ¸ä¸­è¢«ç§°ä¸ºï¼š <code>ep_poll_callback</code> ï¼Œ<strong>è¿™ä¸ªå›è°ƒå‡½æ•°å…¶å®å°±æ˜¯æŠŠè¿™ä¸ª fd æ·»åŠ åˆ° rdllist è¿™ä¸ªåŒå‘é“¾è¡¨ï¼ˆå°±ç»ªé“¾è¡¨ï¼‰ä¸­</strong>ã€‚<code>epoll_wait</code> å®é™…ä¸Šå°±æ˜¯å»æ£€æŸ¥ rdllist åŒå‘é“¾è¡¨ä¸­æ˜¯å¦æœ‰å°±ç»ªçš„ fdï¼Œå½“ rdllist ä¸ºç©ºï¼ˆæ— å°±ç»ª fdï¼‰æ—¶æŒ‚èµ·å½“å‰è¿›ç¨‹ï¼Œç›´åˆ° rdllist éç©ºæ—¶è¿›ç¨‹æ‰è¢«å”¤é†’å¹¶è¿”å›ã€‚</p>
<p>ç›¸æ¯”äº  <code>select</code>&amp;<code>poll</code> è°ƒç”¨æ—¶ä¼šå°†å…¨éƒ¨ç›‘å¬çš„ fd ä»ç”¨æˆ·æ€ç©ºé—´æ‹·è´è‡³å†…æ ¸æ€ç©ºé—´å¹¶çº¿æ€§æ‰«æä¸€éæ‰¾å‡ºå°±ç»ªçš„ fd å†è¿”å›åˆ°ç”¨æˆ·æ€ï¼Œ<code>epoll_wait</code> åˆ™æ˜¯ç›´æ¥è¿”å›å·²å°±ç»ª fdï¼Œå› æ­¤ <code>epoll</code> çš„ I/O æ€§èƒ½ä¸ä¼šåƒ  <code>select</code>&amp;<code>poll</code> é‚£æ ·éšç€ç›‘å¬çš„ fd æ•°é‡å¢åŠ è€Œå‡ºç°çº¿æ€§è¡°å‡ï¼Œæ˜¯ä¸€ä¸ªéå¸¸é«˜æ•ˆçš„ I/O äº‹ä»¶é©±åŠ¨æŠ€æœ¯ã€‚</p>
<p><strong>ç”±äºä½¿ç”¨ <code>epoll</code> çš„ I/O å¤šè·¯å¤ç”¨éœ€è¦ç”¨æˆ·è¿›ç¨‹è‡ªå·±è´Ÿè´£ I/O è¯»å†™ï¼Œä»ç”¨æˆ·è¿›ç¨‹çš„è§’åº¦çœ‹ï¼Œè¯»å†™è¿‡ç¨‹æ˜¯é˜»å¡çš„ï¼Œæ‰€ä»¥ <code>select</code>&amp;<code>poll</code>&amp;<code>epoll</code> æœ¬è´¨ä¸Šéƒ½æ˜¯åŒæ­¥ I/O æ¨¡å‹ï¼Œè€Œåƒ Windows çš„ IOCP è¿™ä¸€ç±»çš„å¼‚æ­¥ I/Oï¼Œåªéœ€è¦åœ¨è°ƒç”¨ WSARecv æˆ– WSASend æ–¹æ³•è¯»å†™æ•°æ®çš„æ—¶å€™æŠŠç”¨æˆ·ç©ºé—´çš„å†…å­˜ buffer æäº¤ç»™ kernelï¼Œkernel è´Ÿè´£æ•°æ®åœ¨ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´æ‹·è´ï¼Œå®Œæˆä¹‹åå°±ä¼šé€šçŸ¥ç”¨æˆ·è¿›ç¨‹ï¼Œæ•´ä¸ªè¿‡ç¨‹ä¸éœ€è¦ç”¨æˆ·è¿›ç¨‹å‚ä¸ï¼Œæ‰€ä»¥æ˜¯çœŸæ­£çš„å¼‚æ­¥ I/Oã€‚</strong></p>
<p><code>epoll</code> çš„å·¥ä½œæ¨¡å¼:</p>
<p>epollå¯¹æ–‡ä»¶æè¿°ç¬¦çš„æ“ä½œæœ‰ä¸¤ç§æ¨¡å¼ï¼š<strong>LTï¼ˆlevel triggerï¼‰</strong>å’Œ<strong>ETï¼ˆedge triggerï¼‰</strong>ã€‚LTæ¨¡å¼æ˜¯é»˜è®¤æ¨¡å¼ï¼ŒLTæ¨¡å¼ä¸ETæ¨¡å¼çš„åŒºåˆ«å¦‚ä¸‹ï¼š<br>ã€€ã€€<strong>LTæ¨¡å¼</strong>ï¼šå½“epoll_waitæ£€æµ‹åˆ°æè¿°ç¬¦äº‹ä»¶å‘ç”Ÿå¹¶å°†æ­¤äº‹ä»¶é€šçŸ¥åº”ç”¨ç¨‹åºï¼Œ<code>åº”ç”¨ç¨‹åºå¯ä»¥ä¸ç«‹å³å¤„ç†è¯¥äº‹ä»¶</code>ã€‚ä¸‹æ¬¡è°ƒç”¨epoll_waitæ—¶ï¼Œä¼šå†æ¬¡å“åº”åº”ç”¨ç¨‹åºå¹¶é€šçŸ¥æ­¤äº‹ä»¶ã€‚<br>ã€€ã€€<strong>ETæ¨¡å¼</strong>ï¼šå½“epoll_waitæ£€æµ‹åˆ°æè¿°ç¬¦äº‹ä»¶å‘ç”Ÿå¹¶å°†æ­¤äº‹ä»¶é€šçŸ¥åº”ç”¨ç¨‹åºï¼Œ<code>åº”ç”¨ç¨‹åºå¿…é¡»ç«‹å³å¤„ç†è¯¥äº‹ä»¶</code>ã€‚å¦‚æœä¸å¤„ç†ï¼Œä¸‹æ¬¡è°ƒç”¨epoll_waitæ—¶ï¼Œä¸ä¼šå†æ¬¡å“åº”åº”ç”¨ç¨‹åºå¹¶é€šçŸ¥æ­¤äº‹ä»¶ã€‚</p>
<h2 id="go-netPoller"><a href="#go-netPoller" class="headerlink" title="go netPoller"></a>go netPoller</h2><p><strong>Go netpoller åŸºæœ¬åŸç†</strong></p>
<blockquote>
<p>Go netpoller é€šè¿‡åœ¨åº•å±‚å¯¹ epoll/kqueue/iocp çš„å°è£…ï¼Œä»è€Œå®ç°äº†ä½¿ç”¨åŒæ­¥ç¼–ç¨‹æ¨¡å¼è¾¾åˆ°å¼‚æ­¥æ‰§è¡Œçš„æ•ˆæœã€‚æ€»ç»“æ¥è¯´ï¼Œæ‰€æœ‰çš„ç½‘ç»œæ“ä½œéƒ½ä»¥ç½‘ç»œæè¿°ç¬¦ <code>netFD</code> ä¸ºä¸­å¿ƒå®ç°ã€‚netFD ä¸åº•å±‚ <code>PollDesc</code> ç»“æ„ç»‘å®šï¼Œå½“åœ¨ä¸€ä¸ª netFD ä¸Šè¯»å†™é‡åˆ° EAGAIN é”™è¯¯æ—¶ï¼Œå°±å°†å½“å‰ goroutine å­˜å‚¨åˆ°è¿™ä¸ª netFD å¯¹åº”çš„ PollDesc ä¸­ï¼ŒåŒæ—¶è°ƒç”¨ <code>gopark</code> æŠŠå½“å‰ goroutine ç»™ park ä½ï¼Œç›´åˆ°è¿™ä¸ª netFD ä¸Šå†æ¬¡å‘ç”Ÿè¯»å†™äº‹ä»¶ï¼Œæ‰å°†æ­¤ goroutine ç»™ ready æ¿€æ´»é‡æ–°è¿è¡Œã€‚æ˜¾ç„¶ï¼Œåœ¨åº•å±‚é€šçŸ¥ goroutine å†æ¬¡å‘ç”Ÿè¯»å†™ç­‰äº‹ä»¶çš„æ–¹å¼å°±æ˜¯ epoll/kqueue/iocp ç­‰äº‹ä»¶é©±åŠ¨æœºåˆ¶ã€‚</p>
</blockquote>
<p>ä¸ºäº†æé«˜ I/O å¤šè·¯å¤ç”¨çš„æ€§èƒ½ï¼Œä¸åŒçš„æ“ä½œç³»ç»Ÿä¹Ÿéƒ½å®ç°äº†è‡ªå·±çš„ I/O å¤šè·¯å¤ç”¨å‡½æ•°ï¼Œä¾‹å¦‚ï¼š<code>epoll</code>ã€<code>kqueue</code> å’Œ <code>evport</code> ç­‰ã€‚Go è¯­è¨€ä¸ºäº†æé«˜åœ¨ä¸åŒæ“ä½œç³»ç»Ÿä¸Šçš„ I/O æ“ä½œæ€§èƒ½ï¼Œä½¿ç”¨å¹³å°ç‰¹å®šçš„å‡½æ•°å®ç°äº†å¤šä¸ªç‰ˆæœ¬çš„ç½‘ç»œè½®è¯¢æ¨¡å—ï¼š</p>
<blockquote>
<ul>
<li><a href="https://github.com/golang/go/blob/master/src/runtime/netpoll_epoll.go" target="_blank" rel="noopener"><code>src/runtime/netpoll_epoll.go</code></a></li>
<li><a href="https://github.com/golang/go/blob/master/src/runtime/netpoll_kqueue.go" target="_blank" rel="noopener"><code>src/runtime/netpoll_kqueue.go</code></a></li>
<li><a href="https://github.com/golang/go/blob/master/src/runtime/netpoll_solaris.go" target="_blank" rel="noopener"><code>src/runtime/netpoll_solaris.go</code></a></li>
<li><a href="https://github.com/golang/go/blob/master/src/runtime/netpoll_windows.go" target="_blank" rel="noopener"><code>src/runtime/netpoll_windows.go</code></a></li>
<li><a href="https://github.com/golang/go/blob/master/src/runtime/netpoll_aix.go" target="_blank" rel="noopener"><code>src/runtime/netpoll_aix.go</code></a></li>
<li><a href="https://github.com/golang/go/blob/master/src/runtime/netpoll_fake.go" target="_blank" rel="noopener"><code>src/runtime/netpoll_fake.go</code></a></li>
</ul>
</blockquote>
<p>æˆ‘ä»¬åªé’ˆå¯¹<code>epoll</code>ç‰ˆæœ¬</p>
<h2 id="ç½‘ç»œè½®è¯¢å™¨æ¥å£"><a href="#ç½‘ç»œè½®è¯¢å™¨æ¥å£" class="headerlink" title="ç½‘ç»œè½®è¯¢å™¨æ¥å£"></a>ç½‘ç»œè½®è¯¢å™¨æ¥å£</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">netpollinit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="title">func</span> <span class="title">netpollopen</span><span class="params">(fd <span class="keyword">uintptr</span>, pd *pollDesc)</span> <span class="title">int32</span></span></span><br><span class="line"><span class="function"><span class="title">func</span> <span class="title">netpoll</span><span class="params">(delta <span class="keyword">int64</span>)</span> <span class="title">gList</span></span></span><br><span class="line"><span class="function"><span class="title">func</span> <span class="title">netpollBreak</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="title">func</span> <span class="title">netpollIsPollDescriptor</span><span class="params">(fd <span class="keyword">uintptr</span>)</span> <span class="title">bool</span></span></span><br></pre></td></tr></table></figure>

<p>ä¸Šè¿°å‡½æ•°åœ¨ç½‘ç»œè½®è¯¢å™¨ä¸­åˆ†åˆ«æ‰®æ¼”äº†ä¸åŒçš„ä½œç”¨ï¼š</p>
<ul>
<li><code>runtime.netpollinit</code> â€” åˆå§‹åŒ–ç½‘ç»œè½®è¯¢å™¨ï¼Œé€šè¿‡ <code>sync.Once</code> å’Œ <code>netpollInited</code> å˜é‡ä¿è¯å‡½æ•°åªä¼šè°ƒç”¨ä¸€æ¬¡</li>
<li><code>runtime.netpollopen</code> â€” ç›‘å¬æ–‡ä»¶æè¿°ç¬¦ä¸Šçš„è¾¹ç¼˜è§¦å‘äº‹ä»¶ï¼Œåˆ›å»ºäº‹ä»¶å¹¶åŠ å…¥ç›‘å¬</li>
<li><code>runtime.netpoll</code>â€” è½®è¯¢ç½‘ç»œå¹¶è¿”å›ä¸€ç»„å·²ç»å‡†å¤‡å°±ç»ªçš„ Goroutineï¼Œä¼ å…¥çš„å‚æ•°ä¼šå†³å®šå®ƒçš„è¡Œä¸ºï¼š<ul>
<li>å¦‚æœå‚æ•°å°äº 0ï¼Œæ— é™æœŸç­‰å¾…æ–‡ä»¶æè¿°ç¬¦å°±ç»ªï¼›</li>
<li>å¦‚æœå‚æ•°ç­‰äº 0ï¼Œéé˜»å¡åœ°è½®è¯¢ç½‘ç»œï¼›</li>
<li>å¦‚æœå‚æ•°å¤§äº 0ï¼Œé˜»å¡ç‰¹å®šæ—¶é—´è½®è¯¢ç½‘ç»œï¼›</li>
</ul>
</li>
<li><code>runtime.netpollBreak</code> â€” å”¤é†’ç½‘ç»œè½®è¯¢å™¨ï¼Œä¾‹å¦‚ï¼šè®¡æ—¶å™¨å‘å‰ä¿®æ”¹æ—¶é—´æ—¶ä¼šé€šè¿‡è¯¥å‡½æ•°ä¸­æ–­ç½‘ç»œè½®è¯¢å™¨</li>
<li><code>runtime.netpollIsPollDescriptor</code> â€” åˆ¤æ–­æ–‡ä»¶æè¿°ç¬¦æ˜¯å¦è¢«è½®è¯¢å™¨ä½¿ç”¨</li>
</ul>
<h2 id="æ•°æ®ç»“æ„"><a href="#æ•°æ®ç»“æ„" class="headerlink" title="æ•°æ®ç»“æ„"></a>æ•°æ®ç»“æ„</h2><p><strong>netFD</strong></p>
<p><code>net.Listen(&quot;tcp&quot;, &quot;:8888&quot;)</code> æ–¹æ³•è¿”å›äº†ä¸€ä¸ª *TCPListenerï¼Œå®ƒæ˜¯ä¸€ä¸ªå®ç°äº† <code>net.Listener</code> æ¥å£çš„ structï¼Œè€Œé€šè¿‡ <code>listener.Accept()</code> æ¥æ”¶çš„æ–°è¿æ¥ *TCPConn åˆ™æ˜¯ä¸€ä¸ªå®ç°äº† <code>net.Conn</code> æ¥å£çš„ structï¼Œå®ƒå†…åµŒäº† <code>net.conn</code> structã€‚ä¸ç®¡æ˜¯ Listener çš„ Accept è¿˜æ˜¯ Conn çš„ Read/Write æ–¹æ³•ï¼Œéƒ½æ˜¯åŸºäºä¸€ä¸ª <code>netFD</code> çš„æ•°æ®ç»“æ„çš„æ“ä½œï¼Œ <code>netFD</code> æ˜¯ä¸€ä¸ªç½‘ç»œæè¿°ç¬¦ï¼Œç±»ä¼¼äº Linux çš„æ–‡ä»¶æè¿°ç¬¦çš„æ¦‚å¿µï¼ŒnetFD ä¸­åŒ…å«ä¸€ä¸ª poll.FD æ•°æ®ç»“æ„ï¼Œè€Œ poll.FD ä¸­åŒ…å«ä¸¤ä¸ªé‡è¦çš„æ•°æ®ç»“æ„ <code>Sysfd</code> å’Œ <code>pollDesc</code>ï¼Œ <code>Sysfd</code> æ˜¯çœŸæ­£çš„ç³»ç»Ÿæ–‡ä»¶æè¿°ç¬¦ï¼Œ<code>pollDesc</code>å¯¹æ˜¯åº•å±‚äº‹ä»¶é©±åŠ¨çš„å°è£…ï¼Œæ‰€æœ‰çš„è¯»å†™è¶…æ—¶ç­‰æ“ä½œéƒ½æ˜¯é€šè¿‡è°ƒç”¨<code>pollDesc</code>çš„å¯¹åº”æ–¹æ³•å®ç°çš„ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç½‘ç»œæè¿°ç¬¦</span></span><br><span class="line"><span class="keyword">type</span> netFD <span class="keyword">struct</span> &#123;</span><br><span class="line">	pfd poll.FD</span><br><span class="line"></span><br><span class="line">	<span class="comment">// immutable until Close</span></span><br><span class="line">	family      <span class="keyword">int</span></span><br><span class="line">	sotype      <span class="keyword">int</span></span><br><span class="line">	isConnected <span class="keyword">bool</span> <span class="comment">// handshake completed or use of association with peer</span></span><br><span class="line">	net         <span class="keyword">string</span></span><br><span class="line">	laddr       Addr</span><br><span class="line">	raddr       Addr</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FD is a file descriptor. The net and os packages use this type as a</span></span><br><span class="line"><span class="comment">// field of a larger type representing a network connection or OS file.</span></span><br><span class="line"><span class="keyword">type</span> FD <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// Lock sysfd and serialize access to Read and Write methods.</span></span><br><span class="line">	fdmu fdMutex</span><br><span class="line"></span><br><span class="line">	<span class="comment">// System file descriptor. Immutable until Close.</span></span><br><span class="line">	<span class="comment">// çœŸæ­£çš„ç³»ç»Ÿæ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line">	Sysfd <span class="keyword">int</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// I/O poller.</span></span><br><span class="line">	<span class="comment">// å¯¹æ˜¯åº•å±‚äº‹ä»¶é©±åŠ¨çš„å°è£…ï¼Œæ‰€æœ‰çš„è¯»å†™è¶…æ—¶ç­‰æ“ä½œéƒ½æ˜¯é€šè¿‡è°ƒç”¨pollDescçš„å¯¹åº”æ–¹æ³•å®ç°çš„ã€‚</span></span><br><span class="line">	pd pollDesc</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Writev cache.</span></span><br><span class="line">	iovecs *[]syscall.Iovec</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Semaphore signaled when file is closed.</span></span><br><span class="line">	csema <span class="keyword">uint32</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Non-zero if this file has been set to blocking mode.</span></span><br><span class="line">	isBlocking <span class="keyword">uint32</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Whether this is a streaming descriptor, as opposed to a</span></span><br><span class="line">	<span class="comment">// packet-based descriptor like a UDP socket. Immutable.</span></span><br><span class="line">	IsStream <span class="keyword">bool</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Whether a zero byte read indicates EOF. This is false for a</span></span><br><span class="line">	<span class="comment">// message based socket connection.</span></span><br><span class="line">	ZeroReadIsEOF <span class="keyword">bool</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Whether this is a file rather than a network socket.</span></span><br><span class="line">	isFile <span class="keyword">bool</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>pollDesc</strong></p>
<p>pollDesc æ˜¯åº•å±‚äº‹ä»¶é©±åŠ¨çš„å°è£…ï¼ŒnetFD é€šè¿‡å®ƒæ¥å®Œæˆå„ç§ I/O ç›¸å…³çš„æ“ä½œï¼Œå®ƒçš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// åº•å±‚äº‹ä»¶é©±åŠ¨çš„å°è£…ï¼ŒnetFD é€šè¿‡å®ƒæ¥å®Œæˆå„ç§ I/O ç›¸å…³çš„æ“ä½œ</span><br><span class="line">type pollDesc struct &#123;</span><br><span class="line">	runtimeCtx uintptr</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œçš„ struct åªåŒ…å«äº†ä¸€ä¸ªæŒ‡é’ˆï¼Œè€Œé€šè¿‡ pollDesc çš„ init æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°å®ƒå…·ä½“çš„å®šä¹‰æ˜¯åœ¨ <code>runtime.pollDesc</code> è¿™é‡Œï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// netFD.init ä¼šè°ƒç”¨ poll.FD.Init å¹¶æœ€ç»ˆè°ƒç”¨åˆ° pollDesc.initï¼Œ</span></span><br><span class="line"><span class="comment">// å®ƒä¼šåˆ›å»º epoll å®ä¾‹å¹¶æŠŠ listener fd åŠ å…¥ç›‘å¬é˜Ÿåˆ—</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pd *pollDesc)</span> <span class="title">init</span><span class="params">(fd *FD)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="comment">// runtime_pollServerInit é€šè¿‡ `go:linkname` é“¾æ¥åˆ°å…·ä½“çš„å®ç°å‡½æ•° poll_runtime_pollServerInitï¼Œ</span></span><br><span class="line">	<span class="comment">// æ¥ç€å†è°ƒç”¨ netpollGenericInitï¼Œç„¶åä¼šæ ¹æ®ä¸åŒçš„ç³»ç»Ÿå¹³å°å»è°ƒç”¨ç‰¹å®šçš„ netpollinit æ¥åˆ›å»º epoll å®ä¾‹</span></span><br><span class="line">	serverInit.Do(runtime_pollServerInit)</span><br><span class="line">	<span class="comment">// runtime_pollOpen å†…éƒ¨è°ƒç”¨äº† netpollopen æ¥å°† listener fd æ³¨å†Œåˆ° epoll å®ä¾‹ä¸­ï¼Œå¦å¤–ï¼Œå®ƒä¼šåˆå§‹åŒ–ä¸€ä¸ª pollDesc å¹¶è¿”å›</span></span><br><span class="line">	ctx, errno := runtime_pollOpen(<span class="keyword">uintptr</span>(fd.Sysfd))</span><br><span class="line">	<span class="keyword">if</span> errno != <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> ctx != <span class="number">0</span> &#123;</span><br><span class="line">			runtime_pollUnblock(ctx)</span><br><span class="line">			runtime_pollClose(ctx)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> errnoErr(syscall.Errno(errno))</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// æŠŠçœŸæ­£åˆå§‹åŒ–å®Œæˆçš„ pollDesc å®ä¾‹èµ‹å€¼ç»™å½“å‰çš„ pollDesc ä»£è¡¨è‡ªèº«çš„æŒ‡é’ˆï¼Œ</span></span><br><span class="line">	<span class="comment">// åç»­ä½¿ç”¨ç›´æ¥é€šè¿‡è¯¥æŒ‡é’ˆæ“ä½œ</span></span><br><span class="line">	pd.runtimeCtx = ctx</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Network poller descriptor.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// No heap pointers.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//go:notinheap</span></span><br><span class="line"><span class="keyword">type</span> pollDesc <span class="keyword">struct</span> &#123;</span><br><span class="line">	link *pollDesc <span class="comment">// in pollcache, protected by pollcache.lock</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// The lock protects pollOpen, pollSetDeadline, pollUnblock and deadlineimpl operations.</span></span><br><span class="line">	<span class="comment">// This fully covers seq, rt and wt variables. fd is constant throughout the PollDesc lifetime.</span></span><br><span class="line">	<span class="comment">// pollReset, pollWait, pollWaitCanceled and runtimeÂ·netpollready (IO readiness notification)</span></span><br><span class="line">	<span class="comment">// proceed w/o taking the lock. So closing, everr, rg, rd, wg and wd are manipulated</span></span><br><span class="line">	<span class="comment">// in a lock-free way by all operations.</span></span><br><span class="line">	<span class="comment">// NOTE(dvyukov): the following code uses uintptr to store *g (rg/wg),</span></span><br><span class="line">	<span class="comment">// that will blow up when GC starts moving objects.</span></span><br><span class="line">	lock    mutex <span class="comment">// protects the following fields</span></span><br><span class="line">	fd      <span class="keyword">uintptr</span></span><br><span class="line">	closing <span class="keyword">bool</span></span><br><span class="line">	everr   <span class="keyword">bool</span>    <span class="comment">// marks event scanning error happened</span></span><br><span class="line">	user    <span class="keyword">uint32</span>  <span class="comment">// user settable cookie</span></span><br><span class="line">	rseq    <span class="keyword">uintptr</span> <span class="comment">// protects from stale read timers</span></span><br><span class="line">	<span class="comment">// å–å€¼åˆ†åˆ«å¯èƒ½æ˜¯ pdReadyã€pdWaitã€ç­‰å¾… file descriptor å°±ç»ªçš„ goroutine ä¹Ÿå°±æ˜¯ g æ•°æ®ç»“æ„ä»¥åŠ nilï¼Œå®ƒä»¬æ˜¯å®ç°å”¤é†’ goroutine çš„å…³é”®</span></span><br><span class="line">	rg   <span class="keyword">uintptr</span> <span class="comment">// pdReady, pdWait, G waiting for read or nil</span></span><br><span class="line">	rt   timer   <span class="comment">// read deadline timer (set if rt.f != nil)</span></span><br><span class="line">	rd   <span class="keyword">int64</span>   <span class="comment">// read deadline</span></span><br><span class="line">	wseq <span class="keyword">uintptr</span> <span class="comment">// protects from stale write timers</span></span><br><span class="line">	<span class="comment">// å–å€¼åˆ†åˆ«å¯èƒ½æ˜¯ pdReadyã€pdWaitã€ç­‰å¾… file descriptor å°±ç»ªçš„ goroutine ä¹Ÿå°±æ˜¯ g æ•°æ®ç»“æ„ä»¥åŠ nilï¼Œå®ƒä»¬æ˜¯å®ç°å”¤é†’ goroutine çš„å…³é”®</span></span><br><span class="line">	wg   <span class="keyword">uintptr</span>   <span class="comment">// pdReady, pdWait, G waiting for write or nil</span></span><br><span class="line">	wt   timer     <span class="comment">// write deadline timer</span></span><br><span class="line">	wd   <span class="keyword">int64</span>     <span class="comment">// write deadline</span></span><br><span class="line">	self *pollDesc <span class="comment">// storage for indirect interface. See (*pollDesc).makeArg.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>rseq</code> å’Œ <code>wseq</code> è¡¨ç¤ºæ–‡ä»¶æè¿°ç¬¦è¢«é‡ç”¨æˆ–è€…è®¡æ—¶å™¨è¢«é‡ç½®ã€‚</p>
<p><code>rd</code> å’Œ <code>wd</code>è¡¨ç¤ºç­‰å¾…æ–‡ä»¶æè¿°ç¬¦å¯è¯»æˆ–è€…å¯å†™çš„æˆªæ­¢æ—¥æœŸã€‚</p>
<p><code>rt</code> å’Œ <code>wt</code>è¡¨ç¤ºç”¨äºç­‰å¾…æ–‡ä»¶æè¿°ç¬¦çš„è®¡æ—¶å™¨ã€‚</p>
<p>æ“ä½œç³»ç»Ÿä¸­ I/O å¤šè·¯å¤ç”¨å‡½æ•°ä¼šç›‘æ§æ–‡ä»¶æè¿°ç¬¦çš„å¯è¯»æˆ–è€…å¯å†™ï¼Œè€Œ Go è¯­è¨€ç½‘ç»œè½®è¯¢å™¨ä¼šç›‘å¬ <code>runtime.pollDesc</code>ç»“æ„ä½“çš„çŠ¶æ€ï¼Œå®ƒä¼šå°è£…æ“ä½œç³»ç»Ÿçš„æ–‡ä»¶æè¿°ç¬¦ï¼Œè¿™é‡Œé‡ç‚¹å…³æ³¨é‡Œé¢çš„ <code>rg</code> å’Œ <code>wg</code>ï¼Œè¿™é‡Œä¸¤ä¸ª uintptr â€œä¸‡èƒ½æŒ‡é’ˆâ€ç±»å‹ï¼Œå–å€¼åˆ†åˆ«å¯èƒ½æ˜¯ <code>pdReady</code>ã€<code>pdWait</code>ã€ç­‰å¾…æ–‡ä»¶æè¿°ç¬¦å¯è¯»æˆ–å¯å†™çš„ Goroutine ä¹Ÿå°±æ˜¯ <code>g</code> æ•°æ®ç»“æ„ä»¥åŠ <code>nil</code>ï¼Œå®ƒä»¬æ˜¯å®ç°å”¤é†’ goroutine çš„å…³é”®ã€‚</p>
<p><code>runtime.pollDesc</code> åŒ…å«è‡ªèº«ç±»å‹çš„ä¸€ä¸ªæŒ‡é’ˆï¼Œç”¨æ¥ä¿å­˜ä¸‹ä¸€ä¸ª <code>runtime.pollDesc</code> çš„åœ°å€ï¼Œä»¥æ­¤æ¥å®ç°é“¾è¡¨ï¼Œå¯ä»¥å‡å°‘æ•°æ®ç»“æ„çš„å¤§å°ï¼Œæ‰€æœ‰çš„ <code>runtime.pollDesc</code> ä¿å­˜åœ¨ <code>runtime.pollCache</code> ç»“æ„ä¸­ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å› ä¸º runtime.pollCache æ˜¯ä¸€ä¸ªåœ¨ runtime åŒ…é‡Œçš„å…¨å±€å˜é‡ï¼Œå› æ­¤éœ€è¦ç”¨ä¸€ä¸ªäº’æ–¥é”æ¥é¿å… data race é—®é¢˜ï¼Œä»å®ƒçš„åå­—ä¹Ÿèƒ½çœ‹å‡ºè¿™æ˜¯ä¸€ä¸ªç”¨äºç¼“å­˜çš„æ•°æ®ç»“æ„ï¼Œä¹Ÿå°±æ˜¯ç”¨æ¥æé«˜æ€§èƒ½çš„</span></span><br><span class="line"><span class="keyword">type</span> pollCache <span class="keyword">struct</span> &#123;</span><br><span class="line">	lock  mutex</span><br><span class="line">	first *pollDesc</span><br><span class="line">	<span class="comment">// PollDesc objects must be type-stable,</span></span><br><span class="line">	<span class="comment">// because we can get ready notification from epoll/kqueue</span></span><br><span class="line">	<span class="comment">// after the descriptor is closed/reused.</span></span><br><span class="line">	<span class="comment">// Stale notifications are detected using seq variable,</span></span><br><span class="line">	<span class="comment">// seq is incremented when deadlines are changed or descriptor is reused.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å› ä¸º <code>runtime.pollCache</code> æ˜¯ä¸€ä¸ªåœ¨ runtime åŒ…é‡Œçš„å…¨å±€å˜é‡ï¼Œå› æ­¤éœ€è¦ç”¨ä¸€ä¸ªäº’æ–¥é”æ¥é¿å… data race é—®é¢˜ï¼Œä»å®ƒçš„åå­—ä¹Ÿèƒ½çœ‹å‡ºè¿™æ˜¯ä¸€ä¸ªç”¨äºç¼“å­˜çš„æ•°æ®ç»“æ„ï¼Œä¹Ÿå°±æ˜¯ç”¨æ¥æé«˜æ€§èƒ½çš„ï¼Œå…·ä½“å¦‚ä½•å®ç°å‘¢ï¼Ÿ</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆå§‹åŒ–æ€»å¤§å°çº¦ä¸º 4KB çš„ runtime.pollDesc ç»“æ„ä½“çš„é“¾è¡¨</span></span><br><span class="line"><span class="comment">// æ¯æ¬¡è°ƒç”¨è¯¥ç»“æ„ä½“éƒ½ä¼šè¿”å›é“¾è¡¨å¤´è¿˜æ²¡æœ‰è¢«ä½¿ç”¨çš„ runtime.pollDescï¼Œè¿™ç§æ‰¹é‡åˆå§‹åŒ–çš„åšæ³•èƒ½å¤Ÿå¢åŠ ç½‘ç»œè½®è¯¢å™¨çš„ååé‡</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *pollCache)</span> <span class="title">alloc</span><span class="params">()</span> *<span class="title">pollDesc</span></span> &#123;</span><br><span class="line">	lock(&amp;c.lock)</span><br><span class="line">	<span class="comment">// åˆ¤æ–­é“¾è¡¨å¤´æ˜¯å¦å·²ç»åˆ†é…è¿‡å€¼ï¼Œè‹¥æ˜¯ï¼Œåˆ™ç›´æ¥è¿”å›è¡¨å¤´è¿™ä¸ª pollDescï¼Œè¿™ç§æ‰¹é‡åˆå§‹åŒ–æ•°æ®è¿›è¡Œç¼“å­˜è€Œåæ¯æ¬¡éƒ½ç›´æ¥ä»ç¼“å­˜å–æ•°æ®çš„æ–¹å¼æ˜¯ä¸€ç§å¾ˆå¸¸è§çš„æ€§èƒ½ä¼˜åŒ–æ‰‹æ®µï¼Œåœ¨è¿™é‡Œè¿™ç§æ–¹å¼å¯ä»¥æœ‰æ•ˆåœ°æå‡ netpoller çš„ååé‡</span></span><br><span class="line">	<span class="keyword">if</span> c.first == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">const</span> pdSize = unsafe.Sizeof(pollDesc&#123;&#125;)</span><br><span class="line">		n := pollBlockSize / pdSize</span><br><span class="line">		<span class="keyword">if</span> n == <span class="number">0</span> &#123;</span><br><span class="line">			n = <span class="number">1</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// Must be in non-GC memory because can be referenced</span></span><br><span class="line">		<span class="comment">// only from epoll/kqueue internals.</span></span><br><span class="line">		<span class="comment">// runtime.persistentalloc ä¼šä¿è¯è¿™äº›æ•°æ®ç»“æ„åˆå§‹åŒ–åœ¨ä¸ä¼šè§¦å‘åƒåœ¾å›æ”¶çš„å†…å­˜ä¸­ï¼Œè®©è¿™äº›æ•°æ®ç»“æ„åªèƒ½è¢«å†…éƒ¨çš„ epoll å’Œ kqueue æ¨¡å—å¼•ç”¨</span></span><br><span class="line">		mem := persistentalloc(n*pdSize, <span class="number">0</span>, &amp;memstats.other_sys)</span><br><span class="line">		<span class="keyword">for</span> i := <span class="keyword">uintptr</span>(<span class="number">0</span>); i &lt; n; i++ &#123;</span><br><span class="line">			pd := (*pollDesc)(add(mem, i*pdSize))</span><br><span class="line">			pd.link = c.first</span><br><span class="line">			c.first = pd</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	pd := c.first</span><br><span class="line">	c.first = pd.link</span><br><span class="line">	lockInit(&amp;pd.lock, lockRankPollDesc)</span><br><span class="line">	unlock(&amp;c.lock)</span><br><span class="line">	<span class="keyword">return</span> pd</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Go runtime ä¼šåœ¨è°ƒç”¨ <code>poll_runtime_pollOpen</code> å¾€ epoll å®ä¾‹æ³¨å†Œ fd ä¹‹æ—¶é¦–æ¬¡è°ƒç”¨ <code>runtime.pollCache.alloc</code>æ–¹æ³•æ—¶æ‰¹é‡åˆå§‹åŒ–å¤§å° 4KB çš„ <code>runtime.pollDesc</code> ç»“æ„ä½“çš„é“¾è¡¨ï¼Œåˆå§‹åŒ–è¿‡ç¨‹ä¸­ä¼šè°ƒç”¨ <code>runtime.persistentalloc</code> æ¥ä¸ºè¿™äº›æ•°æ®ç»“æ„åˆ†é…ä¸ä¼šè¢« GC å›æ”¶çš„å†…å­˜ï¼Œç¡®ä¿è¿™äº›æ•°æ®ç»“æ„åªèƒ½è¢« <code>epoll</code>å’Œ<code>kqueue</code> åœ¨å†…æ ¸ç©ºé—´å»å¼•ç”¨ã€‚</p>
<p>å†å¾€åæ¯æ¬¡è°ƒç”¨è¿™ä¸ªæ–¹æ³•åˆ™ä¼šå…ˆåˆ¤æ–­é“¾è¡¨å¤´æ˜¯å¦å·²ç»åˆ†é…è¿‡å€¼äº†ï¼Œè‹¥æ˜¯ï¼Œåˆ™ç›´æ¥è¿”å›è¡¨å¤´è¿™ä¸ª <code>pollDesc</code>ï¼Œè¿™ç§æ‰¹é‡åˆå§‹åŒ–æ•°æ®è¿›è¡Œç¼“å­˜è€Œåæ¯æ¬¡éƒ½ç›´æ¥ä»ç¼“å­˜å–æ•°æ®çš„æ–¹å¼æ˜¯ä¸€ç§å¾ˆå¸¸è§çš„æ€§èƒ½ä¼˜åŒ–æ‰‹æ®µï¼Œåœ¨è¿™é‡Œè¿™ç§æ–¹å¼å¯ä»¥æœ‰æ•ˆåœ°æå‡ netpoller çš„ååé‡ã€‚</p>
<p>Go runtime è¿è¡Œæ—¶ä¼šè°ƒç”¨ <code>runtime.pollCache.free</code>æ–¹æ³•é‡Šæ”¾å·²ç»ç”¨å®Œçš„ <code>runtime.pollDesc</code> ç»“æ„ï¼Œå®ƒä¼šç›´æ¥å°†ç»“æ„ä½“æ’å…¥é“¾è¡¨çš„æœ€å‰é¢ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Go runtime ä¼šåœ¨å…³é—­ pollDesc ä¹‹æ—¶è°ƒç”¨ runtime.pollCache.free é‡Šæ”¾å†…å­˜</span></span><br><span class="line"><span class="comment">// é‡Šæ”¾å·²ç»ç”¨å®Œçš„ runtime.pollDesc ç»“æ„ï¼Œå®ƒä¼šç›´æ¥å°†ç»“æ„ä½“æ’å…¥é“¾è¡¨çš„æœ€å‰é¢</span></span><br><span class="line"><span class="comment">// æ²¡æœ‰é‡ç½® runtime.pollDesc ç»“æ„ä½“ä¸­çš„å­—æ®µï¼Œè¯¥ç»“æ„ä½“è¢«é‡å¤åˆ©ç”¨æ—¶æ‰ä¼šç”± runtime.poll_runtime_pollOpen å‡½æ•°é‡ç½®ã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *pollCache)</span> <span class="title">free</span><span class="params">(pd *pollDesc)</span></span> &#123;</span><br><span class="line">	lock(&amp;c.lock)</span><br><span class="line">	pd.link = c.first</span><br><span class="line">	c.first = pd</span><br><span class="line">	unlock(&amp;c.lock)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šè¿°æ–¹æ³•æ²¡æœ‰é‡ç½® <code>runtime.pollDesc</code>ç»“æ„ä½“ä¸­çš„å­—æ®µï¼Œè¯¥ç»“æ„ä½“è¢«é‡å¤åˆ©ç”¨æ—¶æ‰ä¼šç”± <code>runtime.poll_runtime_pollOpen</code>å‡½æ•°é‡ç½®ã€‚</p>
<h2 id="å®ç°åŸç†"><a href="#å®ç°åŸç†" class="headerlink" title="å®ç°åŸç†"></a>å®ç°åŸç†</h2><p> epoll çš„ä¸‰ä¸ªåŸºæœ¬è°ƒç”¨ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/epoll.h&gt;  </span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">epoll_create</span><span class="params">(<span class="keyword">int</span> size)</span></span>;  </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">epoll_ctl</span><span class="params">(<span class="keyword">int</span> epfd, <span class="keyword">int</span> op, <span class="keyword">int</span> fd, struct epoll_event *event)</span></span>;  </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">epoll_wait</span><span class="params">(<span class="keyword">int</span> epfd, struct epoll_event * events, <span class="keyword">int</span> maxevents, <span class="keyword">int</span> timeout)</span></span>;</span><br></pre></td></tr></table></figure>

<p>Go åœ¨æºç é‡Œå®ç°äº†å¯¹é‚£ä¸‰ä¸ªè°ƒç”¨çš„å°è£…ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Go å¯¹ä¸Šé¢ä¸‰ä¸ªè°ƒç”¨çš„å°è£…</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">netpollinit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="title">func</span> <span class="title">netpollopen</span><span class="params">(fd <span class="keyword">uintptr</span>, pd *pollDesc)</span> <span class="title">int32</span></span></span><br><span class="line"><span class="function"><span class="title">func</span> <span class="title">netpoll</span><span class="params">(block <span class="keyword">bool</span>)</span> <span class="title">gList</span></span></span><br></pre></td></tr></table></figure>

<p>netFD å°±æ˜¯é€šè¿‡è¿™ä¸‰ä¸ªå°è£…æ¥å¯¹ epoll è¿›è¡Œåˆ›å»ºå®ä¾‹ã€æ³¨å†Œ fd å’Œç­‰å¾…äº‹ä»¶æ“ä½œçš„ã€‚</p>
<p>ä½¿ç”¨ Go ç¼–å†™ä¸€ä¸ªå…¸å‹çš„ TCP echo server:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	listen, _ := net.Listen(<span class="string">"tcp"</span>, <span class="string">":8888"</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		conn, _ := listen.Accept()</span><br><span class="line"></span><br><span class="line">		<span class="comment">// start a new goroutine to handle the new connection.</span></span><br><span class="line">		<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">			<span class="keyword">defer</span> conn.Close()</span><br><span class="line">			packet := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">1024</span>)</span><br><span class="line">			<span class="keyword">for</span> &#123;</span><br><span class="line">				<span class="comment">// block here if socket is not available for reading data.</span></span><br><span class="line">				n, _ := conn.Read(packet)</span><br><span class="line"></span><br><span class="line">				<span class="comment">// same as above, block here if socket is not available for writing.</span></span><br><span class="line">				_, _ = conn.Write(packet[:n])</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;()</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢æ˜¯ä¸€ä¸ªåŸºäº Go åŸç”Ÿç½‘ç»œæ¨¡å‹ï¼ˆåŸºäº netpollerï¼‰ç¼–å†™çš„ä¸€ä¸ª TCP serverï¼Œæ¨¡å¼æ˜¯ <code>goroutine-per-connection</code> ï¼Œåœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œå¼€å‘è€…ä½¿ç”¨çš„æ˜¯åŒæ­¥çš„æ¨¡å¼å»ç¼–å†™å¼‚æ­¥çš„é€»è¾‘è€Œä¸”å¯¹äºå¼€å‘è€…æ¥è¯´ I/O æ˜¯å¦é˜»å¡æ˜¯æ— æ„ŸçŸ¥çš„ï¼Œä¹Ÿå°±æ˜¯è¯´å¼€å‘è€…æ— éœ€è€ƒè™‘ goroutines ç”šè‡³æ›´åº•å±‚çš„çº¿ç¨‹ã€è¿›ç¨‹çš„è°ƒåº¦å’Œä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚è€Œ Go netpoller æœ€åº•å±‚çš„äº‹ä»¶é©±åŠ¨æŠ€æœ¯è‚¯å®šæ˜¯åŸºäº epoll/kqueue/iocp è¿™ä¸€ç±»çš„ I/O äº‹ä»¶é©±åŠ¨æŠ€æœ¯ï¼Œåªä¸è¿‡æ˜¯æŠŠè¿™äº›è°ƒåº¦å’Œä¸Šä¸‹æ–‡åˆ‡æ¢çš„å·¥ä½œè½¬ç§»åˆ°äº† runtime çš„ Go schedulerï¼Œè®©å®ƒæ¥è´Ÿè´£è°ƒåº¦ goroutinesï¼Œä»è€Œæå¤§åœ°é™ä½äº†ç¨‹åºå‘˜çš„å¿ƒæ™ºè´Ÿæ‹…ï¼</p>
<h2 id="åˆå§‹åŒ–"><a href="#åˆå§‹åŒ–" class="headerlink" title="åˆå§‹åŒ–"></a>åˆå§‹åŒ–</h2><p>è°ƒç”¨ <code>net.Listen</code> ä¹‹åï¼Œåº•å±‚ä¼šé€šè¿‡ Linux çš„ç³»ç»Ÿè°ƒç”¨ <code>socket</code> æ–¹æ³•åˆ›å»ºä¸€ä¸ª fd åˆ†é…ç»™ listenerï¼Œå¹¶ç”¨ä»¥æ¥åˆå§‹åŒ– listener çš„ <code>netFD</code> ï¼Œæ¥ç€è°ƒç”¨ netFD çš„ <code>listenStream</code> æ–¹æ³•å®Œæˆå¯¹ socket çš„ bind&amp;listen æ“ä½œä»¥åŠå¯¹ <code>netFD</code> çš„åˆå§‹åŒ–ï¼ˆä¸»è¦æ˜¯å¯¹ netFD é‡Œçš„ pollDesc çš„åˆå§‹åŒ–ï¼‰</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">socket</span><span class="params">(ctx context.Context, net <span class="keyword">string</span>, family, sotype, proto <span class="keyword">int</span>, ipv6only <span class="keyword">bool</span>, laddr, raddr sockaddr, ctrlFn <span class="keyword">func</span>(<span class="keyword">string</span>, <span class="keyword">string</span>, syscall.RawConn)</span> <span class="title">error</span>) <span class="params">(fd *netFD, err error)</span></span> &#123;</span><br><span class="line">	s, err := sysSocket(family, sotype, proto)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err = setDefaultSockopts(s, family, sotype, ipv6only); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		poll.CloseFunc(s)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> fd, err = newFD(s, family, sotype, net); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		poll.CloseFunc(s)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> laddr != <span class="literal">nil</span> &amp;&amp; raddr == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">switch</span> sotype &#123;</span><br><span class="line">		<span class="keyword">case</span> syscall.SOCK_STREAM, syscall.SOCK_SEQPACKET:</span><br><span class="line">			<span class="keyword">if</span> err := fd.listenStream(laddr, listenerBacklog(), ctrlFn); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				fd.Close()</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> fd, <span class="literal">nil</span></span><br><span class="line">		<span class="keyword">case</span> syscall.SOCK_DGRAM:</span><br><span class="line">			<span class="keyword">if</span> err := fd.listenDatagram(laddr, ctrlFn); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				fd.Close()</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> fd, <span class="literal">nil</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err := fd.dial(ctx, laddr, raddr, ctrlFn); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fd.Close()</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> fd, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯¹ netFD åˆå§‹åŒ–ï¼Œæœ€åè°ƒç”¨ <code>netpollinit</code> æ–¹æ³•ï¼Œè¿™å°±æ˜¯ä¸Šé¢æåˆ°çš„å¯¹ <code>epoll_create</code> çš„å°è£…ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(fd *netFD)</span> <span class="title">init</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> fd.pfd.Init(fd.net, <span class="literal">true</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(fd *FD)</span> <span class="title">Init</span><span class="params">(net <span class="keyword">string</span>, pollable <span class="keyword">bool</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> net == <span class="string">"file"</span> &#123;</span><br><span class="line">		fd.isFile = <span class="literal">true</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> !pollable &#123;</span><br><span class="line">		fd.isBlocking = <span class="number">1</span></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">	err := fd.pd.init(fd)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fd.isBlocking = <span class="number">1</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> serverInit sync.Once</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pd *pollDesc)</span> <span class="title">init</span><span class="params">(fd *FD)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	serverInit.Do(runtime_pollServerInit)</span><br><span class="line">	ctx, errno := runtime_pollOpen(<span class="keyword">uintptr</span>(fd.Sysfd))</span><br><span class="line">	<span class="keyword">if</span> errno != <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> ctx != <span class="number">0</span> &#123;</span><br><span class="line">			runtime_pollUnblock(ctx)</span><br><span class="line">			runtime_pollClose(ctx)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> errnoErr(syscall.Errno(errno))</span><br><span class="line">	&#125;</span><br><span class="line">	pd.runtimeCtx = ctx</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">poll_runtime_pollServerInit</span><span class="params">()</span></span> &#123;</span><br><span class="line">	netpollGenericInit()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">netpollGenericInit</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> atomic.Load(&amp;netpollInited) == <span class="number">0</span> &#123;</span><br><span class="line">		lockInit(&amp;netpollInitLock, lockRankNetpollInit)</span><br><span class="line">		lock(&amp;netpollInitLock)</span><br><span class="line">		<span class="keyword">if</span> netpollInited == <span class="number">0</span> &#123;</span><br><span class="line">			netpollinit()</span><br><span class="line">			atomic.Store(&amp;netpollInited, <span class="number">1</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		unlock(&amp;netpollInitLock)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>netpollinitä¸»è¦åšï¼š</p>
<blockquote>
<ol>
<li>è°ƒç”¨ <code>epollcreate1</code> åˆ›å»ºä¸€ä¸ª epoll å®ä¾‹ <code>epfd</code>ï¼Œä½œä¸ºæ•´ä¸ª runtime çš„å”¯ä¸€ event-loop ä½¿ç”¨ï¼›</li>
<li>è°ƒç”¨ <code>runtime.nonblockingPipe</code> åˆ›å»ºä¸€ä¸ªç”¨äºå’Œ epoll å®ä¾‹é€šä¿¡çš„ç®¡é“ï¼Œè¿™é‡Œä¸ºä»€ä¹ˆä¸ç”¨æ›´æ–°ä¸”æ›´è½»é‡çš„ eventfd å‘¢ï¼Ÿæˆ‘ä¸ªäººçŒœæµ‹æ˜¯ä¸ºäº†å…¼å®¹æ›´å¤šä»¥åŠæ›´è€çš„ç³»ç»Ÿç‰ˆæœ¬ï¼›</li>
<li>å°† <code>netpollBreakRd</code> é€šçŸ¥ä¿¡å·é‡å°è£…æˆ <code>epollevent</code> äº‹ä»¶ç»“æ„ä½“æ³¨å†Œè¿› epoll å®ä¾‹ã€‚</li>
</ol>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆå§‹åŒ–ç½‘ç»œè½®è¯¢å™¨ï¼Œé€šè¿‡ sync.Once å’Œ netpollInited å˜é‡ä¿è¯å‡½æ•°åªä¼šè°ƒç”¨ä¸€æ¬¡</span></span><br><span class="line"><span class="comment">// netpollinit ä¼šåˆ›å»ºä¸€ä¸ª epoll å®ä¾‹ï¼Œç„¶åæŠŠ epoll fd èµ‹å€¼ç»™ epfdï¼Œ</span></span><br><span class="line"><span class="comment">// åç»­ listener ä»¥åŠå®ƒ accept çš„æ‰€æœ‰ sockets æœ‰å…³ epoll çš„æ“ä½œéƒ½æ˜¯åŸºäºè¿™ä¸ªå…¨å±€çš„ epfd</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºå®ä¾‹ï¼Œç­‰äº: int epoll_create(int size);</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">netpollinit</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">// è°ƒç”¨ epollcreate1 åˆ›å»ºä¸€ä¸ª epoll å®ä¾‹ epfdï¼Œä½œä¸ºæ•´ä¸ª runtime çš„å”¯ä¸€ event-loop ä½¿ç”¨</span></span><br><span class="line">	epfd = epollcreate1(_EPOLL_CLOEXEC)</span><br><span class="line">	<span class="keyword">if</span> epfd &lt; <span class="number">0</span> &#123;</span><br><span class="line">		epfd = epollcreate(<span class="number">1024</span>)</span><br><span class="line">		<span class="keyword">if</span> epfd &lt; <span class="number">0</span> &#123;</span><br><span class="line">			<span class="built_in">println</span>(<span class="string">"runtime: epollcreate failed with"</span>, -epfd)</span><br><span class="line">			throw(<span class="string">"runtime: netpollinit failed"</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		closeonexec(epfd)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// è°ƒç”¨ runtime.nonblockingPipe åˆ›å»ºä¸€ä¸ªç”¨äºå’Œ epoll å®ä¾‹é€šä¿¡çš„ç®¡é“ï¼Œè¿™é‡Œä¸ºä»€ä¹ˆä¸ç”¨æ›´æ–°ä¸”æ›´è½»é‡çš„ eventfd å‘¢ï¼Ÿæˆ‘ä¸ªäººçŒœæµ‹æ˜¯ä¸ºäº†å…¼å®¹æ›´å¤šä»¥åŠæ›´è€çš„ç³»ç»Ÿç‰ˆæœ¬</span></span><br><span class="line">	r, w, errno := nonblockingPipe()</span><br><span class="line">	<span class="keyword">if</span> errno != <span class="number">0</span> &#123;</span><br><span class="line">		<span class="built_in">println</span>(<span class="string">"runtime: pipe failed with"</span>, -errno)</span><br><span class="line">		throw(<span class="string">"runtime: pipe failed"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// å°† netpollBreakRd é€šçŸ¥ä¿¡å·é‡å°è£…æˆ epollevent äº‹ä»¶ç»“æ„ä½“æ³¨å†Œè¿› epoll å®ä¾‹</span></span><br><span class="line">	ev := epollevent&#123;</span><br><span class="line">		events: _EPOLLIN,</span><br><span class="line">	&#125;</span><br><span class="line">	*(**<span class="keyword">uintptr</span>)(unsafe.Pointer(&amp;ev.data)) = &amp;netpollBreakRd</span><br><span class="line">	errno = epollctl(epfd, _EPOLL_CTL_ADD, r, &amp;ev)</span><br><span class="line">	<span class="keyword">if</span> errno != <span class="number">0</span> &#123;</span><br><span class="line">		<span class="built_in">println</span>(<span class="string">"runtime: epollctl failed with"</span>, -errno)</span><br><span class="line">		throw(<span class="string">"runtime: epollctl failed"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	netpollBreakRd = <span class="keyword">uintptr</span>(r)</span><br><span class="line">	netpollBreakWr = <span class="keyword">uintptr</span>(w)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>init ä¸­ä¼šè°ƒç”¨ runtime_pollOpen æ–¹æ³•ï¼Œ<code>netpollopen</code> ä¼šè¢« runtime_pollOpen è°ƒç”¨ï¼Œç”¨äºæ³¨å†Œ fd åˆ° epoll å®ä¾‹ã€‚è¿™é‡Œä½¿ç”¨çš„æ˜¯ epoll çš„ ET æ¨¡å¼ï¼ŒåŒæ—¶ä¼šåˆ©ç”¨ä¸‡èƒ½æŒ‡é’ˆæŠŠ pollDesc ä¿å­˜åˆ° epollevent çš„ä¸€ä¸ª 8 ä½çš„å­—èŠ‚æ•°ç»„ data é‡Œã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">poll_runtime_pollOpen</span><span class="params">(fd <span class="keyword">uintptr</span>)</span> <span class="params">(*pollDesc, <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">	pd := pollcache.alloc()</span><br><span class="line">	lock(&amp;pd.lock)</span><br><span class="line">	<span class="keyword">if</span> pd.wg != <span class="number">0</span> &amp;&amp; pd.wg != pdReady &#123;</span><br><span class="line">		throw(<span class="string">"runtime: blocked write on free polldesc"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> pd.rg != <span class="number">0</span> &amp;&amp; pd.rg != pdReady &#123;</span><br><span class="line">		throw(<span class="string">"runtime: blocked read on free polldesc"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	pd.fd = fd</span><br><span class="line">	pd.closing = <span class="literal">false</span></span><br><span class="line">	pd.everr = <span class="literal">false</span></span><br><span class="line">	pd.rseq++</span><br><span class="line">	pd.rg = <span class="number">0</span></span><br><span class="line">	pd.rd = <span class="number">0</span></span><br><span class="line">	pd.wseq++</span><br><span class="line">	pd.wg = <span class="number">0</span></span><br><span class="line">	pd.wd = <span class="number">0</span></span><br><span class="line">	pd.self = pd</span><br><span class="line">	unlock(&amp;pd.lock)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> errno <span class="keyword">int32</span></span><br><span class="line">	errno = netpollopen(fd, pd)</span><br><span class="line">	<span class="keyword">return</span> pd, <span class="keyword">int</span>(errno)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">netpollopen</span><span class="params">(fd <span class="keyword">uintptr</span>, pd *pollDesc)</span> <span class="title">int32</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> ev epollevent</span><br><span class="line">	ev.events = _EPOLLIN | _EPOLLOUT | _EPOLLRDHUP | _EPOLLET</span><br><span class="line">	*(**pollDesc)(unsafe.Pointer(&amp;ev.data)) = pd</span><br><span class="line">	<span class="keyword">return</span> -epollctl(epfd, _EPOLL_CTL_ADD, <span class="keyword">int32</span>(fd), &amp;ev)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="park-goroutine"><a href="#park-goroutine" class="headerlink" title="park goroutine"></a>park goroutine</h2><p><code>netpoll</code> accept socket çš„å·¥ä½œæµç¨‹å¦‚ä¸‹ï¼š</p>
<blockquote>
<ol>
<li>æœåŠ¡ç«¯çš„ netFD åœ¨ <code>listen</code> æ—¶ä¼šåˆ›å»º epoll çš„å®ä¾‹ï¼Œå¹¶å°† listenerFD åŠ å…¥ epoll çš„äº‹ä»¶é˜Ÿåˆ—</li>
<li>netFD åœ¨ <code>accept</code> æ—¶å°†è¿”å›çš„ connFD ä¹ŸåŠ å…¥ epoll çš„äº‹ä»¶é˜Ÿåˆ—</li>
<li>netFD åœ¨è¯»å†™æ—¶å‡ºç° <code>syscall.EAGAIN</code> é”™è¯¯ï¼Œé€šè¿‡ pollDesc çš„ <code>waitRead</code> æ–¹æ³•å°†å½“å‰çš„ goroutine park ä½ï¼Œç›´åˆ° readyï¼Œä» pollDesc çš„ <code>waitRead</code> ä¸­è¿”å›</li>
</ol>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(fd *netFD)</span> <span class="title">accept</span><span class="params">()</span> <span class="params">(netfd *netFD, err error)</span></span> &#123;</span><br><span class="line">  <span class="comment">// è°ƒç”¨ poll.FD çš„ Accept æ–¹æ³•æ¥å—æ–°çš„ socket è¿æ¥ï¼Œè¿”å› socket çš„ fd</span></span><br><span class="line">	d, rsa, errcall, err := fd.pfd.Accept()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> errcall != <span class="string">""</span> &#123;</span><br><span class="line">			err = wrapSyscallError(errcall, err)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">  <span class="comment">// ä»¥ socket fd æ„é€ ä¸€ä¸ªæ–°çš„ netFDï¼Œä»£è¡¨è¿™ä¸ªæ–°çš„ socket</span></span><br><span class="line">	<span class="keyword">if</span> netfd, err = newFD(d, fd.family, fd.sotype, fd.net); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		poll.CloseFunc(d)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">  <span class="comment">// è°ƒç”¨ netFD çš„ init æ–¹æ³•å®Œæˆåˆå§‹åŒ–</span></span><br><span class="line">	<span class="keyword">if</span> err = netfd.init(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		netfd.Close()</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	lsa, _ := syscall.Getsockname(netfd.pfd.Sysfd)</span><br><span class="line">	netfd.setAddr(netfd.addrFunc()(lsa), netfd.addrFunc()(rsa))</span><br><span class="line">	<span class="keyword">return</span> netfd, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>netFD.accept</code> æ–¹æ³•é‡Œä¼šå†è°ƒç”¨ <code>poll.FD.Accept</code> ï¼Œæœ€åä¼šä½¿ç”¨ Linux çš„ç³»ç»Ÿè°ƒç”¨ <code>accept</code> æ¥å®Œæˆæ–°è¿æ¥çš„æ¥æ”¶ï¼Œå¹¶ä¸”ä¼šæŠŠ accept çš„ socket è®¾ç½®æˆéé˜»å¡ I/O æ¨¡å¼ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(fd *FD)</span> <span class="title">Accept</span><span class="params">()</span> <span class="params">(<span class="keyword">int</span>, syscall.Sockaddr, <span class="keyword">string</span>, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> err := fd.readLock(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>, <span class="literal">nil</span>, <span class="string">""</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> fd.readUnlock()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err := fd.pd.prepareRead(fd.isFile); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>, <span class="literal">nil</span>, <span class="string">""</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">    <span class="comment">// ä½¿ç”¨ linux ç³»ç»Ÿè°ƒç”¨ accept æ¥æ”¶æ–°è¿æ¥ï¼Œåˆ›å»ºå¯¹åº”çš„ socket</span></span><br><span class="line">		s, rsa, errcall, err := accept(fd.Sysfd)</span><br><span class="line">    <span class="comment">// å› ä¸º listener fd åœ¨åˆ›å»ºçš„æ—¶å€™å·²ç»è®¾ç½®æˆéé˜»å¡çš„äº†</span></span><br><span class="line">    <span class="comment">// æ‰€ä»¥ accept æ–¹æ³•ä¼šç›´æ¥è¿”å›ï¼Œä¸ç®¡æœ‰æ²¡æœ‰æ–°è¿æ¥åˆ°æ¥ï¼›å¦‚æœ err == nil åˆ™è¡¨ç¤ºæ­£å¸¸å»ºç«‹æ–°è¿æ¥ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">		<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> s, rsa, <span class="string">""</span>, err</span><br><span class="line">		&#125;</span><br><span class="line">    <span class="comment">// å¦‚æœ err != nilï¼Œåˆ™åˆ¤æ–­ err == syscall.EAGAINï¼Œç¬¦åˆæ¡ä»¶åˆ™è¿›å…¥ pollDesc.waitRead æ–¹æ³•</span></span><br><span class="line">		<span class="keyword">switch</span> err &#123;</span><br><span class="line">		<span class="keyword">case</span> syscall.EINTR:</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		<span class="keyword">case</span> syscall.EAGAIN:</span><br><span class="line">			<span class="keyword">if</span> fd.pd.pollable() &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœå½“å‰æ²¡æœ‰å‘ç”ŸæœŸå¾…çš„ I/O äº‹ä»¶ï¼Œé‚£ä¹ˆ waitRead ä¼šé€šè¿‡ park goroutine è®©é€»è¾‘ block åœ¨è¿™é‡Œ</span></span><br><span class="line">				<span class="keyword">if</span> err = fd.pd.waitRead(fd.isFile); err == <span class="literal">nil</span> &#123;</span><br><span class="line">					<span class="keyword">continue</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		<span class="keyword">case</span> syscall.ECONNABORTED:</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>, <span class="literal">nil</span>, errcall, err</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>pollDesc.waitRead</code> æ–¹æ³•ä¸»è¦è´Ÿè´£æ£€æµ‹å½“å‰è¿™ä¸ª pollDesc çš„ä¸Šå±‚ netFD å¯¹åº”çš„ fd æ˜¯å¦æœ‰ã€æœŸå¾…çš„ã€I/O äº‹ä»¶å‘ç”Ÿï¼Œå¦‚æœæœ‰å°±ç›´æ¥è¿”å›ï¼Œå¦åˆ™å°± park ä½å½“å‰çš„ goroutine å¹¶æŒç»­ç­‰å¾…ç›´è‡³å¯¹åº”çš„ fd ä¸Šå‘ç”Ÿå¯è¯»/å¯å†™æˆ–è€…å…¶ä»–ã€æœŸå¾…çš„ã€I/O äº‹ä»¶ä¸ºæ­¢ï¼Œç„¶åå®ƒå°±ä¼šè¿”å›åˆ°å¤–å±‚çš„ for å¾ªç¯ï¼Œè®© goroutine ç»§ç»­æ‰§è¡Œé€»è¾‘ã€‚</p>
<p>poll.FD.Accept() è¿”å›ä¹‹åï¼Œä¼šæ„é€ ä¸€ä¸ªå¯¹åº”è¿™ä¸ªæ–° socket çš„ netFDï¼Œç„¶åè°ƒç”¨ init() æ–¹æ³•å®Œæˆåˆå§‹åŒ–ï¼Œè¿™ä¸ª init è¿‡ç¨‹å’Œå‰é¢ net.Listen() æ˜¯ä¸€æ ·çš„ï¼Œç„¶åæŠŠè¿™ä¸ª socket fd æ³¨å†Œåˆ° listener çš„ epoll å®ä¾‹çš„äº‹ä»¶é˜Ÿåˆ—ä¸­å»ï¼Œç­‰å¾… I/O äº‹ä»¶ã€‚</p>
<p><code>pollDesc.waitRead</code> å†…éƒ¨è°ƒç”¨äº† <code>poll.runtime_pollWait</code> â€“&gt; <code>runtime.poll_runtime_pollWait</code> æ¥è¾¾æˆæ—  I/O äº‹ä»¶æ—¶ park ä½ goroutine çš„ç›®çš„ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">poll_runtime_pollWait</span><span class="params">(pd *pollDesc, mode <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">	errcode := netpollcheckerr(pd, <span class="keyword">int32</span>(mode))</span><br><span class="line">	<span class="keyword">if</span> errcode != pollNoError &#123;</span><br><span class="line">		<span class="keyword">return</span> errcode</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> GOOS == <span class="string">"solaris"</span> || GOOS == <span class="string">"illumos"</span> || GOOS == <span class="string">"aix"</span> &#123;</span><br><span class="line">		netpollarm(pd, mode)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// è¿›å…¥ netpollblock å¹¶ä¸”åˆ¤æ–­æ˜¯å¦æœ‰æœŸå¾…çš„ I/O äº‹ä»¶å‘ç”Ÿï¼Œè¿™é‡Œçš„ for å¾ªç¯æ˜¯ä¸ºäº†ä¸€ç›´ç­‰åˆ° io ready</span></span><br><span class="line">	<span class="keyword">for</span> !netpollblock(pd, <span class="keyword">int32</span>(mode), <span class="literal">false</span>) &#123;</span><br><span class="line">		errcode = netpollcheckerr(pd, <span class="keyword">int32</span>(mode))</span><br><span class="line">		<span class="keyword">if</span> errcode != pollNoError &#123;</span><br><span class="line">			<span class="keyword">return</span> errcode</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> pollNoError</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>netpollblock åˆ¤æ–­æ˜¯å¦æœ‰æœŸå¾…çš„ I/O äº‹ä»¶å‘ç”Ÿï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">netpollblock</span><span class="params">(pd *pollDesc, mode <span class="keyword">int32</span>, waitio <span class="keyword">bool</span>)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">	<span class="comment">// gpp ä¿å­˜çš„æ˜¯ goroutine çš„æ•°æ®ç»“æ„ gï¼Œè¿™é‡Œä¼šæ ¹æ® mode çš„å€¼å†³å®šæ˜¯ rg è¿˜æ˜¯ wgï¼Œ</span></span><br><span class="line">	<span class="comment">// rg å’Œ wg æ˜¯ç”¨æ¥ä¿å­˜ç­‰å¾… I/O å°±ç»ªçš„ gorouine çš„ï¼Œåé¢è°ƒç”¨ gopark ä¹‹åï¼Œä¼šæŠŠå½“å‰çš„ goroutine çš„æŠ½è±¡æ•°æ®ç»“æ„ g å­˜å…¥ gpp è¿™ä¸ªæŒ‡é’ˆï¼Œä¹Ÿå°±æ˜¯ rg æˆ–è€… wg</span></span><br><span class="line">	gpp := &amp;pd.rg</span><br><span class="line">	<span class="keyword">if</span> mode == <span class="string">'w'</span> &#123;</span><br><span class="line">		gpp = &amp;pd.wg</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// è¿™ä¸ª for å¾ªç¯æ˜¯ä¸ºäº†ç­‰å¾… io ready æˆ–è€… io wait</span></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		old := *gpp</span><br><span class="line">		<span class="comment">// gpp == pdReady è¡¨ç¤ºæ­¤æ—¶å·²æœ‰æœŸå¾…çš„ I/O äº‹ä»¶å‘ç”Ÿï¼Œå¯ä»¥ç›´æ¥è¿”å› unblock å½“å‰ goroutine å¹¶æ‰§è¡Œå“åº”çš„ I/O æ“ä½œ</span></span><br><span class="line">		<span class="keyword">if</span> old == pdReady &#123;</span><br><span class="line">			*gpp = <span class="number">0</span></span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> old != <span class="number">0</span> &#123;</span><br><span class="line">			throw(<span class="string">"runtime: double wait"</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// å¦‚æœæ²¡æœ‰æœŸå¾…çš„ I/O äº‹ä»¶å‘ç”Ÿï¼Œåˆ™é€šè¿‡åŸå­æ“ä½œæŠŠ gpp çš„å€¼ç½®ä¸º pdWait å¹¶é€€å‡º for å¾ªç¯</span></span><br><span class="line">		<span class="keyword">if</span> atomic.Casuintptr(gpp, <span class="number">0</span>, pdWait) &#123;</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// waitio æ­¤æ—¶æ˜¯ falseï¼Œnetpollcheckerr æ–¹æ³•ä¼šæ£€æŸ¥å½“å‰ pollDesc å¯¹åº”çš„ fd æ˜¯å¦æ˜¯æ­£å¸¸çš„ï¼Œ</span></span><br><span class="line">	<span class="comment">// é€šå¸¸æ¥è¯´  netpollcheckerr(pd, mode) == 0 æ˜¯æˆç«‹çš„ï¼Œæ‰€ä»¥è¿™é‡Œä¼šæ‰§è¡Œ gopark</span></span><br><span class="line">	<span class="comment">// æŠŠå½“å‰ goroutine ç»™ park ä½ï¼Œç›´è‡³å¯¹åº”çš„ fd ä¸Šå‘ç”Ÿå¯è¯»/å¯å†™æˆ–è€…å…¶ä»–ã€æœŸå¾…çš„ã€I/O äº‹ä»¶ä¸ºæ­¢ï¼Œ</span></span><br><span class="line">	<span class="comment">// ç„¶å unpark è¿”å›ï¼Œåœ¨ gopark å†…éƒ¨ä¼šæŠŠå½“å‰ goroutine çš„æŠ½è±¡æ•°æ®ç»“æ„ g å­˜å…¥</span></span><br><span class="line">	<span class="comment">// gpp(pollDesc.rg/pollDesc.wg) æŒ‡é’ˆé‡Œï¼Œä»¥ä¾¿åœ¨åé¢çš„ netpoll å‡½æ•°å–å‡º pollDesc ä¹‹åï¼Œ</span></span><br><span class="line">	<span class="comment">// æŠŠ g æ·»åŠ åˆ°é“¾è¡¨é‡Œè¿”å›ï¼Œæ¥ç€é‡æ–°è°ƒåº¦ goroutine</span></span><br><span class="line">	<span class="keyword">if</span> waitio || netpollcheckerr(pd, mode) == <span class="number">0</span> &#123;</span><br><span class="line">		gopark(netpollblockcommit, unsafe.Pointer(gpp), waitReasonIOWait, traceEvGoBlockNet, <span class="number">5</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	old := atomic.Xchguintptr(gpp, <span class="number">0</span>)</span><br><span class="line">	<span class="keyword">if</span> old &gt; pdWait &#123;</span><br><span class="line">		throw(<span class="string">"runtime: corrupted polldesc"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> old == pdReady</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>gopark ä¼šåœä½å½“å‰çš„ goroutine å¹¶ä¸”è°ƒç”¨ä¼ é€’è¿›æ¥çš„å›è°ƒå‡½æ•° unlockfï¼Œä» netpollblockå‡½æ•° æˆ‘ä»¬å¯ä»¥çŸ¥é“è¿™ä¸ªå‡½æ•°æ˜¯ netpollblockcommitã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">gopark</span><span class="params">(unlockf <span class="keyword">func</span>(*g, unsafe.Pointer)</span> <span class="title">bool</span>, <span class="title">lock</span> <span class="title">unsafe</span>.<span class="title">Pointer</span>, <span class="title">reason</span> <span class="title">waitReason</span>, <span class="title">traceEv</span> <span class="title">byte</span>, <span class="title">traceskip</span> <span class="title">int</span>)</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> reason != waitReasonSleep &#123;</span><br><span class="line">		checkTimeouts()</span><br><span class="line">	&#125;</span><br><span class="line">	mp := acquirem()</span><br><span class="line">	gp := mp.curg</span><br><span class="line">	status := readgstatus(gp)</span><br><span class="line">	<span class="keyword">if</span> status != _Grunning &amp;&amp; status != _Gscanrunning &#123;</span><br><span class="line">		throw(<span class="string">"gopark: bad g status"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	mp.waitlock = lock</span><br><span class="line">	mp.waitunlockf = unlockf</span><br><span class="line">	gp.waitreason = reason</span><br><span class="line">	mp.waittraceev = traceEv</span><br><span class="line">	mp.waittraceskip = traceskip</span><br><span class="line">	releasem(mp)</span><br><span class="line">	<span class="comment">// gopark æœ€ç»ˆä¼šè°ƒç”¨ park_mï¼Œåœ¨è¿™ä¸ªå‡½æ•°å†…éƒ¨ä¼šè°ƒç”¨ unlockfï¼Œä¹Ÿå°±æ˜¯ netpollblockcommitï¼Œ</span></span><br><span class="line">	<span class="comment">// ç„¶åä¼šæŠŠå½“å‰çš„ goroutineï¼Œä¹Ÿå°±æ˜¯ g æ•°æ®ç»“æ„ä¿å­˜åˆ° pollDesc çš„ rg æˆ–è€… wg æŒ‡é’ˆé‡Œ</span></span><br><span class="line">	mcall(park_m)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">park_m</span><span class="params">(gp *g)</span></span> &#123;</span><br><span class="line">	_g_ := getg()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> trace.enabled &#123;</span><br><span class="line">		traceGoPark(_g_.m.waittraceev, _g_.m.waittraceskip)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	casgstatus(gp, _Grunning, _Gwaiting)</span><br><span class="line">	dropg()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> fn := _g_.m.waitunlockf; fn != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="comment">// è°ƒç”¨ netpollblockcommitï¼ŒæŠŠå½“å‰çš„ goroutineï¼Œä¹Ÿå°±æ˜¯ g æ•°æ®ç»“æ„ä¿å­˜åˆ° pollDesc çš„ rg æˆ–è€… wg æŒ‡é’ˆé‡Œ</span></span><br><span class="line">		ok := fn(gp, _g_.m.waitlock)</span><br><span class="line">		_g_.m.waitunlockf = <span class="literal">nil</span></span><br><span class="line">		_g_.m.waitlock = <span class="literal">nil</span></span><br><span class="line">		<span class="keyword">if</span> !ok &#123;</span><br><span class="line">			<span class="keyword">if</span> trace.enabled &#123;</span><br><span class="line">				traceGoUnpark(gp, <span class="number">2</span>)</span><br><span class="line">			&#125;</span><br><span class="line">			casgstatus(gp, _Gwaiting, _Grunnable)</span><br><span class="line">			execute(gp, <span class="literal">true</span>) <span class="comment">// Schedule it back, never returns.</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	schedule()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// netpollblockcommit åœ¨ gopark å‡½æ•°é‡Œè¢«è°ƒç”¨</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">netpollblockcommit</span><span class="params">(gp *g, gpp unsafe.Pointer)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">	<span class="comment">// é€šè¿‡åŸå­æ“ä½œæŠŠå½“å‰ goroutine æŠ½è±¡çš„æ•°æ®ç»“æ„ gï¼Œä¹Ÿå°±æ˜¯è¿™é‡Œçš„å‚æ•° gp å­˜å…¥ gpp æŒ‡é’ˆï¼Œ</span></span><br><span class="line">	<span class="comment">// æ­¤æ—¶ gpp çš„å€¼æ˜¯ pollDesc çš„ rg æˆ–è€… wg æŒ‡é’ˆ</span></span><br><span class="line">	r := atomic.Casuintptr((*<span class="keyword">uintptr</span>)(gpp), pdWait, <span class="keyword">uintptr</span>(unsafe.Pointer(gp)))</span><br><span class="line">	<span class="keyword">if</span> r &#123;</span><br><span class="line">		atomic.Xadd(&amp;netpollWaiters, <span class="number">1</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> r</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="epoll-wait-â€”â€”-netpoll"><a href="#epoll-wait-â€”â€”-netpoll" class="headerlink" title="epoll_wait â€”â€” netpoll"></a>epoll_wait â€”â€” netpoll</h2><p>å‰é¢å·²ç»ä»æºç çš„å±‚é¢åˆ†æå®Œäº† netpoll æ˜¯å¦‚ä½•é€šè¿‡ park goroutine ä»è€Œè¾¾åˆ°é˜»å¡ Accept/Read/Write çš„æ•ˆæœï¼Œè€Œé€šè¿‡è°ƒç”¨ goparkï¼Œgoroutine ä¼šè¢«æ”¾ç½®åœ¨æŸä¸ªç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œè¿™é‡Œæ˜¯æ”¾åˆ°äº† epoll çš„ â€œinterest listâ€ é‡Œï¼Œåº•å±‚æ•°æ®ç»“æ„æ˜¯ç”±çº¢é»‘æ ‘å®ç°çš„ <code>eventpoll.rbr</code>ï¼Œæ­¤æ—¶ G çš„çŠ¶æ€ç”± <code>_Grunning</code>ä¸º<code>_Gwaitting</code> ï¼Œå› æ­¤ G å¿…é¡»è¢«æ‰‹åŠ¨å”¤é†’(é€šè¿‡ goready )ï¼Œå¦åˆ™ä¼šä¸¢å¤±ä»»åŠ¡ï¼Œåº”ç”¨å±‚é˜»å¡é€šå¸¸ä½¿ç”¨è¿™ç§æ–¹å¼ã€‚</p>
<p><img src="/images/io-3.png" alt="io"></p>
<blockquote>
<p>é¦–å…ˆï¼Œclient è¿æ¥ server çš„æ—¶å€™ï¼Œlistener é€šè¿‡ accept è°ƒç”¨æ¥æ”¶æ–° connectionï¼Œæ¯ä¸€ä¸ªæ–° connection éƒ½å¯åŠ¨ä¸€ä¸ª goroutine å¤„ç†ï¼Œaccept è°ƒç”¨ä¼šæŠŠè¯¥ connection çš„ fd è¿å¸¦æ‰€åœ¨çš„ goroutine ä¸Šä¸‹æ–‡ä¿¡æ¯å°è£…æ³¨å†Œåˆ° epoll çš„ç›‘å¬åˆ—è¡¨é‡Œå»ï¼Œå½“ goroutine è°ƒç”¨ <code>conn.Read</code> æˆ–è€… <code>conn.Write</code> ç­‰éœ€è¦é˜»å¡ç­‰å¾…çš„å‡½æ•°æ—¶ï¼Œä¼šè¢« <code>gopark</code> ç»™å°å­˜èµ·æ¥å¹¶ä½¿ä¹‹ä¼‘çœ ï¼Œè®© P å»æ‰§è¡Œæœ¬åœ°è°ƒåº¦é˜Ÿåˆ—é‡Œçš„ä¸‹ä¸€ä¸ªå¯æ‰§è¡Œçš„ goroutineï¼Œå¾€å Go scheduler ä¼šåœ¨å¾ªç¯è°ƒåº¦çš„ <code>runtime.schedule()</code> å‡½æ•°ä»¥åŠ sysmon ç›‘æ§çº¿ç¨‹ä¸­è°ƒç”¨ <code>runtime.netpoll</code> ä»¥è·å–å¯è¿è¡Œçš„ goroutine åˆ—è¡¨å¹¶é€šè¿‡è°ƒç”¨ injectglist æŠŠå‰©ä¸‹çš„ g æ”¾å…¥å…¨å±€è°ƒåº¦é˜Ÿåˆ—æˆ–è€…å½“å‰ P æœ¬åœ°è°ƒåº¦é˜Ÿåˆ—å»é‡æ–°æ‰§è¡Œã€‚</p>
<p>é‚£ä¹ˆå½“ I/O äº‹ä»¶å‘ç”Ÿä¹‹åï¼Œnetpoller é€šè¿‡ <code>runtime.netpoll</code>å”¤é†’é‚£äº›åœ¨ I/O wait çš„ goroutineã€‚</p>
</blockquote>
<p><code>runtime.netpoll</code> çš„æ ¸å¿ƒé€»è¾‘æ˜¯ï¼š</p>
<blockquote>
<ol>
<li>æ ¹æ®è°ƒç”¨æ–¹çš„å…¥å‚ delayï¼Œè®¾ç½®å¯¹åº”çš„è°ƒç”¨ <code>epollwait</code> çš„ timeout å€¼ï¼›</li>
<li>è°ƒç”¨ <code>epollwait</code> ç­‰å¾…å‘ç”Ÿäº†å¯è¯»/å¯å†™äº‹ä»¶çš„ fdï¼›</li>
<li>å¾ªç¯ <code>epollwait</code> è¿”å›çš„äº‹ä»¶åˆ—è¡¨ï¼Œå¤„ç†å¯¹åº”çš„äº‹ä»¶ç±»å‹ï¼Œ ç»„è£…å¯è¿è¡Œçš„ goroutine é“¾è¡¨å¹¶è¿”å›ã€‚</li>
</ol>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è½®è¯¢ç½‘ç»œå¹¶è¿”å›ä¸€ç»„å·²ç»å‡†å¤‡å°±ç»ªçš„ Goroutineï¼Œä¼ å…¥çš„å‚æ•°ä¼šå†³å®šå®ƒçš„è¡Œä¸ºï¼›</span></span><br><span class="line"><span class="comment">// å¦‚æœå‚æ•°å°äº 0ï¼Œæ— é™æœŸç­‰å¾…æ–‡ä»¶æè¿°ç¬¦å°±ç»ªï¼›</span></span><br><span class="line"><span class="comment">// å¦‚æœå‚æ•°ç­‰äº 0ï¼Œéé˜»å¡åœ°è½®è¯¢ç½‘ç»œï¼›</span></span><br><span class="line"><span class="comment">// å¦‚æœå‚æ•°å¤§äº 0ï¼Œé˜»å¡ç‰¹å®šæ—¶é—´è½®è¯¢ç½‘ç»œï¼›</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ç­‰å¾…äº‹ä»¶ï¼Œç­‰äº: int epoll_wait(int epfd, struct epoll_event * events, int maxevents, int timeout);</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">netpoll</span><span class="params">(delay <span class="keyword">int64</span>)</span> <span class="title">gList</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> epfd == <span class="number">-1</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> gList&#123;&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">var</span> waitms <span class="keyword">int32</span></span><br><span class="line">	<span class="comment">// æ ¹æ®è°ƒç”¨æ–¹çš„å…¥å‚ delayï¼Œè®¾ç½®å¯¹åº”çš„è°ƒç”¨ epollwait çš„ timeout å€¼ï¼›</span></span><br><span class="line">	<span class="keyword">if</span> delay &lt; <span class="number">0</span> &#123;</span><br><span class="line">		waitms = <span class="number">-1</span></span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> delay == <span class="number">0</span> &#123;</span><br><span class="line">		waitms = <span class="number">0</span></span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> delay &lt; <span class="number">1e6</span> &#123;</span><br><span class="line">		waitms = <span class="number">1</span></span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> delay &lt; <span class="number">1e15</span> &#123;</span><br><span class="line">		waitms = <span class="keyword">int32</span>(delay / <span class="number">1e6</span>)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		waitms = <span class="number">1e9</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">var</span> events [<span class="number">128</span>]epollevent</span><br><span class="line">retry:</span><br><span class="line">	<span class="comment">// è°ƒç”¨ epollwait ç­‰å¾…å‘ç”Ÿäº†å¯è¯»/å¯å†™äº‹ä»¶çš„ fdï¼›</span></span><br><span class="line">	<span class="comment">// å¾ªç¯ epollwait è¿”å›çš„äº‹ä»¶åˆ—è¡¨ï¼Œå¤„ç†å¯¹åº”çš„äº‹ä»¶ç±»å‹ï¼Œ ç»„è£…å¯è¿è¡Œçš„ goroutine é“¾è¡¨å¹¶è¿”å›ã€‚</span></span><br><span class="line">	n := epollwait(epfd, &amp;events[<span class="number">0</span>], <span class="keyword">int32</span>(<span class="built_in">len</span>(events)), waitms)</span><br><span class="line">	<span class="keyword">if</span> n &lt; <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> n != -_EINTR &#123;</span><br><span class="line">			<span class="built_in">println</span>(<span class="string">"runtime: epollwait on fd"</span>, epfd, <span class="string">"failed with"</span>, -n)</span><br><span class="line">			throw(<span class="string">"runtime: netpoll failed"</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> waitms &gt; <span class="number">0</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> gList&#123;&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">goto</span> retry</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// toRun æ˜¯ä¸€ä¸ª g çš„é“¾è¡¨ï¼Œå­˜å‚¨è¦æ¢å¤çš„ goroutinesï¼Œæœ€åè¿”å›ç»™è°ƒç”¨æ–¹</span></span><br><span class="line">	<span class="keyword">var</span> toRun gList</span><br><span class="line">	<span class="keyword">for</span> i := <span class="keyword">int32</span>(<span class="number">0</span>); i &lt; n; i++ &#123;</span><br><span class="line">		ev := &amp;events[i]</span><br><span class="line">		<span class="keyword">if</span> ev.events == <span class="number">0</span> &#123;</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Go scheduler åœ¨è°ƒç”¨ findrunnable() å¯»æ‰¾ goroutine å»æ‰§è¡Œçš„æ—¶å€™ï¼Œ</span></span><br><span class="line">		<span class="comment">// åœ¨è°ƒç”¨ netpoll ä¹‹æ—¶ä¼šæ£€æŸ¥å½“å‰æ˜¯å¦æœ‰å…¶ä»–çº¿ç¨‹åŒæ­¥é˜»å¡åœ¨ netpollï¼Œ</span></span><br><span class="line">		<span class="comment">// è‹¥æ˜¯ï¼Œåˆ™è°ƒç”¨ netpollBreak æ¥å”¤é†’é‚£ä¸ªçº¿ç¨‹ï¼Œé¿å…å®ƒé•¿æ—¶é—´é˜»å¡</span></span><br><span class="line">		<span class="keyword">if</span> *(**<span class="keyword">uintptr</span>)(unsafe.Pointer(&amp;ev.data)) == &amp;netpollBreakRd &#123;</span><br><span class="line">			<span class="keyword">if</span> ev.events != _EPOLLIN &#123;</span><br><span class="line">				<span class="built_in">println</span>(<span class="string">"runtime: netpoll: break fd ready for"</span>, ev.events)</span><br><span class="line">				throw(<span class="string">"runtime: netpoll: break fd ready for something unexpected"</span>)</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> delay != <span class="number">0</span> &#123;</span><br><span class="line">				<span class="keyword">var</span> tmp [<span class="number">16</span>]<span class="keyword">byte</span></span><br><span class="line">				read(<span class="keyword">int32</span>(netpollBreakRd), noescape(unsafe.Pointer(&amp;tmp[<span class="number">0</span>])), <span class="keyword">int32</span>(<span class="built_in">len</span>(tmp)))</span><br><span class="line">				atomic.Store(&amp;netpollWakeSig, <span class="number">0</span>)</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// åˆ¤æ–­å‘ç”Ÿçš„äº‹ä»¶ç±»å‹ï¼Œè¯»ç±»å‹æˆ–è€…å†™ç±»å‹ç­‰ï¼Œç„¶åç»™ mode å¤åˆ¶ç›¸åº”çš„å€¼ï¼Œ</span></span><br><span class="line">		<span class="comment">// mode ç”¨æ¥å†³å®šä» pollDesc é‡Œçš„ rg è¿˜æ˜¯ wg é‡Œå–å‡º goroutine</span></span><br><span class="line">		<span class="keyword">var</span> mode <span class="keyword">int32</span></span><br><span class="line">		<span class="keyword">if</span> ev.events&amp;(_EPOLLIN|_EPOLLRDHUP|_EPOLLHUP|_EPOLLERR) != <span class="number">0</span> &#123;</span><br><span class="line">			mode += <span class="string">'r'</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> ev.events&amp;(_EPOLLOUT|_EPOLLHUP|_EPOLLERR) != <span class="number">0</span> &#123;</span><br><span class="line">			mode += <span class="string">'w'</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> mode != <span class="number">0</span> &#123;</span><br><span class="line">			<span class="comment">// å–å‡ºä¿å­˜åœ¨ epollevent é‡Œçš„ pollDesc</span></span><br><span class="line">			pd := *(**pollDesc)(unsafe.Pointer(&amp;ev.data))</span><br><span class="line">			pd.everr = <span class="literal">false</span></span><br><span class="line">			<span class="keyword">if</span> ev.events == _EPOLLERR &#123;</span><br><span class="line">				pd.everr = <span class="literal">true</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// è°ƒç”¨ netpollreadyï¼Œä¼ å…¥å°±ç»ª fd çš„ pollDescï¼Œ</span></span><br><span class="line">			<span class="comment">// æŠŠ fd å¯¹åº”çš„ goroutine æ·»åŠ åˆ°é“¾è¡¨ toRun ä¸­</span></span><br><span class="line">			netpollready(&amp;toRun, pd, mode)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> toRun</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Go åœ¨å¤šç§åœºæ™¯ä¸‹éƒ½å¯èƒ½ä¼šè°ƒç”¨ <code>netpoll</code> æ£€æŸ¥æ–‡ä»¶æè¿°ç¬¦çŠ¶æ€ï¼Œ<code>netpoll</code> é‡Œä¼šè°ƒç”¨ <code>epoll_wait</code> ä» epoll çš„ <code>eventpoll.rdllist</code> å°±ç»ªåŒå‘é“¾è¡¨è¿”å›ï¼Œä»è€Œå¾—åˆ° I/O å°±ç»ªçš„ socket fd åˆ—è¡¨ï¼Œå¹¶æ ¹æ®å–å‡ºæœ€åˆè°ƒç”¨ <code>epoll_ctl</code> æ—¶ä¿å­˜çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œæ¢å¤ <code>g</code>ã€‚æ‰€ä»¥æ‰§è¡Œå®Œ<code>netpoll</code> ä¹‹åï¼Œä¼šè¿”å›ä¸€ä¸ªå°±ç»ª fd åˆ—è¡¨å¯¹åº”çš„ goroutine é“¾è¡¨ï¼Œæ¥ä¸‹æ¥å°†å°±ç»ªçš„ goroutine é€šè¿‡è°ƒç”¨ <code>injectglist</code> åŠ å…¥åˆ°å…¨å±€è°ƒåº¦é˜Ÿåˆ—æˆ–è€… P çš„æœ¬åœ°è°ƒåº¦é˜Ÿåˆ—ä¸­ï¼Œå¯åŠ¨ M ç»‘å®š P å»æ‰§è¡Œã€‚</p>
<p>å…·ä½“è°ƒç”¨ <code>netpoll</code> çš„åœ°æ–¹ï¼Œé¦–å…ˆåœ¨ Go runtime scheduler å¾ªç¯è°ƒåº¦ goroutines ä¹‹æ—¶å°±æœ‰å¯èƒ½ä¼šè°ƒç”¨ <code>netpoll</code> è·å–åˆ°å·²å°±ç»ªçš„ fd å¯¹åº”çš„ goroutine æ¥è°ƒåº¦æ‰§è¡Œã€‚</p>
<p>é¦–å…ˆ Go scheduler çš„æ ¸å¿ƒæ–¹æ³• <code>runtime.schedule()</code> é‡Œä¼šè°ƒç”¨ä¸€ä¸ªå« <code>runtime.findrunable()</code> çš„æ–¹æ³•è·å–å¯è¿è¡Œçš„ goroutine æ¥æ‰§è¡Œï¼Œè€Œåœ¨ <code>runtime.findrunable()</code> æ–¹æ³•é‡Œå°±è°ƒç”¨äº† <code>runtime.netpoll</code> è·å–å·²å°±ç»ªçš„ fd åˆ—è¡¨å¯¹åº”çš„ goroutine åˆ—è¡¨ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">func</span> <span class="title">schedule</span><span class="params">()</span></span> &#123;</span><br><span class="line"> ...</span><br><span class="line">   </span><br><span class="line"> <span class="keyword">if</span> gp == <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="comment">// ä»æœ¬åœ°è¿è¡Œé˜Ÿåˆ—å’Œå…¨å±€è¿è¡Œé˜Ÿåˆ—éƒ½æ²¡æœ‰æ‰¾åˆ°éœ€è¦è¿è¡Œçš„ goroutineï¼Œ</span></span><br><span class="line">		<span class="comment">// è°ƒç”¨ findrunnable å‡½æ•°ä»å…¶å®ƒå·¥ä½œçº¿ç¨‹çš„è¿è¡Œé˜Ÿåˆ—ä¸­å·å–ï¼Œå¦‚æœå·ä¸åˆ°ï¼Œåˆ™å½“å‰å·¥ä½œçº¿ç¨‹è¿›å…¥ç¡çœ </span></span><br><span class="line">		<span class="comment">// ç›´åˆ°è·å–åˆ° runnable goroutine ä¹‹å findrunnable å‡½æ•°æ‰ä¼šè¿”å›ã€‚</span></span><br><span class="line"> 		gp, inheritTime = findrunnable() <span class="comment">// blocks until work is available</span></span><br><span class="line"> &#125;</span><br><span class="line">   </span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä»å…¶ä»–åœ°æ–¹æ‰¾ goroutine æ¥æ‰§è¡Œ</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">findrunnable</span><span class="params">()</span> <span class="params">(gp *g, inheritTime <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">	<span class="comment">// å–å½“å‰æŒ‡å‘çš„ gï¼Œä¹Ÿå°±æ˜¯ g0</span></span><br><span class="line">	_g_ := getg()</span><br><span class="line"></span><br><span class="line">top:</span><br><span class="line">	_p_ := _g_.m.p.ptr()</span><br><span class="line">	<span class="keyword">if</span> sched.gcwaiting != <span class="number">0</span> &#123;</span><br><span class="line">		gcstopm()</span><br><span class="line">		<span class="keyword">goto</span> top</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> _p_.runSafePointFn != <span class="number">0</span> &#123;</span><br><span class="line">		runSafePointFn()</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	now, pollUntil, _ := checkTimers(_p_, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> fingwait &amp;&amp; fingwake &#123;</span><br><span class="line">		<span class="keyword">if</span> gp := wakefing(); gp != <span class="literal">nil</span> &#123;</span><br><span class="line">			ready(gp, <span class="number">0</span>, <span class="literal">true</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> *cgo_yield != <span class="literal">nil</span> &#123;</span><br><span class="line">		asmcgocall(*cgo_yield, <span class="literal">nil</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// local runq</span></span><br><span class="line">	<span class="comment">// ä»æœ¬åœ°é˜Ÿåˆ—è·å–</span></span><br><span class="line">	<span class="keyword">if</span> gp, inheritTime := runqget(_p_); gp != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> gp, inheritTime</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// global runq</span></span><br><span class="line">	<span class="comment">// ä»å…¨å±€é˜Ÿåˆ—è·å–</span></span><br><span class="line">	<span class="keyword">if</span> sched.runqsize != <span class="number">0</span> &#123;</span><br><span class="line">		lock(&amp;sched.lock)</span><br><span class="line">		gp := globrunqget(_p_, <span class="number">0</span>)</span><br><span class="line">		unlock(&amp;sched.lock)</span><br><span class="line">		<span class="keyword">if</span> gp != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> gp, <span class="literal">false</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Poll network.</span></span><br><span class="line">	<span class="comment">// This netpoll is only an optimization before we resort to stealing.</span></span><br><span class="line">	<span class="comment">// We can safely skip it if there are no waiters or a thread is blocked</span></span><br><span class="line">	<span class="comment">// in netpoll already. If there is any kind of logical race with that</span></span><br><span class="line">	<span class="comment">// blocked thread (e.g. it has already returned from netpoll, but does</span></span><br><span class="line">	<span class="comment">// not set lastpoll yet), this thread will do blocking netpoll below</span></span><br><span class="line">	<span class="comment">// anyway.</span></span><br><span class="line">	<span class="keyword">if</span> netpollinited() &amp;&amp; atomic.Load(&amp;netpollWaiters) &gt; <span class="number">0</span> &amp;&amp; atomic.Load64(&amp;sched.lastpoll) != <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> list := netpoll(<span class="number">0</span>); !list.empty() &#123; <span class="comment">// non-blocking</span></span><br><span class="line">			gp := list.pop()</span><br><span class="line">			injectglist(&amp;list)</span><br><span class="line">			casgstatus(gp, _Gwaiting, _Grunnable)</span><br><span class="line">			<span class="keyword">if</span> trace.enabled &#123;</span><br><span class="line">				traceGoUnpark(gp, <span class="number">0</span>)</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> gp, <span class="literal">false</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Steal work from other P's.</span></span><br><span class="line">	procs := <span class="keyword">uint32</span>(gomaxprocs)</span><br><span class="line">	ranTimer := <span class="literal">false</span></span><br><span class="line">	<span class="comment">// å¦‚æœæœ‰å¾ˆå¤šå·¥ä½œçº¿ç¨‹åœ¨æ‰¾å·¥ä½œï¼Œé‚£æˆ‘å°±åœä¸‹ä¼‘æ¯ã€‚é¿å…æ¶ˆè€—å¤ªå¤š CPU</span></span><br><span class="line">	<span class="keyword">if</span> !_g_.m.spinning &amp;&amp; <span class="number">2</span>*atomic.Load(&amp;sched.nmspinning) &gt;= procs-atomic.Load(&amp;sched.npidle) &#123;</span><br><span class="line">		<span class="keyword">goto</span> stop</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> !_g_.m.spinning &#123;</span><br><span class="line">		<span class="comment">// è®¾ç½®è‡ªæ—‹çŠ¶æ€ä¸º true</span></span><br><span class="line">		_g_.m.spinning = <span class="literal">true</span></span><br><span class="line">		<span class="comment">// è‡ªæ—‹çŠ¶æ€æ•°åŠ  1</span></span><br><span class="line">		atomic.Xadd(&amp;sched.nmspinning, <span class="number">1</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">const</span> stealTries = <span class="number">4</span></span><br><span class="line">	<span class="comment">// ä»å…¶å®ƒ p çš„æœ¬åœ°è¿è¡Œé˜Ÿåˆ—ç›—å– goroutine</span></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; stealTries; i++ &#123;</span><br><span class="line">		stealTimersOrRunNextG := i == stealTries<span class="number">-1</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> enum := stealOrder.start(fastrand()); !enum.done(); enum.next() &#123;</span><br><span class="line">			<span class="keyword">if</span> sched.gcwaiting != <span class="number">0</span> &#123;</span><br><span class="line">				<span class="keyword">goto</span> top</span><br><span class="line">			&#125;</span><br><span class="line">			p2 := allp[enum.position()]</span><br><span class="line">			<span class="keyword">if</span> _p_ == p2 &#123;</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> stealTimersOrRunNextG &amp;&amp; timerpMask.read(enum.position()) &#123;</span><br><span class="line">				tnow, w, ran := checkTimers(p2, now)</span><br><span class="line">				now = tnow</span><br><span class="line">				<span class="keyword">if</span> w != <span class="number">0</span> &amp;&amp; (pollUntil == <span class="number">0</span> || w &lt; pollUntil) &#123;</span><br><span class="line">					pollUntil = w</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> ran &#123;</span><br><span class="line">					<span class="keyword">if</span> gp, inheritTime := runqget(_p_); gp != <span class="literal">nil</span> &#123;</span><br><span class="line">						<span class="keyword">return</span> gp, inheritTime</span><br><span class="line">					&#125;</span><br><span class="line">					ranTimer = <span class="literal">true</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Don't bother to attempt to steal if p2 is idle.</span></span><br><span class="line">			<span class="keyword">if</span> !idlepMask.read(enum.position()) &#123;</span><br><span class="line">				<span class="keyword">if</span> gp := runqsteal(_p_, p2, stealTimersOrRunNextG); gp != <span class="literal">nil</span> &#123;</span><br><span class="line">					<span class="keyword">return</span> gp, <span class="literal">false</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> ranTimer &#123;</span><br><span class="line">		<span class="comment">// Running a timer may have made some goroutine ready.</span></span><br><span class="line">		<span class="keyword">goto</span> top</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">stop:</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> gcBlackenEnabled != <span class="number">0</span> &amp;&amp; gcMarkWorkAvailable(_p_) &#123;</span><br><span class="line">		node := (*gcBgMarkWorkerNode)(gcBgMarkWorkerPool.pop())</span><br><span class="line">		<span class="keyword">if</span> node != <span class="literal">nil</span> &#123;</span><br><span class="line">			_p_.gcMarkWorkerMode = gcMarkWorkerIdleMode</span><br><span class="line">			gp := node.gp.ptr()</span><br><span class="line">			casgstatus(gp, _Gwaiting, _Grunnable)</span><br><span class="line">			<span class="keyword">if</span> trace.enabled &#123;</span><br><span class="line">				traceGoUnpark(gp, <span class="number">0</span>)</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> gp, <span class="literal">false</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	delta := <span class="keyword">int64</span>(<span class="number">-1</span>)</span><br><span class="line">	<span class="keyword">if</span> pollUntil != <span class="number">0</span> &#123;</span><br><span class="line">		delta = pollUntil - now</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	gp, otherReady := beforeIdle(delta)</span><br><span class="line">	<span class="keyword">if</span> gp != <span class="literal">nil</span> &#123;</span><br><span class="line">		casgstatus(gp, _Gwaiting, _Grunnable)</span><br><span class="line">		<span class="keyword">if</span> trace.enabled &#123;</span><br><span class="line">			traceGoUnpark(gp, <span class="number">0</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> gp, <span class="literal">false</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> otherReady &#123;</span><br><span class="line">		<span class="keyword">goto</span> top</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	allpSnapshot := allp</span><br><span class="line">	idlepMaskSnapshot := idlepMask</span><br><span class="line">	timerpMaskSnapshot := timerpMask</span><br><span class="line"></span><br><span class="line">	<span class="comment">// return P and block</span></span><br><span class="line">	lock(&amp;sched.lock)</span><br><span class="line">	<span class="keyword">if</span> sched.gcwaiting != <span class="number">0</span> || _p_.runSafePointFn != <span class="number">0</span> &#123;</span><br><span class="line">		unlock(&amp;sched.lock)</span><br><span class="line">		<span class="keyword">goto</span> top</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> sched.runqsize != <span class="number">0</span> &#123;</span><br><span class="line">		gp := globrunqget(_p_, <span class="number">0</span>)</span><br><span class="line">		unlock(&amp;sched.lock)</span><br><span class="line">		<span class="keyword">return</span> gp, <span class="literal">false</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// å½“å‰å·¥ä½œçº¿ç¨‹è§£é™¤ä¸ p ä¹‹é—´çš„ç»‘å®šï¼Œå‡†å¤‡å»ä¼‘çœ </span></span><br><span class="line">	<span class="keyword">if</span> releasep() != _p_ &#123;</span><br><span class="line">		throw(<span class="string">"findrunnable: wrong p"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// æŠŠ p æ”¾å…¥ç©ºé—²é˜Ÿåˆ—</span></span><br><span class="line">	pidleput(_p_)</span><br><span class="line">	unlock(&amp;sched.lock)</span><br><span class="line"></span><br><span class="line">	wasSpinning := _g_.m.spinning</span><br><span class="line">	<span class="keyword">if</span> _g_.m.spinning &#123;</span><br><span class="line">		<span class="comment">// m å³å°†ç¡çœ ï¼Œä¸å†å¤„äºè‡ªæ—‹</span></span><br><span class="line">		_g_.m.spinning = <span class="literal">false</span></span><br><span class="line">		<span class="keyword">if</span> <span class="keyword">int32</span>(atomic.Xadd(&amp;sched.nmspinning, <span class="number">-1</span>)) &lt; <span class="number">0</span> &#123;</span><br><span class="line">			throw(<span class="string">"findrunnable: negative nmspinning"</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ä¼‘çœ ä¹‹å‰å†æ£€æŸ¥ä¸€ä¸‹æ‰€æœ‰çš„ pï¼Œçœ‹ä¸€ä¸‹æ˜¯å¦æœ‰å·¥ä½œè¦åš</span></span><br><span class="line">	<span class="keyword">for</span> id, _p_ := <span class="keyword">range</span> allpSnapshot &#123;</span><br><span class="line">		<span class="keyword">if</span> !idlepMaskSnapshot.read(<span class="keyword">uint32</span>(id)) &amp;&amp; !runqempty(_p_) &#123;</span><br><span class="line">			lock(&amp;sched.lock)</span><br><span class="line">			_p_ = pidleget()</span><br><span class="line">			unlock(&amp;sched.lock)</span><br><span class="line">			<span class="keyword">if</span> _p_ != <span class="literal">nil</span> &#123;</span><br><span class="line">				acquirep(_p_)</span><br><span class="line">				<span class="keyword">if</span> wasSpinning &#123;</span><br><span class="line">					_g_.m.spinning = <span class="literal">true</span></span><br><span class="line">					atomic.Xadd(&amp;sched.nmspinning, <span class="number">1</span>)</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">goto</span> top</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> id, _p_ := <span class="keyword">range</span> allpSnapshot &#123;</span><br><span class="line">		<span class="keyword">if</span> timerpMaskSnapshot.read(<span class="keyword">uint32</span>(id)) &#123;</span><br><span class="line">			w := nobarrierWakeTime(_p_)</span><br><span class="line">			<span class="keyword">if</span> w != <span class="number">0</span> &amp;&amp; (pollUntil == <span class="number">0</span> || w &lt; pollUntil) &#123;</span><br><span class="line">				pollUntil = w</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> pollUntil != <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> now == <span class="number">0</span> &#123;</span><br><span class="line">			now = nanotime()</span><br><span class="line">		&#125;</span><br><span class="line">		delta = pollUntil - now</span><br><span class="line">		<span class="keyword">if</span> delta &lt; <span class="number">0</span> &#123;</span><br><span class="line">			delta = <span class="number">0</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> atomic.Load(&amp;gcBlackenEnabled) != <span class="number">0</span> &amp;&amp; gcMarkWorkAvailable(<span class="literal">nil</span>) &#123;</span><br><span class="line">		lock(&amp;sched.lock)</span><br><span class="line">		<span class="keyword">var</span> node *gcBgMarkWorkerNode</span><br><span class="line">		_p_ = pidleget()</span><br><span class="line">		<span class="keyword">if</span> _p_ != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> gcBlackenEnabled != <span class="number">0</span> &#123;</span><br><span class="line">				node = (*gcBgMarkWorkerNode)(gcBgMarkWorkerPool.pop())</span><br><span class="line">				<span class="keyword">if</span> node == <span class="literal">nil</span> &#123;</span><br><span class="line">					pidleput(_p_)</span><br><span class="line">					_p_ = <span class="literal">nil</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				pidleput(_p_)</span><br><span class="line">				_p_ = <span class="literal">nil</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		unlock(&amp;sched.lock)</span><br><span class="line">		<span class="keyword">if</span> _p_ != <span class="literal">nil</span> &#123;</span><br><span class="line">			acquirep(_p_)</span><br><span class="line">			<span class="keyword">if</span> wasSpinning &#123;</span><br><span class="line">				_g_.m.spinning = <span class="literal">true</span></span><br><span class="line">				atomic.Xadd(&amp;sched.nmspinning, <span class="number">1</span>)</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Run the idle worker.</span></span><br><span class="line">			_p_.gcMarkWorkerMode = gcMarkWorkerIdleMode</span><br><span class="line">			gp := node.gp.ptr()</span><br><span class="line">			casgstatus(gp, _Gwaiting, _Grunnable)</span><br><span class="line">			<span class="keyword">if</span> trace.enabled &#123;</span><br><span class="line">				traceGoUnpark(gp, <span class="number">0</span>)</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> gp, <span class="literal">false</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// poll network</span></span><br><span class="line">	<span class="keyword">if</span> netpollinited() &amp;&amp; (atomic.Load(&amp;netpollWaiters) &gt; <span class="number">0</span> || pollUntil != <span class="number">0</span>) &amp;&amp; atomic.Xchg64(&amp;sched.lastpoll, <span class="number">0</span>) != <span class="number">0</span> &#123;</span><br><span class="line">		atomic.Store64(&amp;sched.pollUntil, <span class="keyword">uint64</span>(pollUntil))</span><br><span class="line">		<span class="keyword">if</span> _g_.m.p != <span class="number">0</span> &#123;</span><br><span class="line">			throw(<span class="string">"findrunnable: netpoll with p"</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> _g_.m.spinning &#123;</span><br><span class="line">			throw(<span class="string">"findrunnable: netpoll with spinning"</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> faketime != <span class="number">0</span> &#123;</span><br><span class="line">			delta = <span class="number">0</span></span><br><span class="line">		&#125;</span><br><span class="line">		list := netpoll(delta) <span class="comment">// block until new work is available</span></span><br><span class="line">		atomic.Store64(&amp;sched.pollUntil, <span class="number">0</span>)</span><br><span class="line">		atomic.Store64(&amp;sched.lastpoll, <span class="keyword">uint64</span>(nanotime()))</span><br><span class="line">		<span class="keyword">if</span> faketime != <span class="number">0</span> &amp;&amp; list.empty() &#123;</span><br><span class="line">			stopm()</span><br><span class="line">			<span class="keyword">goto</span> top</span><br><span class="line">		&#125;</span><br><span class="line">		lock(&amp;sched.lock)</span><br><span class="line">		_p_ = pidleget()</span><br><span class="line">		unlock(&amp;sched.lock)</span><br><span class="line">		<span class="keyword">if</span> _p_ == <span class="literal">nil</span> &#123;</span><br><span class="line">			injectglist(&amp;list)</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			acquirep(_p_)</span><br><span class="line">			<span class="keyword">if</span> !list.empty() &#123;</span><br><span class="line">				gp := list.pop()</span><br><span class="line">				injectglist(&amp;list)</span><br><span class="line">				casgstatus(gp, _Gwaiting, _Grunnable)</span><br><span class="line">				<span class="keyword">if</span> trace.enabled &#123;</span><br><span class="line">					traceGoUnpark(gp, <span class="number">0</span>)</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">return</span> gp, <span class="literal">false</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> wasSpinning &#123;</span><br><span class="line">				_g_.m.spinning = <span class="literal">true</span></span><br><span class="line">				atomic.Xadd(&amp;sched.nmspinning, <span class="number">1</span>)</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">goto</span> top</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> pollUntil != <span class="number">0</span> &amp;&amp; netpollinited() &#123;</span><br><span class="line">		pollerPollUntil := <span class="keyword">int64</span>(atomic.Load64(&amp;sched.pollUntil))</span><br><span class="line">		<span class="keyword">if</span> pollerPollUntil == <span class="number">0</span> || pollerPollUntil &gt; pollUntil &#123;</span><br><span class="line">			netpollBreak()</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// ä¼‘çœ </span></span><br><span class="line">	stopm()</span><br><span class="line">	<span class="keyword">goto</span> top</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦å¤–ï¼Œ <code>sysmon</code> ç›‘æ§çº¿ç¨‹ä¼šåœ¨å¾ªç¯è¿‡ç¨‹ä¸­æ£€æŸ¥è·ç¦»ä¸Šä¸€æ¬¡ <code>runtime.netpoll</code> è¢«è°ƒç”¨æ˜¯å¦è¶…è¿‡äº† 10msï¼Œè‹¥æ˜¯åˆ™ä¼šå»è°ƒç”¨å®ƒæ‹¿åˆ°å¯è¿è¡Œçš„ goroutine åˆ—è¡¨å¹¶é€šè¿‡è°ƒç”¨ injectglist æŠŠ g åˆ—è¡¨æ”¾å…¥å…¨å±€è°ƒåº¦é˜Ÿåˆ—æˆ–è€…å½“å‰ P æœ¬åœ°è°ƒåº¦é˜Ÿåˆ—ç­‰å¾…è¢«æ‰§è¡Œï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sysmon</span><span class="params">()</span></span> &#123;</span><br><span class="line">  ...</span><br><span class="line">	lastpoll := <span class="keyword">int64</span>(atomic.Load64(&amp;sched.lastpoll))</span><br><span class="line">		<span class="keyword">if</span> netpollinited() &amp;&amp; lastpoll != <span class="number">0</span> &amp;&amp; lastpoll+<span class="number">10</span>*<span class="number">1000</span>*<span class="number">1000</span> &lt; now &#123;</span><br><span class="line">			atomic.Cas64(&amp;sched.lastpoll, <span class="keyword">uint64</span>(lastpoll), <span class="keyword">uint64</span>(now))</span><br><span class="line">			list := netpoll(<span class="number">0</span>) <span class="comment">// non-blocking - returns list of goroutines</span></span><br><span class="line">			<span class="keyword">if</span> !list.empty() &#123;</span><br><span class="line">				incidlelocked(<span class="number">-1</span>)</span><br><span class="line">				injectglist(&amp;list)</span><br><span class="line">				incidlelocked(<span class="number">1</span>)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Go runtime åœ¨ç¨‹åºå¯åŠ¨çš„æ—¶å€™ä¼šåˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„ M ä½œä¸ºç›‘æ§çº¿ç¨‹ï¼Œå« <code>sysmon</code> ï¼Œè¿™ä¸ªçº¿ç¨‹ä¸ºç³»ç»Ÿçº§çš„ daemon çº¿ç¨‹ï¼Œæ— éœ€ P å³å¯è¿è¡Œï¼Œ <code>sysmon</code> æ¯ 20us~10ms è¿è¡Œä¸€æ¬¡ã€‚ <code>sysmon</code> ä¸­ä»¥è½®è¯¢çš„æ–¹å¼æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</p>
<blockquote>
<ol>
<li>ä»¥éé˜»å¡çš„æ–¹å¼è°ƒç”¨ <code>runtime.netpoll</code> ï¼Œä»ä¸­æ‰¾å‡ºèƒ½ä»ç½‘ç»œ I/O ä¸­å”¤é†’çš„ g åˆ—è¡¨ï¼Œå¹¶é€šè¿‡è°ƒç”¨ injectglist æŠŠ g åˆ—è¡¨æ”¾å…¥å…¨å±€è°ƒåº¦é˜Ÿåˆ—æˆ–è€…å½“å‰ P æœ¬åœ°è°ƒåº¦é˜Ÿåˆ—ç­‰å¾…è¢«æ‰§è¡Œï¼Œè°ƒåº¦è§¦å‘æ—¶ï¼Œæœ‰å¯èƒ½ä»è¿™ä¸ªå…¨å±€ runnable è°ƒåº¦é˜Ÿåˆ—è·å– gã€‚ç„¶åå†å¾ªç¯è°ƒç”¨ <code>startm</code> ï¼Œç›´åˆ°æ‰€æœ‰ P éƒ½ä¸å¤„äº <code>_Pidle</code> çŠ¶æ€ã€‚</li>
<li>è°ƒç”¨ <code>retake</code> ï¼ŒæŠ¢å é•¿æ—¶é—´å¤„äº <code>_Psyscall</code> çŠ¶æ€çš„ Pã€‚</li>
</ol>
</blockquote>
<p>ç»¼ä¸Šï¼ŒGo å€ŸåŠ©äº epoll å’Œ runtime scheduler ç­‰çš„å¸®åŠ©ï¼Œè®¾è®¡å‡ºäº†è‡ªå·±çš„ I/O å¤šè·¯å¤ç”¨ netpollerï¼ŒæˆåŠŸåœ°è®© <code>Listener.Accept</code> / <code>conn.Read</code> / <code>conn.Write</code> ç­‰æ–¹æ³•ä»å¼€å‘è€…çš„è§’åº¦çœ‹æ¥æ˜¯åŒæ­¥æ¨¡å¼ã€‚</p>
<h2 id="Go-netpoller-è®¾è®¡ç‰¹ç‚¹"><a href="#Go-netpoller-è®¾è®¡ç‰¹ç‚¹" class="headerlink" title="Go netpoller è®¾è®¡ç‰¹ç‚¹"></a>Go netpoller è®¾è®¡ç‰¹ç‚¹</h2><p>é€šè¿‡å‰é¢å¯¹æºç çš„åˆ†æï¼Œæˆ‘ä»¬ç°åœ¨çŸ¥é“ Go netpoller ä¾æ‰˜äº runtime schedulerï¼Œä¸ºå¼€å‘è€…æä¾›äº†ä¸€ç§å¼ºå¤§çš„åŒæ­¥ç½‘ç»œç¼–ç¨‹æ¨¡å¼ï¼›ç„¶è€Œï¼ŒGo netpoller å­˜åœ¨çš„æ„ä¹‰å´è¿œä¸æ­¢äºæ­¤ï¼ŒGo netpoller I/O å¤šè·¯å¤ç”¨æ­é… Non-blocking I/O è€Œæ‰“é€ å‡ºæ¥çš„è¿™ä¸ªåŸç”Ÿç½‘ç»œæ¨¡å‹ï¼Œå®ƒæœ€å¤§çš„ä»·å€¼æ˜¯æŠŠç½‘ç»œ I/O çš„æ§åˆ¶æƒç‰¢ç‰¢æŒæ¡åœ¨ Go è‡ªå·±çš„ runtime é‡Œã€‚</p>
<p>G åœ¨è¿è¡Œè¿‡ç¨‹ä¸­å¦‚æœè¢«é˜»å¡åœ¨æŸä¸ª system call æ“ä½œä¸Šï¼Œé‚£ä¹ˆä¸å…‰ G ä¼šé˜»å¡ï¼Œæ‰§è¡Œè¯¥ G çš„ M ä¹Ÿä¼šè§£ç»‘ P(å®è´¨æ˜¯è¢« sysmon æŠ¢èµ°äº†)ï¼Œä¸ G ä¸€èµ·è¿›å…¥ sleep çŠ¶æ€ã€‚å¦‚æœæ­¤æ—¶æœ‰ idle çš„ Mï¼Œåˆ™ P ä¸å…¶ç»‘å®šç»§ç»­æ‰§è¡Œå…¶ä»– Gï¼›å¦‚æœæ²¡æœ‰ idle Mï¼Œä½†ä»ç„¶æœ‰å…¶ä»– G è¦å»æ‰§è¡Œï¼Œé‚£ä¹ˆå°±ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ Mã€‚å½“é˜»å¡åœ¨ system call ä¸Šçš„ G å®Œæˆ syscall è°ƒç”¨åï¼ŒG ä¼šå»å°è¯•è·å–ä¸€ä¸ªå¯ç”¨çš„ Pï¼Œå¦‚æœæ²¡æœ‰å¯ç”¨çš„ Pï¼Œé‚£ä¹ˆ G ä¼šè¢«æ ‡è®°ä¸º <code>_Grunnable</code> å¹¶æŠŠå®ƒæ”¾å…¥å…¨å±€çš„ runqueue ä¸­ç­‰å¾…è°ƒåº¦ï¼Œä¹‹å‰çš„é‚£ä¸ª sleep çš„ M å°†å†æ¬¡è¿›å…¥ sleepã€‚</p>
<p>ç°åœ¨æ¸…æ¥šä¸ºä»€ä¹ˆ netpoll ä¸ºä»€ä¹ˆä¸€å®šè¦ä½¿ç”¨éé˜»å¡ I/O äº†å§ï¼Ÿå°±æ˜¯ä¸ºäº†é¿å…è®©æ“ä½œç½‘ç»œ I/O çš„ goroutine é™·å…¥åˆ°ç³»ç»Ÿè°ƒç”¨ä»è€Œè¿›å…¥å†…æ ¸æ€ï¼Œå› ä¸ºä¸€æ—¦è¿›å…¥å†…æ ¸æ€ï¼Œæ•´ä¸ªç¨‹åºçš„æ§åˆ¶æƒå°±ä¼šå‘ç”Ÿè½¬ç§»(åˆ°å†…æ ¸)ï¼Œä¸å†å±äºç”¨æˆ·è¿›ç¨‹äº†ï¼Œé‚£ä¹ˆä¹Ÿå°±æ— æ³•å€ŸåŠ©äº Go å¼ºå¤§çš„ runtime scheduler æ¥è°ƒåº¦ä¸šåŠ¡ç¨‹åºçš„å¹¶å‘äº†ï¼›è€Œæœ‰äº† netpoll ä¹‹åï¼Œå€ŸåŠ©äºéé˜»å¡ I/O ï¼ŒG å°±å†ä¹Ÿä¸ä¼šå› ä¸ºç³»ç»Ÿè°ƒç”¨çš„è¯»å†™è€Œ (é•¿æ—¶é—´) é™·å…¥å†…æ ¸æ€ï¼Œå½“ G è¢«é˜»å¡åœ¨æŸä¸ª network I/O æ“ä½œä¸Šæ—¶ï¼Œå®é™…ä¸Šå®ƒä¸æ˜¯å› ä¸ºé™·å…¥å†…æ ¸æ€è¢«é˜»å¡ä½äº†ï¼Œè€Œæ˜¯è¢« Go runtime è°ƒç”¨ gopark ç»™ park ä½äº†ï¼Œæ­¤æ—¶ G ä¼šè¢«æ”¾ç½®åˆ°æŸä¸ª wait queue ä¸­ï¼Œè€Œ M ä¼šå°è¯•è¿è¡Œä¸‹ä¸€ä¸ª <code>_Grunnable</code> çš„ Gï¼Œå¦‚æœæ­¤æ—¶æ²¡æœ‰ <code>_Grunnable</code> çš„ G ä¾› M è¿è¡Œï¼Œé‚£ä¹ˆ M å°†è§£ç»‘ Pï¼Œå¹¶è¿›å…¥ sleep çŠ¶æ€ã€‚å½“ I/O availableï¼Œåœ¨ epoll çš„ <code>eventpoll.rdr</code> ä¸­ç­‰å¾…çš„ G ä¼šè¢«æ”¾åˆ° <code>eventpoll.rdllist</code> é“¾è¡¨é‡Œå¹¶é€šè¿‡ <code>netpoll</code> ä¸­çš„ <code>epoll_wait</code> ç³»ç»Ÿè°ƒç”¨è¿”å›æ”¾ç½®åˆ°å…¨å±€è°ƒåº¦é˜Ÿåˆ—æˆ–è€… P çš„æœ¬åœ°è°ƒåº¦é˜Ÿåˆ—ï¼Œæ ‡è®°ä¸º <code>_Grunnable</code> ï¼Œç­‰å¾… P ç»‘å®š M æ¢å¤æ‰§è¡Œã€‚</p>
<h2 id="Go-netpoller-é—®é¢˜"><a href="#Go-netpoller-é—®é¢˜" class="headerlink" title="Go netpoller é—®é¢˜"></a>Go netpoller é—®é¢˜</h2><p>Go netpoller çš„è®¾è®¡ä¸å¯è°“ä¸ç²¾å·§ã€æ€§èƒ½ä¹Ÿä¸å¯è°“ä¸é«˜ã€‚å› æ­¤ Go çš„ç½‘ç»œç¼–ç¨‹æ¨¡å¼æ˜¯åŠå…¶ç®€æ´é«˜æ•ˆçš„ï¼Œç„¶è€Œï¼Œæ²¡æœ‰ä»»ä½•ä¸€ç§è®¾è®¡å’Œæ¶æ„æ˜¯å®Œç¾çš„ï¼Œ <code>goroutine-per-connection</code> è¿™ç§æ¨¡å¼è™½ç„¶ç®€å•é«˜æ•ˆï¼Œä½†æ˜¯åœ¨æŸäº›æç«¯çš„åœºæ™¯ä¸‹ä¹Ÿä¼šæš´éœ²å‡ºé—®é¢˜ï¼šgoroutine è™½ç„¶éå¸¸è½»é‡ï¼Œå®ƒçš„è‡ªå®šä¹‰æ ˆå†…å­˜åˆå§‹å€¼ä»…ä¸º 2KBï¼Œåé¢æŒ‰éœ€æ‰©å®¹ï¼›æµ·é‡è¿æ¥çš„ä¸šåŠ¡åœºæ™¯ä¸‹ï¼Œ <code>goroutine-per-connection</code> ï¼Œæ­¤æ—¶ goroutine æ•°é‡ä»¥åŠæ¶ˆè€—çš„èµ„æºå°±ä¼šå‘ˆçº¿æ€§è¶‹åŠ¿æš´æ¶¨ï¼Œè™½ç„¶ Go scheduler å†…éƒ¨åšäº† g çš„ç¼“å­˜é“¾è¡¨ï¼Œå¯ä»¥ä¸€å®šç¨‹åº¦ä¸Šç¼“è§£é«˜é¢‘åˆ›å»ºé”€æ¯ goroutine çš„å‹åŠ›ï¼Œä½†æ˜¯å¯¹äºç¬æ—¶æ€§æš´æ¶¨çš„é•¿è¿æ¥åœºæ™¯å°±æ— èƒ½ä¸ºåŠ›äº†ï¼Œå¤§é‡çš„ goroutines ä¼šè¢«ä¸æ–­åˆ›å»ºå‡ºæ¥ï¼Œä»è€Œå¯¹ Go runtime scheduler é€ æˆæå¤§çš„è°ƒåº¦å‹åŠ›å’Œä¾µå ç³»ç»Ÿèµ„æºï¼Œç„¶åèµ„æºè¢«ä¾µå åˆåè¿‡æ¥å½±å“ Go scheduler çš„è°ƒåº¦ï¼Œè¿›è€Œå¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚</p>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ol>
<li><a href="https://strikefreedom.top/go-netpoll-io-multiplexing-reactor" target="_blank" rel="noopener">strikefreedom.top blog</a></li>
<li><a href="https://morsmachine.dk/netpoller" target="_blank" rel="noopener">morsingå¤§ç¥</a></li>
<li><a href="https://devarea.com/linux-io-multiplexing-select-vs-poll-vs-epoll/#.YSWyGdMzZAb" target="_blank" rel="noopener">devarea.com I/Oå¤šè·¯å¤ç”¨</a></li>
<li><a href="https://draveness.me/golang/docs/part3-runtime/ch06-concurrency/golang-netpoller/" target="_blank" rel="noopener">Drabness blog</a></li>
</ol>

      
    </div>
    
    
    

    <div>
      
        <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------æœ¬æ–‡ç»“æŸ<i class="fa fa-paw"></i>æ„Ÿè°¢æ‚¨çš„é˜…è¯»-------------</div>
    
</div>

      
    </div>

    <div>
          
            
<div class="my_post_copyright">
  <script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>

  <!-- JSåº“ sweetalert å¯ä¿®æ”¹è·¯å¾„ -->
  <script src="https://cdn.bootcss.com/jquery/2.0.0/jquery.min.js"></script>
  <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
  <p><span>æœ¬æ–‡æ ‡é¢˜:</span><a href="/2021/08/24/IOMultiplexing/">æ·±å…¥ç†è§£Golangç½‘ç»œè½®è¯¢å™¨NetPoller</a></p>
  <p><span>æ–‡ç« ä½œè€…:</span><a href="/" title="è®¿é—® Wxning çš„ä¸ªäººåšå®¢">Wxning</a></p>
  <p><span>å‘å¸ƒæ—¶é—´:</span>2021å¹´08æœˆ24æ—¥ - 17:08</p>
  <p><span>æœ€åæ›´æ–°:</span>2021å¹´08æœˆ30æ—¥ - 17:08</p>
  <p><span>åŸå§‹é“¾æ¥:</span><a href="/2021/08/24/IOMultiplexing/" title="æ·±å…¥ç†è§£Golangç½‘ç»œè½®è¯¢å™¨NetPoller">http://yoursite.com/2021/08/24/IOMultiplexing/</a>
    <span class="copy-path" title="ç‚¹å‡»å¤åˆ¶æ–‡ç« é“¾æ¥"><i class="fa fa-clipboard" data-clipboard-text="http://yoursite.com/2021/08/24/IOMultiplexing/" aria-label="å¤åˆ¶æˆåŠŸï¼"></i></span>
  </p>
  <p><span>è®¸å¯åè®®:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç¦æ­¢æ¼”ç» 4.0 å›½é™…</a> è½¬è½½è¯·ä¿ç•™åŸæ–‡é“¾æ¥åŠä½œè€…ã€‚</p>
</div>
<script>
    var clipboard = new Clipboard('.fa-clipboard');
    $(".fa-clipboard").click(function(){
      clipboard.on('success', function(){
        swal({
          title: "",
          text: 'å¤åˆ¶æˆåŠŸ',
          icon: "success",
          showConfirmButton: true
          });
    });
    });
</script>


          
    </div>

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/golang/" rel="tag"># golang</a>
          
            <a href="/tags/golang-source/" rel="tag"># golang source</a>
          
            <a href="/tags/network/" rel="tag"># network</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2021/04/28/channel/" rel="next" title="æ·±å…¥ç†è§£ channel">
                <i class="fa fa-chevron-left"></i> æ·±å…¥ç†è§£ channel
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2021/09/13/trace/" rel="prev" title="åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ª">
                åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ª <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="lv-container" data-id="city" data-uid="MTAyMC80NTE2Ny8yMTY4NA=="></div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            æ–‡ç« ç›®å½•
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            ç«™ç‚¹æ¦‚è§ˆ
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.gif" alt="Wxning">
            
              <p class="site-author-name" itemprop="name">Wxning</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">41</span>
                  <span class="site-state-item-name">æ—¥å¿—</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">42</span>
                  <span class="site-state-item-name">åˆ†ç±»</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">35</span>
                  <span class="site-state-item-name">æ ‡ç­¾</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/wxning1107" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#é˜»å¡I-Oä¸éé˜»å¡I-O"><span class="nav-number">1.</span> <span class="nav-text">é˜»å¡I/Oä¸éé˜»å¡I/O</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#I-Oå¤šè·¯å¤ç”¨"><span class="nav-number">2.</span> <span class="nav-text">I/Oå¤šè·¯å¤ç”¨</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#select-amp-poll"><span class="nav-number">3.</span> <span class="nav-text">select &amp; poll</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#epoll"><span class="nav-number">4.</span> <span class="nav-text">epoll</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#go-netPoller"><span class="nav-number">5.</span> <span class="nav-text">go netPoller</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ç½‘ç»œè½®è¯¢å™¨æ¥å£"><span class="nav-number">6.</span> <span class="nav-text">ç½‘ç»œè½®è¯¢å™¨æ¥å£</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#æ•°æ®ç»“æ„"><span class="nav-number">7.</span> <span class="nav-text">æ•°æ®ç»“æ„</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å®ç°åŸç†"><span class="nav-number">8.</span> <span class="nav-text">å®ç°åŸç†</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#åˆå§‹åŒ–"><span class="nav-number">9.</span> <span class="nav-text">åˆå§‹åŒ–</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#park-goroutine"><span class="nav-number">10.</span> <span class="nav-text">park goroutine</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#epoll-wait-â€”â€”-netpoll"><span class="nav-number">11.</span> <span class="nav-text">epoll_wait â€”â€” netpoll</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Go-netpoller-è®¾è®¡ç‰¹ç‚¹"><span class="nav-number">12.</span> <span class="nav-text">Go netpoller è®¾è®¡ç‰¹ç‚¹</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Go-netpoller-é—®é¢˜"><span class="nav-number">13.</span> <span class="nav-text">Go netpoller é—®é¢˜</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å‚è€ƒèµ„æ–™"><span class="nav-number">14.</span> <span class="nav-text">å‚è€ƒèµ„æ–™</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Wxning</span>

  
</div>


  <div class="powered-by">ç”± <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> å¼ºåŠ›é©±åŠ¨</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">ä¸»é¢˜ &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i> è®¿é—®äººæ•°
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      äºº
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i> æ€»è®¿é—®é‡
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      æ¬¡
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  












  





  

  

  

  
  

  

  

  

</body>
</html>
