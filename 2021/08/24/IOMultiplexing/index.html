<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="golang,golang source,network,">










<meta name="description" content="æ“ä½œç³»ç»Ÿä¸Šçš„ I/O æ˜¯ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´çš„æ•°æ®äº¤äº’ï¼Œé€šå¸¸åŒ…å«ä»¥ä¸‹ä¸¤ä¸ªæ­¥éª¤ï¼š   ç­‰å¾…ç½‘ç»œæ•°æ®åˆ°è¾¾ç½‘å¡(è¯»å°±ç»ª)/ç­‰å¾…ç½‘å¡å¯å†™(å†™å°±ç»ª) â€“&amp;gt; è¯»å–/å†™å…¥åˆ°å†…æ ¸ç¼“å†²åŒº ä»å†…æ ¸ç¼“å†²åŒºå¤åˆ¶æ•°æ® â€“&amp;gt; ç”¨æˆ·ç©ºé—´(è¯»)/ä»ç”¨æˆ·ç©ºé—´å¤åˆ¶æ•°æ® -&amp;gt; å†…æ ¸ç¼“å†²åŒº(å†™)   è€Œåˆ¤å®šä¸€ä¸ª I/O æ¨¡å‹æ˜¯åŒæ­¥è¿˜æ˜¯å¼‚æ­¥ï¼Œä¸»è¦çœ‹ç¬¬äºŒæ­¥ï¼šæ•°æ®åœ¨ç”¨æˆ·å’Œå†…æ ¸ç©ºé—´ä¹‹é—´å¤åˆ¶çš„æ—¶å€™æ˜¯ä¸æ˜¯ä¼šé˜»å¡å½“å‰è¿›ç¨‹ï¼Œå¦‚æœä¼šï¼Œåˆ™æ˜¯">
<meta name="keywords" content="golang,golang source,network">
<meta property="og:type" content="article">
<meta property="og:title" content="æ·±å…¥ç†è§£Golangç½‘ç»œè½®è¯¢å™¨NetPoller">
<meta property="og:url" content="http://yoursite.com/2021/08/24/IOMultiplexing/index.html">
<meta property="og:site_name" content="Wxning">
<meta property="og:description" content="æ“ä½œç³»ç»Ÿä¸Šçš„ I/O æ˜¯ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´çš„æ•°æ®äº¤äº’ï¼Œé€šå¸¸åŒ…å«ä»¥ä¸‹ä¸¤ä¸ªæ­¥éª¤ï¼š   ç­‰å¾…ç½‘ç»œæ•°æ®åˆ°è¾¾ç½‘å¡(è¯»å°±ç»ª)/ç­‰å¾…ç½‘å¡å¯å†™(å†™å°±ç»ª) â€“&amp;gt; è¯»å–/å†™å…¥åˆ°å†…æ ¸ç¼“å†²åŒº ä»å†…æ ¸ç¼“å†²åŒºå¤åˆ¶æ•°æ® â€“&amp;gt; ç”¨æˆ·ç©ºé—´(è¯»)/ä»ç”¨æˆ·ç©ºé—´å¤åˆ¶æ•°æ® -&amp;gt; å†…æ ¸ç¼“å†²åŒº(å†™)   è€Œåˆ¤å®šä¸€ä¸ª I/O æ¨¡å‹æ˜¯åŒæ­¥è¿˜æ˜¯å¼‚æ­¥ï¼Œä¸»è¦çœ‹ç¬¬äºŒæ­¥ï¼šæ•°æ®åœ¨ç”¨æˆ·å’Œå†…æ ¸ç©ºé—´ä¹‹é—´å¤åˆ¶çš„æ—¶å€™æ˜¯ä¸æ˜¯ä¼šé˜»å¡å½“å‰è¿›ç¨‹ï¼Œå¦‚æœä¼šï¼Œåˆ™æ˜¯">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://yoursite.com/images/io-1.png">
<meta property="og:image" content="http://yoursite.com/images/io-2.png">
<meta property="og:updated_time" content="2021-08-26T06:09:08.057Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="æ·±å…¥ç†è§£Golangç½‘ç»œè½®è¯¢å™¨NetPoller">
<meta name="twitter:description" content="æ“ä½œç³»ç»Ÿä¸Šçš„ I/O æ˜¯ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´çš„æ•°æ®äº¤äº’ï¼Œé€šå¸¸åŒ…å«ä»¥ä¸‹ä¸¤ä¸ªæ­¥éª¤ï¼š   ç­‰å¾…ç½‘ç»œæ•°æ®åˆ°è¾¾ç½‘å¡(è¯»å°±ç»ª)/ç­‰å¾…ç½‘å¡å¯å†™(å†™å°±ç»ª) â€“&amp;gt; è¯»å–/å†™å…¥åˆ°å†…æ ¸ç¼“å†²åŒº ä»å†…æ ¸ç¼“å†²åŒºå¤åˆ¶æ•°æ® â€“&amp;gt; ç”¨æˆ·ç©ºé—´(è¯»)/ä»ç”¨æˆ·ç©ºé—´å¤åˆ¶æ•°æ® -&amp;gt; å†…æ ¸ç¼“å†²åŒº(å†™)   è€Œåˆ¤å®šä¸€ä¸ª I/O æ¨¡å‹æ˜¯åŒæ­¥è¿˜æ˜¯å¼‚æ­¥ï¼Œä¸»è¦çœ‹ç¬¬äºŒæ­¥ï¼šæ•°æ®åœ¨ç”¨æˆ·å’Œå†…æ ¸ç©ºé—´ä¹‹é—´å¤åˆ¶çš„æ—¶å€™æ˜¯ä¸æ˜¯ä¼šé˜»å¡å½“å‰è¿›ç¨‹ï¼Œå¦‚æœä¼šï¼Œåˆ™æ˜¯">
<meta name="twitter:image" content="http://yoursite.com/images/io-1.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'åšä¸»'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2021/08/24/IOMultiplexing/">





  <title>æ·±å…¥ç†è§£Golangç½‘ç»œè½®è¯¢å™¨NetPoller | Wxning</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>
    <a href="https://github.com/wxning1107" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewbox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Wxning</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            é¦–é¡µ
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            æ ‡ç­¾
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            åˆ†ç±»
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            å½’æ¡£
          </a>
        </li>
      
        
        <li class="menu-item menu-item-ä¸ªäººç®€å†">
          <a href="/ä¸ªäººç®€å†/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            ä¸ªäººç®€å†
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/08/24/IOMultiplexing/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Wxning">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wxning">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">æ·±å…¥ç†è§£Golangç½‘ç»œè½®è¯¢å™¨NetPoller</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2021-08-24T17:10:59+08:00">
                2021-08-24
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/golang-è®¡ç®—æœºç½‘ç»œ/" itemprop="url" rel="index">
                    <span itemprop="name">golang - è®¡ç®—æœºç½‘ç»œ</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i> é˜…è¯»æ•°
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>æ¬¡
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>æ“ä½œç³»ç»Ÿä¸Šçš„ I/O æ˜¯ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´çš„æ•°æ®äº¤äº’ï¼Œé€šå¸¸åŒ…å«ä»¥ä¸‹ä¸¤ä¸ªæ­¥éª¤ï¼š</p>
<blockquote>
<ol>
<li>ç­‰å¾…ç½‘ç»œæ•°æ®åˆ°è¾¾ç½‘å¡(è¯»å°±ç»ª)/ç­‰å¾…ç½‘å¡å¯å†™(å†™å°±ç»ª) â€“&gt; è¯»å–/å†™å…¥åˆ°å†…æ ¸ç¼“å†²åŒº</li>
<li>ä»å†…æ ¸ç¼“å†²åŒºå¤åˆ¶æ•°æ® â€“&gt; ç”¨æˆ·ç©ºé—´(è¯»)/ä»ç”¨æˆ·ç©ºé—´å¤åˆ¶æ•°æ® -&gt; å†…æ ¸ç¼“å†²åŒº(å†™)</li>
</ol>
</blockquote>
<p>è€Œåˆ¤å®šä¸€ä¸ª I/O æ¨¡å‹æ˜¯åŒæ­¥è¿˜æ˜¯å¼‚æ­¥ï¼Œä¸»è¦çœ‹ç¬¬äºŒæ­¥ï¼šæ•°æ®åœ¨ç”¨æˆ·å’Œå†…æ ¸ç©ºé—´ä¹‹é—´å¤åˆ¶çš„æ—¶å€™æ˜¯ä¸æ˜¯ä¼šé˜»å¡å½“å‰è¿›ç¨‹ï¼Œå¦‚æœä¼šï¼Œåˆ™æ˜¯åŒæ­¥ I/Oï¼Œå¦åˆ™ï¼Œå°±æ˜¯å¼‚æ­¥ I/Oã€‚</p>
<h2 id="é˜»å¡I-Oä¸éé˜»å¡I-O"><a href="#é˜»å¡I-Oä¸éé˜»å¡I-O" class="headerlink" title="é˜»å¡I/Oä¸éé˜»å¡I/O"></a>é˜»å¡I/Oä¸éé˜»å¡I/O</h2><p>å½“æˆ‘ä»¬é€šè¿‡ <code>read</code> æˆ–è€… <code>write</code> ç­‰ç³»ç»Ÿè°ƒç”¨è¯»å†™æ–‡ä»¶æˆ–è€…ç½‘ç»œæ—¶ï¼Œåº”ç”¨ç¨‹åºä¼šè¢«é˜»å¡ï¼Œå½“æˆ‘ä»¬æ‰§è¡Œ <code>read</code> ç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œåº”ç”¨ç¨‹åºä¼šä»ç”¨æˆ·æ€é™·å…¥å†…æ ¸æ€ï¼Œå†…æ ¸ä¼šæ£€æŸ¥æ–‡ä»¶æè¿°ç¬¦æ˜¯å¦å¯è¯»ï¼Œå½“æ–‡ä»¶æè¿°ç¬¦ä¸­å­˜åœ¨æ•°æ®æ—¶ï¼Œæ“ä½œç³»ç»Ÿå†…æ ¸ä¼šå°†å‡†å¤‡å¥½çš„æ•°æ®æ‹·è´ç»™åº”ç”¨ç¨‹åºå¹¶äº¤å›æ§åˆ¶æƒã€‚</p>
<p>éé˜»å¡I/Oå°±æ˜¯æ‰€æœ‰ I/O æ“ä½œéƒ½æ˜¯ç«‹åˆ»è¿”å›è€Œä¸ä¼šé˜»å¡å½“å‰ç”¨æˆ·è¿›ç¨‹ï¼Œå½“è¿›ç¨‹æŠŠä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦è®¾ç½®æˆéé˜»å¡æ—¶ï¼Œæ‰§è¡Œ <code>read</code> å’Œ <code>write</code> ç­‰ I/O æ“ä½œä¼šç«‹åˆ»è¿”å›ï¼Œä¸‹é¢æ˜¯Cè¯­è¨€ä»£ç ï¼Œ<a href="https://github.com/torvalds/linux/blob/f757165705e92db62f85a1ad287e9251d1f2cd82/fs/fcntl.c#L448" target="_blank" rel="noopener"><code>fcntl</code></a> ä¸ºæˆ‘ä»¬æä¾›äº†æ“ä½œæ–‡ä»¶æè¿°ç¬¦çš„èƒ½åŠ›ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å®ƒä¿®æ”¹æ–‡ä»¶æè¿°ç¬¦çš„ç‰¹æ€§ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> flags = fcntl(fd, F_GETFL, <span class="number">0</span>);</span><br><span class="line">fcntl(fd, F_SETFL, flags | O_NONBLOCK);</span><br></pre></td></tr></table></figure>

<p>å½“æˆ‘ä»¬å°†æ–‡ä»¶æè¿°ç¬¦ä¿®æ”¹æˆéé˜»å¡åï¼Œè¯»å†™æ–‡ä»¶ä¼šç»å†ä»¥ä¸‹æµç¨‹ï¼š</p>
<p><img src="/images/io-1.png" alt="io"></p>
<p>å¦‚æœ kernel ä¸­çš„æ•°æ®è¿˜æ²¡æœ‰å‡†å¤‡å¥½ï¼Œé‚£ä¹ˆå®ƒå¹¶ä¸ä¼š block ç”¨æˆ·è¿›ç¨‹ï¼Œè€Œæ˜¯ç«‹åˆ»è¿”å›ä¸€ä¸ª <code>EAGAIN</code> errorï¼Œ<code>EAGAIN</code> æ„å‘³ç€è¯¥æ–‡ä»¶æè¿°ç¬¦è¿˜åœ¨ç­‰å¾…ç¼“å†²åŒºä¸­çš„æ•°æ®ï¼Œéšåï¼Œåº”ç”¨ç¨‹åºä¼šä¸æ–­è½®è¯¢è°ƒç”¨ <code>read</code> ç›´åˆ°å®ƒçš„è¿”å›å€¼å¤§äº 0ï¼Œè¿™æ—¶åº”ç”¨ç¨‹åºå°±å¯ä»¥å¯¹è¯»å–æ“ä½œç³»ç»Ÿç¼“å†²åŒºä¸­çš„æ•°æ®å¹¶è¿›è¡Œæ“ä½œã€‚ä»ç”¨æˆ·è¿›ç¨‹è§’åº¦è®² ï¼Œå®ƒå‘èµ·ä¸€ä¸ª read æ“ä½œåï¼Œå¹¶ä¸éœ€è¦ç­‰å¾…ï¼Œè€Œæ˜¯é©¬ä¸Šå°±å¾—åˆ°äº†ä¸€ä¸ªç»“æœã€‚ç”¨æˆ·è¿›ç¨‹åˆ¤æ–­ç»“æœæ˜¯ä¸€ä¸ª error æ—¶ï¼Œå®ƒå°±çŸ¥é“æ•°æ®è¿˜æ²¡æœ‰å‡†å¤‡å¥½ï¼Œäºæ˜¯å®ƒå¯ä»¥å†æ¬¡å‘é€ read æ“ä½œã€‚ä¸€æ—¦ kernel ä¸­çš„æ•°æ®å‡†å¤‡å¥½äº†ï¼Œå¹¶ä¸”åˆå†æ¬¡æ”¶åˆ°äº†ç”¨æˆ·è¿›ç¨‹çš„ system callï¼Œé‚£ä¹ˆå®ƒé©¬ä¸Šå°±å°†æ•°æ®æ‹·è´åˆ°äº†ç”¨æˆ·å†…å­˜ï¼Œç„¶åè¿”å›ã€‚è¿›ç¨‹ä½¿ç”¨éé˜»å¡çš„ I/O æ“ä½œæ—¶ï¼Œå¯ä»¥åœ¨ç­‰å¾…è¿‡ç¨‹ä¸­æ‰§è¡Œå…¶ä»–ä»»åŠ¡ï¼Œæé«˜ CPU çš„åˆ©ç”¨ç‡ã€‚</p>
<h2 id="I-Oå¤šè·¯å¤ç”¨"><a href="#I-Oå¤šè·¯å¤ç”¨" class="headerlink" title="I/Oå¤šè·¯å¤ç”¨"></a>I/Oå¤šè·¯å¤ç”¨</h2><p><strong>æ‰€è°“ I/O å¤šè·¯å¤ç”¨æŒ‡çš„å°±æ˜¯ select/poll/epoll è¿™ä¸€ç³»åˆ—çš„å¤šè·¯é€‰æ‹©å™¨ï¼šæ”¯æŒå•ä¸€çº¿ç¨‹åŒæ—¶ç›‘å¬å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼ˆI/O äº‹ä»¶ï¼‰ï¼Œé˜»å¡ç­‰å¾…ï¼Œå¹¶åœ¨å…¶ä¸­æŸä¸ªæ–‡ä»¶æè¿°ç¬¦å¯è¯»å†™æ—¶æ”¶åˆ°é€šçŸ¥ã€‚ I/O å¤ç”¨å…¶å®å¤ç”¨çš„ä¸æ˜¯ I/O è¿æ¥ï¼Œè€Œæ˜¯å¤ç”¨çº¿ç¨‹ï¼Œè®©ä¸€ä¸ª thread of control èƒ½å¤Ÿå¤„ç†å¤šä¸ªè¿æ¥ï¼ˆI/O äº‹ä»¶ï¼‰ã€‚</strong></p>
<h2 id="select-amp-poll"><a href="#select-amp-poll" class="headerlink" title="select &amp; poll"></a>select &amp; poll</h2><p>select æ˜¯ epoll ä¹‹å‰ Linux ä½¿ç”¨çš„ I/O äº‹ä»¶é©±åŠ¨æŠ€æœ¯ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/select.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"> <span class="comment">/* According to earlier standards */</span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"> <span class="comment">// nfdsæ˜¯ç›‘å¬çš„æ–‡ä»¶æè¿°ç¬¦çš„é›†åˆä¸­çš„æœ€å¤§æ–‡ä»¶æè¿°ç¬¦åŠ 1ã€‚readsetæ˜¯è¯»äº‹ä»¶é›†åˆï¼Œwritesetæ˜¯å†™äº‹ä»¶é›†åˆï¼Œexceptsetæ˜¯å¼‚å¸¸äº‹ä»¶é›†åˆï¼Œè‹¥å¦‚æœå¯¹æŸä¸€ä¸ªé›†åˆä¸æ„Ÿå…´è¶£ï¼Œå°±å¯ä»¥æŠŠå®ƒè®¾ä¸ºNULL</span></span><br><span class="line"> <span class="comment">// è¿”å›å€¼ï¼šè‹¥æœ‰å°±ç»ªæè¿°ç¬¦è¿”å›å…¶æ•°ç›®ï¼Œè‹¥è¶…æ—¶åˆ™ä¸º0ï¼Œè‹¥å‡ºé”™åˆ™ä¸º-1</span></span><br><span class="line"> <span class="function"><span class="keyword">int</span> <span class="title">select</span><span class="params">(<span class="keyword">int</span> nfds, fd_set *readfds, fd_set *writefds, fd_set *exceptfds, struct timeval *timeout)</span></span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// å’Œ select ç´§å¯†ç»“åˆçš„å››ä¸ªå®ï¼š</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FD_CLR</span><span class="params">(<span class="keyword">int</span> fd, fd_set *<span class="built_in">set</span>)</span></span>; <span class="comment">// åœ¨æ–‡ä»¶æè¿°ç¬¦é›†åˆä¸­åˆ é™¤ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">FD_ISSET</span><span class="params">(<span class="keyword">int</span> fd, fd_set *<span class="built_in">set</span>)</span></span>; <span class="comment">//æŒ‡å®šçš„æ–‡ä»¶æè¿°ç¬¦æ˜¯å¦åœ¨è¯¥é›†åˆä¸­ï¼Œå¦‚fdåœ¨æ–‡ä»¶æè¿°ç¬¦é›†ä¸­ï¼Œè¿”å›é0å€¼ï¼Œå¦åˆ™è¿”å›0</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FD_SET</span><span class="params">(<span class="keyword">int</span> fd, fd_set *<span class="built_in">set</span>)</span></span>; <span class="comment">// åœ¨æ–‡ä»¶æè¿°ç¬¦é›†åˆä¸­å¢åŠ ä¸€ä¸ªæ–°çš„æ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FD_ZERO</span><span class="params">(fd_set *<span class="built_in">set</span>)</span></span>; <span class="comment">// æ¸…ç©ºæ–‡ä»¶æè¿°ç¬¦é›†</span></span><br></pre></td></tr></table></figure>

<p>ä¸‹é¢æ˜¯ä¸€ä¸ª<code>select</code>ä¾‹å­ï¼Œåˆ›å»º 5 ä¸ªå­è¿›ç¨‹ï¼Œæ¯ä¸ªè¿›ç¨‹è¿æ¥åˆ°æœåŠ¡å™¨å¹¶å‘æœåŠ¡å™¨å‘é€æ¶ˆæ¯ï¼ŒæœåŠ¡å™¨è¿›ç¨‹ä½¿ç”¨ accept ä¸ºæ¯ä¸ªå®¢æˆ·ç«¯åˆ›å»ºä¸åŒçš„æ–‡ä»¶æè¿°ç¬¦ï¼Œ<code>select</code> ä¸­çš„ç¬¬ä¸€ä¸ªå‚æ•°åº”è¯¥æ˜¯ä¸‰ä¸ªé›†åˆä¸­ä»»ä½•ä¸€ä¸ªä¸­ç¼–å·æœ€å¤§çš„æ–‡ä»¶æè¿°ç¬¦åŠ ä¸Š 1ã€‚åˆ›å»ºä¸€ç»„æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦ï¼Œè°ƒç”¨ <code>select</code> å¹¶åœ¨è¿”å›æ—¶æ£€æŸ¥å“ªä¸ªæ–‡ä»¶æè¿°ç¬¦å·²å‡†å¤‡å¥½è¯»å–ã€‚<code>select</code> è¿”å›æ—¶ï¼Œ å°†é›†åˆæ›´æ”¹ä¸ºä»…åŒ…å«å‡†å¤‡å¥½çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦åœ¨æ¯æ¬¡è¿­ä»£æ—¶å†æ¬¡æ„å»ºè¯¥é›†åˆã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/select.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXBUF 256</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">child_process</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  sleep(<span class="number">2</span>);</span><br><span class="line">  <span class="keyword">char</span> msg[MAXBUF];</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">addr</span> = &#123;</span><span class="number">0</span>&#125;;</span><br><span class="line">  <span class="keyword">int</span> n, sockfd,num=<span class="number">1</span>;</span><br><span class="line">  srandom(getpid());</span><br><span class="line">  <span class="comment">/* Create socket and connect to server */</span></span><br><span class="line">  sockfd = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">  addr.sin_family = AF_INET;</span><br><span class="line">  addr.sin_port = htons(<span class="number">2000</span>);</span><br><span class="line">  addr.sin_addr.s_addr = inet_addr(<span class="string">"127.0.0.1"</span>);</span><br><span class="line"></span><br><span class="line">  connect(sockfd, (struct sockaddr*)&amp;addr, <span class="keyword">sizeof</span>(addr));</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"child &#123;%d&#125; connected \n"</span>, getpid());</span><br><span class="line">  <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        <span class="keyword">int</span> sl = (random() % <span class="number">10</span> ) +  <span class="number">1</span>;</span><br><span class="line">        num++;</span><br><span class="line">     	sleep(sl);</span><br><span class="line">  	<span class="built_in">sprintf</span> (msg, <span class="string">"Test message %d from client %d"</span>, num, getpid());</span><br><span class="line">  	n = write(sockfd, msg, <span class="built_in">strlen</span>(msg));	<span class="comment">/* Send message */</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buffer[MAXBUF];</span><br><span class="line">  <span class="keyword">int</span> fds[<span class="number">5</span>];</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">addr</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">client</span>;</span></span><br><span class="line">  <span class="comment">// ç”¨äºè®°å½•æœ€å¤§çš„fdä½ç½®</span></span><br><span class="line">  <span class="keyword">int</span> addrlen, n,i,max=<span class="number">0</span>;;</span><br><span class="line">  <span class="keyword">int</span> sockfd, commfd;</span><br><span class="line">  fd_set rset;</span><br><span class="line">  <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++)</span><br><span class="line">  &#123;</span><br><span class="line">  	<span class="keyword">if</span>(fork() == <span class="number">0</span>)</span><br><span class="line">  	&#123;</span><br><span class="line">  		child_process();</span><br><span class="line">  		<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  	&#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  sockfd = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;addr, <span class="number">0</span>, <span class="keyword">sizeof</span> (addr));</span><br><span class="line">  addr.sin_family = AF_INET;</span><br><span class="line">  addr.sin_port = htons(<span class="number">2000</span>);</span><br><span class="line">  addr.sin_addr.s_addr = INADDR_ANY;</span><br><span class="line">  bind(sockfd,(struct sockaddr*)&amp;addr ,<span class="keyword">sizeof</span>(addr));</span><br><span class="line">  listen (sockfd, <span class="number">5</span>); </span><br><span class="line">	<span class="comment">// åˆ›å»º5ä¸ªæ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line">  <span class="keyword">for</span> (i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++) </span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;client, <span class="number">0</span>, <span class="keyword">sizeof</span> (client));</span><br><span class="line">    addrlen = <span class="keyword">sizeof</span>(client);</span><br><span class="line">    <span class="comment">// å£°æ˜æ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line">    fds[i] = accept(sockfd,(struct sockaddr*)&amp;client, &amp;addrlen);</span><br><span class="line">    <span class="keyword">if</span>(fds[i] &gt; max)</span><br><span class="line">    	max = fds[i];</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">  <span class="comment">// ç”±äºselectåçš„rsetä¼šè¢«ç½®ä½ï¼Œæ‰€æœ‰æ¯æ¬¡å¾ªç¯éœ€è¦å¯¹rsetç½®ç©ºï¼Œç„¶åå†å°†fdsèµ‹ç»™rset</span></span><br><span class="line">	FD_ZERO(&amp;rset);</span><br><span class="line">  	<span class="keyword">for</span> (i = <span class="number">0</span>; i&lt; <span class="number">5</span>; i++ ) &#123;</span><br><span class="line">  		FD_SET(fds[i],&amp;rset);</span><br><span class="line">  	&#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"round again"</span>);</span><br><span class="line">  <span class="comment">// rsetæ˜¯ä¸€ä¸ªbitmap  </span></span><br><span class="line">  <span class="comment">// é˜»å¡ï¼Œæ¯æ¬¡éœ€è¦æŠŠfdä»ç”¨æˆ·æ€æ‹·è´åˆ°å†…æ ¸æ€ </span></span><br><span class="line">  <span class="comment">// å½“æœ‰I/Oæ•°æ®æ—¶ï¼Œselectè¿”å›ï¼Œå¹¶ä¸”å°†rsetç½®ä½ï¼Œæ²¡æ•°æ®çš„ä½ä¼šè¢«æ¸…ç©º  </span></span><br><span class="line">	select(max+<span class="number">1</span>, &amp;rset, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">  <span class="comment">// éå†ï¼Œåˆ¤æ–­å“ªä¸ªfdè¢«ç½®ä½</span></span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++) &#123;</span><br><span class="line">		<span class="keyword">if</span> (FD_ISSET(fds[i], &amp;rset))&#123;</span><br><span class="line">			<span class="built_in">memset</span>(buffer,<span class="number">0</span>,MAXBUF);</span><br><span class="line">      <span class="comment">// è¯»æ•°æ®</span></span><br><span class="line">			read(fds[i], buffer, MAXBUF);</span><br><span class="line">			<span class="built_in">puts</span>(buffer);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;	</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç†è§£ select çš„å…³é”®åœ¨äºç†è§£ <code>fd_set</code>ï¼Œä¸ºè¯´æ˜æ–¹ä¾¿ï¼Œå– <code>fd_set</code> é•¿åº¦ä¸º 1 å­—èŠ‚ï¼Œfd_set ä¸­çš„æ¯ä¸€ bit å¯ä»¥å¯¹åº”ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ <code>fd</code>ï¼Œåˆ™ 1 å­—èŠ‚é•¿çš„ <code>fd_set</code> æœ€å¤§å¯ä»¥å¯¹åº” 8 ä¸ª fdã€‚select çš„è°ƒç”¨è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<blockquote>
<ol>
<li>æ‰§è¡Œ FD_ZERO(&amp;set), åˆ™ set ç”¨ä½è¡¨ç¤ºæ˜¯ <code>0000,0000</code></li>
<li>è‹¥ fdï¼5, æ‰§è¡Œ FD_SET(fd, &amp;set); å set å˜ä¸º 0001,0000(ç¬¬ 5 ä½ç½®ä¸º 1)</li>
<li>å†åŠ å…¥ fdï¼2, fd=1ï¼Œåˆ™ set å˜ä¸º <code>0001,0011</code></li>
<li>æ‰§è¡Œ select(6, &amp;set, 0, 0, 0) é˜»å¡ç­‰å¾…ï¼ˆè¿™é‡Œmaxæ˜¯5+1ï¼Œè¿™æ˜¯å› ä¸ºsetæœ€å¤§åªèƒ½æ˜¯5ï¼Œå†…æ ¸æ²¡å¿…è¦æŠŠæ‰€æœ‰setä½éƒ½å–å‡ºæ¥ï¼Œåªéœ€è¦æœ€å¤§åˆ°6çš„ä½ç½®ï¼‰</li>
<li>è‹¥ fd=1, fd=2 ä¸Šéƒ½å‘ç”Ÿå¯è¯»äº‹ä»¶ï¼Œåˆ™ select è¿”å›ï¼Œæ­¤æ—¶ set å˜ä¸º <code>0000,0011</code> (æ³¨æ„ï¼šæ²¡æœ‰äº‹ä»¶å‘ç”Ÿçš„ fd=5 è¢«æ¸…ç©º)</li>
</ol>
</blockquote>
<p><strong>æ ¹æ®ä¸Šé¢ä¾‹å­æˆ‘ä»¬å¯ä»¥å¾—å‡º<code>select</code>çš„ç‰¹ç‚¹ï¼š</strong></p>
<hr>
<blockquote>
<ul>
<li>å¯ç›‘æ§çš„æ–‡ä»¶æè¿°ç¬¦ä¸ªæ•°å–å†³äº sizeof(fd_set) çš„å€¼ã€‚å‡è®¾æœåŠ¡å™¨ä¸Š sizeof(fd_set)ï¼512ï¼Œæ¯ bit è¡¨ç¤ºä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œåˆ™æœåŠ¡å™¨ä¸Šæ”¯æŒçš„æœ€å¤§æ–‡ä»¶æè¿°ç¬¦æ˜¯ 512*8=4096ã€‚</li>
<li>å°† fd åŠ å…¥ select ç›‘æ§é›†çš„åŒæ—¶ï¼Œè¿˜è¦å†ä½¿ç”¨ä¸€ä¸ªæ•°æ®ç»“æ„ array ä¿å­˜æ”¾åˆ° select ç›‘æ§é›†ä¸­çš„ fdï¼Œä¸€æ˜¯ç”¨äºåœ¨ select è¿”å›åï¼Œarray ä½œä¸ºæºæ•°æ®å’Œ fd_set è¿›è¡Œ FD_ISSET åˆ¤æ–­ã€‚äºŒæ˜¯ select è¿”å›åä¼šæŠŠä»¥å‰åŠ å…¥çš„ä½†å¹¶æ— äº‹ä»¶å‘ç”Ÿçš„ fd æ¸…ç©ºï¼Œåˆ™æ¯æ¬¡å¼€å§‹ select å‰éƒ½è¦é‡æ–°ä» array å–å¾— fd é€ä¸€åŠ å…¥ï¼ˆFD_ZERO æœ€å…ˆï¼‰ï¼Œæ‰«æ array çš„åŒæ—¶å–å¾— fd æœ€å¤§å€¼ maxfdï¼Œç”¨äº select çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œå¯è§ select æ¨¡å‹å¿…é¡»åœ¨ select å‰å¾ªç¯ arrayï¼ˆåŠ  fdï¼Œå– maxfdï¼‰ï¼Œselect è¿”å›åå¾ªç¯ arrayï¼ˆFD_ISSET åˆ¤æ–­æ˜¯å¦æœ‰äº‹ä»¶å‘ç”Ÿï¼‰</li>
<li>selectä¼šå°†rsetå…¨é‡æ‹·è´åˆ°å†…æ ¸æ€ï¼Œç”±å†…æ ¸æ€åˆ¤è¯»rsetæ˜¯å¦æœ‰æ•°æ®ï¼Œè¿™æ˜¯å› ä¸ºå¦‚æœç”±ç”¨æˆ·æ€åˆ¤æ–­ï¼Œä¹Ÿæ˜¯äº¤ç»™å†…æ ¸æ€çœŸæ­£æ‰§è¡Œï¼Œæ¯ä¸€ä¸ªä½çš„åˆ¤æ–­éƒ½éœ€è¦ç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„åˆ‡æ¢ï¼Œæ‰€ä»¥selectç›´æ¥å°†rsetæ‹·è´åˆ°å†…æ ¸æ€</li>
</ul>
</blockquote>
<hr>
<p><strong>æ‰€ä»¥ï¼Œselect æœ‰å¦‚ä¸‹çš„ç¼ºç‚¹ï¼š</strong></p>
<hr>
<blockquote>
<ul>
<li>ç›‘å¬èƒ½åŠ›æœ‰é™ï¼šä½¿ç”¨ 32 ä¸ªæ•´æ•°çš„ 32 ä½ï¼Œå³ 32*32=1024 æ¥æ ‡è¯† fdï¼Œæœ€å¤šåªèƒ½ç›‘å¬ 1024 ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼ˆå¯è°ƒæ•´ï¼‰</li>
<li>å†…å­˜æ‹·è´å¼€é”€å¤§ï¼šæ¯æ¬¡è°ƒç”¨ selectï¼Œéƒ½éœ€è¦æŠŠ fd é›†åˆä»ç”¨æˆ·æ€æ‹·è´åˆ°å†…æ ¸æ€ï¼Œè¿™ä¸ªå¼€é”€åœ¨ fd å¾ˆå¤šæ—¶ä¼šå¾ˆå¤§</li>
<li>æ—¶é—´å¤æ‚åº¦ ğ‘‚(ğ‘›)ï¼šæ¯æ¬¡ kernel éƒ½éœ€è¦çº¿æ€§æ‰«ææ•´ä¸ª fd_setï¼Œæ‰€ä»¥éšç€ç›‘æ§çš„æè¿°ç¬¦ fd æ•°é‡å¢é•¿ï¼Œå…¶ I/O æ€§èƒ½ä¼šçº¿æ€§ä¸‹é™ï¼Œè€Œä¸”ï¼Œrsetä¸å¯é‡ç”¨ï¼Œæ¯æ¬¡å¾ªç¯éƒ½è¦å¯¹rsetç½®ç©ºå†èµ‹å€¼ï¼Œæ€§èƒ½æœ‰æŸè€—</li>
</ul>
</blockquote>
<hr>
<p>å¯¹æ¯”<code>select</code>ï¼Œpoll çš„å®ç°å’Œ select éå¸¸ç›¸ä¼¼ï¼Œåªæ˜¯æè¿° fd é›†åˆçš„æ–¹å¼ä¸åŒï¼Œpoll ä½¿ç”¨ pollfd ç»“æ„è€Œä¸æ˜¯ select çš„ fd_set ç»“æ„ï¼Œ <code>poll</code> å‡½æ•°ä½¿ç”¨é“¾è¡¨å­˜å‚¨æ–‡ä»¶æè¿°ç¬¦ï¼Œæ‘†è„±äº† 1024 çš„æ•°é‡ä¸Šé™ã€‚ä½†æ˜¯åŒæ ·éœ€è¦ä»ç”¨æˆ·æ€æ‹·è´æ‰€æœ‰çš„ fd åˆ°å†…æ ¸æ€ï¼Œä¹Ÿéœ€è¦çº¿æ€§éå†æ‰€æœ‰çš„ fd é›†åˆ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// fdsæ˜¯ä¸€ä¸ªpollå‡½æ•°ç›‘å¬çš„ç»“æ„åˆ—è¡¨ï¼Œnfdsè¡¨ç¤ºfdsæ•°ç»„çš„é•¿åº¦</span></span><br><span class="line"><span class="comment">// è¿”å›å€¼ï¼šå°äº0ï¼Œè¡¨ç¤ºå‡ºé”™ï¼Œç­‰äº0ï¼Œè¡¨ç¤ºpollå‡½æ•°ç­‰å¾…è¶…æ—¶ï¼Œå¤§äº0ï¼Œè¡¨ç¤ºstruct pollfdç»“æ„ä½“æ•°ç»„ä¸­æœ‰å¤šå°‘ä¸ªé0çš„reventsï¼Œä¹Ÿå°±æ˜¯è¿™ä¸€æ¬¡è°ƒç”¨polläº§ç”Ÿäº‹ä»¶çš„æè¿°ç¬¦çš„æ•°é‡ã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">poll</span> <span class="params">(struct pollfd *fds, <span class="keyword">unsigned</span> <span class="keyword">int</span> nfds, <span class="keyword">int</span> timeout)</span></span>;</span><br></pre></td></tr></table></figure>

<p>ä¸<code>select</code>ä¸åŒï¼Œpollä¼ å…¥çš„æ˜¯pollfdç»“æ„ä½“æ•°ç»„ï¼Œæ‰€ä»¥æ²¡æœ‰1024ä¸ªæè¿°ç¬¦çš„é™åˆ¶</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> &#123;</span></span><br><span class="line">      <span class="keyword">int</span> fd; <span class="comment">// æ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line">      <span class="keyword">short</span> events; <span class="comment">// å…³å¿ƒçš„äº‹ä»¶ç±»å‹</span></span><br><span class="line">      <span class="keyword">short</span> revents; <span class="comment">// å®é™…å‘ç”Ÿäº†çš„äº‹ä»¶ç±»å‹</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>äº‹ä»¶ç±»å‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> POLLIN         0x001        <span class="comment">// æœ‰æ•°æ®å¯è¯»</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> POLLPRI        0x002        <span class="comment">// æœ‰ç´§è¿«æ•°æ®å¯è¯»</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> POLLOUT        0x004        <span class="comment">// ç°åœ¨å†™æ•°æ®ä¸ä¼šå¯¼è‡´é˜»å¡</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> POLLRDNORM    0x040        <span class="comment">// æœ‰æ™®é€šæ•°æ®å¯è¯»</span></span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> POLLRDBAND    0x080        <span class="comment">// æœ‰ä¼˜å…ˆæ•°æ®å¯è¯»</span></span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> POLLWRNORM    0x100        <span class="comment">// å†™æ™®é€šæ•°æ®ä¸ä¼šå¯¼è‡´é˜»å¡</span></span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> POLLWRBAND    0x200        <span class="comment">// å†™ä¼˜å…ˆæ•°æ®ä¸ä¼šå¯¼è‡´é˜»å¡</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> POLLERR        0x008        <span class="comment">// å‘ç”Ÿé”™è¯¯</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> POLLHUP        0x010        <span class="comment">// æŒ‚èµ·</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> POLLNVAL       0x020        <span class="comment">// æ— æ•ˆæ–‡ä»¶æè¿°ç¬¦</span></span></span><br></pre></td></tr></table></figure>

<p>å½“ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦è¦åŒæ—¶ç›‘å¬è¯»å†™äº‹ä»¶æ—¶ï¼Œå¯ä»¥å†™æˆ events = POLLIN | POLLOUT</p>
<p>ä¸‹é¢æ˜¯<code>poll</code>çš„ä¾‹å­ï¼Œä¸<code>select</code>ç”¨æ³•ç›¸ä¼¼ï¼Œä»ç„¶éœ€è¦ä»ç”¨æˆ·æ€æ‹·è´æ‰€æœ‰çš„ <code>fd</code> åˆ°å†…æ ¸æ€ï¼Œä¹Ÿéœ€è¦çº¿æ€§éå†æ‰€æœ‰çš„ <code>fd</code> é›†åˆ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// 5ä¸ªæ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line"> <span class="keyword">for</span> (i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++) </span><br><span class="line"> &#123;</span><br><span class="line">   <span class="built_in">memset</span>(&amp;client, <span class="number">0</span>, <span class="keyword">sizeof</span> (client));</span><br><span class="line">   addrlen = <span class="keyword">sizeof</span>(client);</span><br><span class="line">   <span class="comment">// å£°æ˜æ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line">   pollfds[i].fd = accept(sockfd,(struct sockaddr*)&amp;client, &amp;addrlen);</span><br><span class="line">   <span class="comment">// eventsæ˜¯è¯»äº‹ä»¶</span></span><br><span class="line">   pollfds[i].events = POLLIN;</span><br><span class="line"> &#125;</span><br><span class="line"> sleep(<span class="number">1</span>);</span><br><span class="line"> <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line"> <span class="built_in">puts</span>(<span class="string">"round again"</span>);</span><br><span class="line"> <span class="comment">// ä¼ å…¥pollfdæ•°ç»„ï¼Œå¹¶ä¸”æ•°ç»„ä¸­æœ‰5ä¸ªå…ƒç´ ï¼Œ50000æ˜¯è¶…æ—¶</span></span><br><span class="line">poll(pollfds, <span class="number">5</span>, <span class="number">50000</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++) &#123;</span><br><span class="line">   <span class="comment">// åˆ¤æ–­reventsæ˜¯å¦è¢«ç½®ä½ä¸ºPOLLIN</span></span><br><span class="line">	<span class="keyword">if</span> (pollfds[i].revents &amp; POLLIN)&#123;</span><br><span class="line">     <span class="comment">// æ¢å¤ä¸º0</span></span><br><span class="line">		pollfds[i].revents = <span class="number">0</span>;</span><br><span class="line">		<span class="built_in">memset</span>(buffer,<span class="number">0</span>,MAXBUF);</span><br><span class="line">		read(pollfds[i].fd, buffer, MAXBUF);</span><br><span class="line">		<span class="built_in">puts</span>(buffer);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>ä¸<code>select</code>ä¸åŒçš„æ˜¯ï¼Œ<code>poll</code>ä¸æ˜¯å¯¹bitmapç½®ä½ï¼Œè€Œä¸”æ”¹å˜<code>revents</code>å­—æ®µï¼ˆ<code>select</code>å¯¹bitmapç½®ä½å¯¼è‡´rsetä¸å¯é‡ç”¨ï¼‰ï¼Œè¿™é‡Œä¼šå¯¹<code>revents</code>å­—æ®µèµ‹å€¼ä¸º<code>POLLIN</code>ï¼Œå³è¯»äº‹ä»¶ï¼Œ<code>poll</code>è¿”å›åéœ€è¦å¯¹<code>revents</code>å­—æ®µæ¢å¤ä¸º0ã€‚<code>poll</code>è§£å†³äº†<code>select</code>ç›‘å¬èƒ½åŠ›å—é™çš„é—®é¢˜ï¼Œä¹Ÿè§£å†³äº†bitmapé‡ç”¨çš„é—®é¢˜ï¼Œä½†æ˜¯ä»ç„¶éœ€è¦å†…å­˜æ‹·è´ä»¥åŠæ—¶é—´å¤æ‚åº¦ğ‘‚(ğ‘›)çš„é—®é¢˜ã€‚</p>
<h2 id="epoll"><a href="#epoll" class="headerlink" title="epoll"></a>epoll</h2><p>I/O å¤šè·¯å¤ç”¨çš„æ ¸å¿ƒè®¾è®¡æ˜¯ 1 ä¸ªçº¿ç¨‹å¤„ç†æ‰€æœ‰è¿æ¥çš„ <code>ç­‰å¾…æ¶ˆæ¯å‡†å¤‡å¥½</code> I/O äº‹ä»¶ï¼Œè¿™ä¸€ç‚¹ä¸Š <code>epoll</code> å’Œ <code>select</code>&amp;<code>poll</code> æ˜¯å¤§åŒå°å¼‚çš„ã€‚ä½† <code>select</code>&amp;<code>poll</code>åœ¨åä¸‡å¹¶å‘è¿æ¥å­˜åœ¨æ—¶ï¼Œå¯èƒ½æ¯ä¸€æ¯«ç§’åªæœ‰æ•°ç™¾ä¸ªæ´»è·ƒçš„è¿æ¥ï¼ŒåŒæ—¶å…¶ä½™æ•°åä¸‡è¿æ¥åœ¨è¿™ä¸€æ¯«ç§’æ˜¯éæ´»è·ƒçš„ã€‚<code>select&amp;</code>&amp;<code>poll</code> çš„ä½¿ç”¨æ–¹æ³•æ˜¯è¿™æ ·çš„ï¼š <code>è¿”å›çš„æ´»è·ƒè¿æ¥ == select(å…¨éƒ¨å¾…ç›‘æ§çš„è¿æ¥)</code> ã€‚ä»€ä¹ˆæ—¶å€™ä¼šè°ƒç”¨ <code>select</code>&amp;<code>poll</code> å‘¢ï¼Ÿåœ¨ä½ è®¤ä¸ºéœ€è¦æ‰¾å‡ºæœ‰æŠ¥æ–‡åˆ°è¾¾çš„æ´»è·ƒè¿æ¥æ—¶ï¼Œå°±åº”è¯¥è°ƒç”¨ã€‚æ‰€ä»¥ï¼Œ<code>select</code>&amp;<code>poll</code> åœ¨é«˜å¹¶å‘æ—¶æ˜¯ä¼šè¢«é¢‘ç¹è°ƒç”¨çš„ã€‚è¿™æ ·ï¼Œè¿™ä¸ªé¢‘ç¹è°ƒç”¨çš„æ–¹æ³•å°±å¾ˆæœ‰å¿…è¦çœ‹çœ‹å®ƒæ˜¯å¦æœ‰æ•ˆç‡ï¼Œå› ä¸ºï¼Œå®ƒçš„è½»å¾®æ•ˆç‡æŸå¤±éƒ½ä¼šè¢« <code>é«˜é¢‘</code> äºŒå­—æ‰€æ”¾å¤§ã€‚å®ƒæœ‰æ•ˆç‡æŸå¤±å—ï¼Ÿæ˜¾è€Œæ˜“è§ï¼Œå…¨éƒ¨å¾…ç›‘æ§è¿æ¥æ˜¯æ•°ä»¥åä¸‡è®¡çš„ï¼Œè¿”å›çš„åªæ˜¯æ•°ç™¾ä¸ªæ´»è·ƒè¿æ¥ï¼Œè¿™æœ¬èº«å°±æ˜¯æ— æ•ˆç‡çš„è¡¨ç°ã€‚è¢«æ”¾å¤§åå°±ä¼šå‘ç°ï¼Œå¤„ç†å¹¶å‘ä¸Šä¸‡ä¸ªè¿æ¥æ—¶ï¼Œ<code>select</code>&amp;<code>poll</code> å°±å®Œå…¨åŠ›ä¸ä»å¿ƒäº†ã€‚è¿™ä¸ªæ—¶å€™å°±è¯¥ <code>epoll</code> ä¸Šåœºäº†ï¼Œ<code>epoll</code> é€šè¿‡ä¸€äº›æ–°çš„è®¾è®¡å’Œä¼˜åŒ–ï¼ŒåŸºæœ¬ä¸Šè§£å†³äº† <code>select</code>&amp;<code>poll</code> çš„é—®é¢˜ã€‚</p>
<p>epoll çš„ API éå¸¸ç®€æ´ï¼Œæ¶‰åŠåˆ°çš„åªæœ‰ 3 ä¸ªç³»ç»Ÿè°ƒç”¨ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/epoll.h&gt;  </span></span></span><br><span class="line"><span class="comment">// sizeè¡¨æ˜å†…æ ¸è¦ç›‘å¬çš„æè¿°ç¬¦æ•°é‡</span></span><br><span class="line"><span class="comment">// è¿”å›ä¸€ä¸ªepollå¥æŸ„æè¿°ç¬¦ï¼Œå¤±è´¥æ—¶è¿”å›-1</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">epoll_create</span><span class="params">(<span class="keyword">int</span> size)</span></span>; <span class="comment">// int epoll_create1(int flags);</span></span><br><span class="line"><span class="comment">// epfd è¡¨ç¤ºepollå¥æŸ„</span></span><br><span class="line"><span class="comment">// op è¡¨ç¤ºfdæ“ä½œç±»å‹ï¼Œæœ‰å¦‚ä¸‹3ç§ï¼š</span></span><br><span class="line"><span class="comment">// 1.EPOLL_CTL_ADD æ³¨å†Œæ–°çš„fdåˆ°epfdä¸­</span></span><br><span class="line"><span class="comment">// 2.EPOLL_CTL_MOD ä¿®æ”¹å·²æ³¨å†Œçš„fdçš„ç›‘å¬äº‹ä»¶</span></span><br><span class="line"><span class="comment">// 3.EPOLL_CTL_DEL ä»epfdä¸­åˆ é™¤ä¸€ä¸ªfd</span></span><br><span class="line"><span class="comment">// fd æ˜¯è¦ç›‘å¬çš„æè¿°ç¬¦</span></span><br><span class="line"><span class="comment">// event è¡¨ç¤ºè¦ç›‘å¬çš„äº‹ä»¶</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">epoll_ctl</span><span class="params">(<span class="keyword">int</span> epfd, <span class="keyword">int</span> op, <span class="keyword">int</span> fd, struct epoll_event *event)</span></span>;</span><br><span class="line"><span class="comment">// epfd æ˜¯epollå¥æŸ„</span></span><br><span class="line"><span class="comment">// events è¡¨ç¤ºä»å†…æ ¸å¾—åˆ°çš„å°±ç»ªäº‹ä»¶é›†åˆ</span></span><br><span class="line"><span class="comment">// maxevents å‘Šè¯‰å†…æ ¸eventsçš„å¤§å°</span></span><br><span class="line"><span class="comment">// timeout è¡¨ç¤ºç­‰å¾…çš„è¶…æ—¶äº‹ä»¶</span></span><br><span class="line"><span class="comment">// è¿”å›å€¼ï¼šè¿”å›å°±ç»ªçš„äº‹ä»¶æ•°ç›®ï¼Œè°ƒç”¨å¤±è´¥æ—¶è¿”å› -1ï¼Œç­‰å¾…è¶…æ—¶è¿”å› 0ã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">epoll_wait</span><span class="params">(<span class="keyword">int</span> epfd, struct epoll_event *events, <span class="keyword">int</span> maxevents, <span class="keyword">int</span> timeout)</span></span>;</span><br></pre></td></tr></table></figure>

<p><code>epoll_create</code> åˆ›å»ºä¸€ä¸ª <code>epoll</code> å®ä¾‹å¹¶è¿”å› <code>epollfd</code>ï¼Œ<code>epoll_ctl</code> æ³¨å†Œ file descriptor ç­‰å¾…çš„ I/O äº‹ä»¶(æ¯”å¦‚ EPOLLINã€EPOLLOUT ç­‰) åˆ° <code>epoll</code> å®ä¾‹ä¸Šï¼Œ<code>epoll_wait</code> åˆ™æ˜¯é˜»å¡ç›‘å¬ <code>epoll</code> å®ä¾‹ä¸Šæ‰€æœ‰çš„ file descriptor çš„ I/O äº‹ä»¶ï¼Œå®ƒæ¥æ”¶ä¸€ä¸ªç”¨æˆ·ç©ºé—´ä¸Šçš„ä¸€å—å†…å­˜åœ°å€ (events æ•°ç»„)ï¼Œkernel ä¼šåœ¨æœ‰ I/O äº‹ä»¶å‘ç”Ÿçš„æ—¶å€™æŠŠæ–‡ä»¶æè¿°ç¬¦åˆ—è¡¨å¤åˆ¶åˆ°è¿™å—å†…å­˜åœ°å€ä¸Šï¼Œç„¶å <code>epoll_wait</code> è§£é™¤é˜»å¡å¹¶è¿”å›ï¼Œæœ€åç”¨æˆ·ç©ºé—´ä¸Šçš„ç¨‹åºå°±å¯ä»¥å¯¹ç›¸åº”çš„ <code>fd</code> è¿›è¡Œè¯»å†™äº†ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="keyword">ssize_t</span> read(<span class="keyword">int</span> fd, <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> count);</span><br><span class="line"><span class="keyword">ssize_t</span> write(<span class="keyword">int</span> fd, <span class="keyword">const</span> <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> count);</span><br></pre></td></tr></table></figure>

<p><code>epoll</code>èƒ½æ˜¾è‘—æé«˜ç¨‹åºåœ¨å¤§é‡å¹¶å‘è¿æ¥ä¸­åªæœ‰å°‘é‡æ´»è·ƒçš„æƒ…å†µä¸‹çš„ç³»ç»ŸCPUåˆ©ç”¨ç‡ã€‚åŸå› å°±æ˜¯è·å–äº‹ä»¶çš„æ—¶å€™ï¼Œå®ƒ<code>æ— é¡»éå†æ•´ä¸ªè¢«ä¾¦å¬çš„æè¿°ç¬¦é›†</code>ï¼Œåªè¦éå†é‚£äº›è¢«å†…æ ¸IOäº‹ä»¶å¼‚æ­¥å”¤é†’è€ŒåŠ å…¥Readyé˜Ÿåˆ—çš„æè¿°ç¬¦é›†åˆå°±è¡Œäº†ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span> <span class="title">events</span>[5];</span></span><br><span class="line">  <span class="keyword">int</span> epfd = epoll_create(<span class="number">10</span>);</span><br><span class="line">  ...</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">for</span> (i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++) </span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span> <span class="title">ev</span>;</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;client, <span class="number">0</span>, <span class="keyword">sizeof</span> (client));</span><br><span class="line">    addrlen = <span class="keyword">sizeof</span>(client);</span><br><span class="line">    ev.data.fd = accept(sockfd,(struct sockaddr*)&amp;client, &amp;addrlen);</span><br><span class="line">    ev.events = EPOLLIN;</span><br><span class="line">    epoll_ctl(epfd, EPOLL_CTL_ADD, ev.data.fd, &amp;ev); </span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">  	<span class="built_in">puts</span>(<span class="string">"round again"</span>);</span><br><span class="line">  	nfds = epoll_wait(epfd, events, <span class="number">5</span>, <span class="number">10000</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;nfds;i++) &#123;</span><br><span class="line">			<span class="built_in">memset</span>(buffer,<span class="number">0</span>,MAXBUF);</span><br><span class="line">      <span class="comment">// ä»eventsæ•°ç»„ä¸­è·å–å¯¹åº”fdå³å¯ï¼Œæ— éœ€éå†æ‰€æœ‰æè¿°ç¬¦é›†</span></span><br><span class="line">			read(events[i].data.fd, buffer, MAXBUF);</span><br><span class="line">			<span class="built_in">puts</span>(buffer);</span><br><span class="line">	&#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p><code>epoll</code> çš„å·¥ä½œåŸç†å¦‚ä¸‹ï¼š</p>
<p><img src="/images/io-2.png" alt="io"></p>
<p>ä¸ <code>select</code>&amp;<code>poll</code> ç›¸æ¯”ï¼Œ<code>epoll</code> åˆ†æ¸…äº†é«˜é¢‘è°ƒç”¨å’Œä½é¢‘è°ƒç”¨ã€‚ä¾‹å¦‚ï¼Œ<code>epoll_ctl</code> ç›¸å¯¹æ¥è¯´å°±æ˜¯éé¢‘ç¹è°ƒç”¨çš„ï¼Œè€Œ <code>epoll_wait</code> åˆ™æ˜¯ä¼šè¢«é«˜é¢‘è°ƒç”¨çš„ã€‚æ‰€ä»¥ <code>epoll</code> åˆ©ç”¨ <code>epoll_ctl</code> æ¥æ’å…¥æˆ–è€…åˆ é™¤ä¸€ä¸ª fdï¼Œå®ç°ç”¨æˆ·æ€åˆ°å†…æ ¸æ€çš„æ•°æ®æ‹·è´ï¼Œè¿™ç¡®ä¿äº†æ¯ä¸€ä¸ª fd åœ¨å…¶ç”Ÿå‘½å‘¨æœŸåªéœ€è¦è¢«æ‹·è´ä¸€æ¬¡ï¼Œè€Œä¸æ˜¯æ¯æ¬¡è°ƒç”¨ <code>epoll_wait</code> çš„æ—¶å€™éƒ½æ‹·è´ä¸€æ¬¡ã€‚ <code>epoll_wait</code> åˆ™è¢«è®¾è®¡æˆå‡ ä¹æ²¡æœ‰å…¥å‚çš„è°ƒç”¨ï¼Œç›¸æ¯”  <code>select</code>&amp;<code>poll</code>éœ€è¦æŠŠå…¨éƒ¨ç›‘å¬çš„ fd é›†åˆä»ç”¨æˆ·æ€æ‹·è´è‡³å†…æ ¸æ€çš„åšæ³•ï¼Œ<code>epoll</code> çš„æ•ˆç‡å°±é«˜å‡ºäº†ä¸€å¤§æˆªã€‚</p>
<p>åœ¨å®ç°ä¸Š <code>epoll</code> é‡‡ç”¨<code>çº¢é»‘æ ‘</code>æ¥å­˜å‚¨æ‰€æœ‰ç›‘å¬çš„ fdï¼Œ<strong>è€Œçº¢é»‘æ ‘æœ¬èº«æ’å…¥å’Œåˆ é™¤æ€§èƒ½æ¯”è¾ƒç¨³å®šï¼Œæ—¶é—´å¤æ‚åº¦ O(logN)</strong>ã€‚é€šè¿‡ <code>epoll_ctl</code> å‡½æ•°æ·»åŠ è¿›æ¥çš„ fd éƒ½ä¼šè¢«æ”¾åœ¨çº¢é»‘æ ‘çš„æŸä¸ªèŠ‚ç‚¹å†…ï¼Œæ‰€ä»¥ï¼Œé‡å¤æ·»åŠ æ˜¯æ²¡æœ‰ç”¨çš„ã€‚å½“æŠŠ fd æ·»åŠ è¿›æ¥çš„æ—¶å€™æ—¶å€™ä¼šå®Œæˆå…³é”®çš„ä¸€æ­¥ï¼šè¯¥ fd ä¼šä¸ç›¸åº”çš„è®¾å¤‡ï¼ˆç½‘å¡ï¼‰é©±åŠ¨ç¨‹åºå»ºç«‹å›è°ƒå…³ç³»ï¼Œä¹Ÿå°±æ˜¯åœ¨å†…æ ¸ä¸­æ–­å¤„ç†ç¨‹åºä¸ºå®ƒæ³¨å†Œä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œåœ¨ fd ç›¸åº”çš„äº‹ä»¶è§¦å‘ï¼ˆä¸­æ–­ï¼‰ä¹‹åï¼ˆè®¾å¤‡å°±ç»ªäº†ï¼‰ï¼Œå†…æ ¸å°±ä¼šè°ƒç”¨è¿™ä¸ªå›è°ƒå‡½æ•°ï¼Œè¯¥å›è°ƒå‡½æ•°åœ¨å†…æ ¸ä¸­è¢«ç§°ä¸ºï¼š <code>ep_poll_callback</code> ï¼Œ<strong>è¿™ä¸ªå›è°ƒå‡½æ•°å…¶å®å°±æ˜¯æŠŠè¿™ä¸ª fd æ·»åŠ åˆ° rdllist è¿™ä¸ªåŒå‘é“¾è¡¨ï¼ˆå°±ç»ªé“¾è¡¨ï¼‰ä¸­</strong>ã€‚<code>epoll_wait</code> å®é™…ä¸Šå°±æ˜¯å»æ£€æŸ¥ rdllist åŒå‘é“¾è¡¨ä¸­æ˜¯å¦æœ‰å°±ç»ªçš„ fdï¼Œå½“ rdllist ä¸ºç©ºï¼ˆæ— å°±ç»ª fdï¼‰æ—¶æŒ‚èµ·å½“å‰è¿›ç¨‹ï¼Œç›´åˆ° rdllist éç©ºæ—¶è¿›ç¨‹æ‰è¢«å”¤é†’å¹¶è¿”å›ã€‚</p>
<p>ç›¸æ¯”äº  <code>select</code>&amp;<code>poll</code> è°ƒç”¨æ—¶ä¼šå°†å…¨éƒ¨ç›‘å¬çš„ fd ä»ç”¨æˆ·æ€ç©ºé—´æ‹·è´è‡³å†…æ ¸æ€ç©ºé—´å¹¶çº¿æ€§æ‰«æä¸€éæ‰¾å‡ºå°±ç»ªçš„ fd å†è¿”å›åˆ°ç”¨æˆ·æ€ï¼Œ<code>epoll_wait</code> åˆ™æ˜¯ç›´æ¥è¿”å›å·²å°±ç»ª fdï¼Œå› æ­¤ <code>epoll</code> çš„ I/O æ€§èƒ½ä¸ä¼šåƒ  <code>select</code>&amp;<code>poll</code> é‚£æ ·éšç€ç›‘å¬çš„ fd æ•°é‡å¢åŠ è€Œå‡ºç°çº¿æ€§è¡°å‡ï¼Œæ˜¯ä¸€ä¸ªéå¸¸é«˜æ•ˆçš„ I/O äº‹ä»¶é©±åŠ¨æŠ€æœ¯ã€‚</p>
<p><strong>ç”±äºä½¿ç”¨ <code>epoll</code> çš„ I/O å¤šè·¯å¤ç”¨éœ€è¦ç”¨æˆ·è¿›ç¨‹è‡ªå·±è´Ÿè´£ I/O è¯»å†™ï¼Œä»ç”¨æˆ·è¿›ç¨‹çš„è§’åº¦çœ‹ï¼Œè¯»å†™è¿‡ç¨‹æ˜¯é˜»å¡çš„ï¼Œæ‰€ä»¥ <code>select</code>&amp;<code>poll</code>&amp;<code>epoll</code> æœ¬è´¨ä¸Šéƒ½æ˜¯åŒæ­¥ I/O æ¨¡å‹ï¼Œè€Œåƒ Windows çš„ IOCP è¿™ä¸€ç±»çš„å¼‚æ­¥ I/Oï¼Œåªéœ€è¦åœ¨è°ƒç”¨ WSARecv æˆ– WSASend æ–¹æ³•è¯»å†™æ•°æ®çš„æ—¶å€™æŠŠç”¨æˆ·ç©ºé—´çš„å†…å­˜ buffer æäº¤ç»™ kernelï¼Œkernel è´Ÿè´£æ•°æ®åœ¨ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´æ‹·è´ï¼Œå®Œæˆä¹‹åå°±ä¼šé€šçŸ¥ç”¨æˆ·è¿›ç¨‹ï¼Œæ•´ä¸ªè¿‡ç¨‹ä¸éœ€è¦ç”¨æˆ·è¿›ç¨‹å‚ä¸ï¼Œæ‰€ä»¥æ˜¯çœŸæ­£çš„å¼‚æ­¥ I/Oã€‚</strong></p>
<p><code>epoll</code> çš„å·¥ä½œæ¨¡å¼:</p>
<p>epollå¯¹æ–‡ä»¶æè¿°ç¬¦çš„æ“ä½œæœ‰ä¸¤ç§æ¨¡å¼ï¼š<strong>LTï¼ˆlevel triggerï¼‰</strong>å’Œ<strong>ETï¼ˆedge triggerï¼‰</strong>ã€‚LTæ¨¡å¼æ˜¯é»˜è®¤æ¨¡å¼ï¼ŒLTæ¨¡å¼ä¸ETæ¨¡å¼çš„åŒºåˆ«å¦‚ä¸‹ï¼š<br>ã€€ã€€<strong>LTæ¨¡å¼</strong>ï¼šå½“epoll_waitæ£€æµ‹åˆ°æè¿°ç¬¦äº‹ä»¶å‘ç”Ÿå¹¶å°†æ­¤äº‹ä»¶é€šçŸ¥åº”ç”¨ç¨‹åºï¼Œ<code>åº”ç”¨ç¨‹åºå¯ä»¥ä¸ç«‹å³å¤„ç†è¯¥äº‹ä»¶</code>ã€‚ä¸‹æ¬¡è°ƒç”¨epoll_waitæ—¶ï¼Œä¼šå†æ¬¡å“åº”åº”ç”¨ç¨‹åºå¹¶é€šçŸ¥æ­¤äº‹ä»¶ã€‚<br>ã€€ã€€<strong>ETæ¨¡å¼</strong>ï¼šå½“epoll_waitæ£€æµ‹åˆ°æè¿°ç¬¦äº‹ä»¶å‘ç”Ÿå¹¶å°†æ­¤äº‹ä»¶é€šçŸ¥åº”ç”¨ç¨‹åºï¼Œ<code>åº”ç”¨ç¨‹åºå¿…é¡»ç«‹å³å¤„ç†è¯¥äº‹ä»¶</code>ã€‚å¦‚æœä¸å¤„ç†ï¼Œä¸‹æ¬¡è°ƒç”¨epoll_waitæ—¶ï¼Œä¸ä¼šå†æ¬¡å“åº”åº”ç”¨ç¨‹åºå¹¶é€šçŸ¥æ­¤äº‹ä»¶ã€‚</p>
<h2 id="go-netPoller"><a href="#go-netPoller" class="headerlink" title="go netPoller"></a>go netPoller</h2><p><strong>Go netpoller åŸºæœ¬åŸç†</strong></p>
<blockquote>
<p>Go netpoller é€šè¿‡åœ¨åº•å±‚å¯¹ epoll/kqueue/iocp çš„å°è£…ï¼Œä»è€Œå®ç°äº†ä½¿ç”¨åŒæ­¥ç¼–ç¨‹æ¨¡å¼è¾¾åˆ°å¼‚æ­¥æ‰§è¡Œçš„æ•ˆæœã€‚æ€»ç»“æ¥è¯´ï¼Œæ‰€æœ‰çš„ç½‘ç»œæ“ä½œéƒ½ä»¥ç½‘ç»œæè¿°ç¬¦ <code>netFD</code> ä¸ºä¸­å¿ƒå®ç°ã€‚netFD ä¸åº•å±‚ <code>PollDesc</code> ç»“æ„ç»‘å®šï¼Œå½“åœ¨ä¸€ä¸ª netFD ä¸Šè¯»å†™é‡åˆ° EAGAIN é”™è¯¯æ—¶ï¼Œå°±å°†å½“å‰ goroutine å­˜å‚¨åˆ°è¿™ä¸ª netFD å¯¹åº”çš„ PollDesc ä¸­ï¼ŒåŒæ—¶è°ƒç”¨ <code>gopark</code> æŠŠå½“å‰ goroutine ç»™ park ä½ï¼Œç›´åˆ°è¿™ä¸ª netFD ä¸Šå†æ¬¡å‘ç”Ÿè¯»å†™äº‹ä»¶ï¼Œæ‰å°†æ­¤ goroutine ç»™ ready æ¿€æ´»é‡æ–°è¿è¡Œã€‚æ˜¾ç„¶ï¼Œåœ¨åº•å±‚é€šçŸ¥ goroutine å†æ¬¡å‘ç”Ÿè¯»å†™ç­‰äº‹ä»¶çš„æ–¹å¼å°±æ˜¯ epoll/kqueue/iocp ç­‰äº‹ä»¶é©±åŠ¨æœºåˆ¶ã€‚</p>
</blockquote>
<p>ä¸ºäº†æé«˜ I/O å¤šè·¯å¤ç”¨çš„æ€§èƒ½ï¼Œä¸åŒçš„æ“ä½œç³»ç»Ÿä¹Ÿéƒ½å®ç°äº†è‡ªå·±çš„ I/O å¤šè·¯å¤ç”¨å‡½æ•°ï¼Œä¾‹å¦‚ï¼š<code>epoll</code>ã€<code>kqueue</code> å’Œ <code>evport</code> ç­‰ã€‚Go è¯­è¨€ä¸ºäº†æé«˜åœ¨ä¸åŒæ“ä½œç³»ç»Ÿä¸Šçš„ I/O æ“ä½œæ€§èƒ½ï¼Œä½¿ç”¨å¹³å°ç‰¹å®šçš„å‡½æ•°å®ç°äº†å¤šä¸ªç‰ˆæœ¬çš„ç½‘ç»œè½®è¯¢æ¨¡å—ï¼š</p>
<blockquote>
<ul>
<li><a href="https://github.com/golang/go/blob/master/src/runtime/netpoll_epoll.go" target="_blank" rel="noopener"><code>src/runtime/netpoll_epoll.go</code></a></li>
<li><a href="https://github.com/golang/go/blob/master/src/runtime/netpoll_kqueue.go" target="_blank" rel="noopener"><code>src/runtime/netpoll_kqueue.go</code></a></li>
<li><a href="https://github.com/golang/go/blob/master/src/runtime/netpoll_solaris.go" target="_blank" rel="noopener"><code>src/runtime/netpoll_solaris.go</code></a></li>
<li><a href="https://github.com/golang/go/blob/master/src/runtime/netpoll_windows.go" target="_blank" rel="noopener"><code>src/runtime/netpoll_windows.go</code></a></li>
<li><a href="https://github.com/golang/go/blob/master/src/runtime/netpoll_aix.go" target="_blank" rel="noopener"><code>src/runtime/netpoll_aix.go</code></a></li>
<li><a href="https://github.com/golang/go/blob/master/src/runtime/netpoll_fake.go" target="_blank" rel="noopener"><code>src/runtime/netpoll_fake.go</code></a></li>
</ul>
</blockquote>
<p>æˆ‘ä»¬åªé’ˆå¯¹<code>epoll</code>ç‰ˆæœ¬</p>
<h2 id="ç½‘ç»œè½®è¯¢å™¨æ¥å£"><a href="#ç½‘ç»œè½®è¯¢å™¨æ¥å£" class="headerlink" title="ç½‘ç»œè½®è¯¢å™¨æ¥å£"></a>ç½‘ç»œè½®è¯¢å™¨æ¥å£</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">netpollinit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="title">func</span> <span class="title">netpollopen</span><span class="params">(fd <span class="keyword">uintptr</span>, pd *pollDesc)</span> <span class="title">int32</span></span></span><br><span class="line"><span class="function"><span class="title">func</span> <span class="title">netpoll</span><span class="params">(delta <span class="keyword">int64</span>)</span> <span class="title">gList</span></span></span><br><span class="line"><span class="function"><span class="title">func</span> <span class="title">netpollBreak</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="title">func</span> <span class="title">netpollIsPollDescriptor</span><span class="params">(fd <span class="keyword">uintptr</span>)</span> <span class="title">bool</span></span></span><br></pre></td></tr></table></figure>

<p>ä¸Šè¿°å‡½æ•°åœ¨ç½‘ç»œè½®è¯¢å™¨ä¸­åˆ†åˆ«æ‰®æ¼”äº†ä¸åŒçš„ä½œç”¨ï¼š</p>
<ul>
<li><code>runtime.netpollinit</code> â€” åˆå§‹åŒ–ç½‘ç»œè½®è¯¢å™¨ï¼Œé€šè¿‡ <code>sync.Once</code> å’Œ <code>netpollInited</code> å˜é‡ä¿è¯å‡½æ•°åªä¼šè°ƒç”¨ä¸€æ¬¡</li>
<li><code>runtime.netpollopen</code> â€” ç›‘å¬æ–‡ä»¶æè¿°ç¬¦ä¸Šçš„è¾¹ç¼˜è§¦å‘äº‹ä»¶ï¼Œåˆ›å»ºäº‹ä»¶å¹¶åŠ å…¥ç›‘å¬</li>
<li><code>runtime.netpoll</code>â€” è½®è¯¢ç½‘ç»œå¹¶è¿”å›ä¸€ç»„å·²ç»å‡†å¤‡å°±ç»ªçš„ Goroutineï¼Œä¼ å…¥çš„å‚æ•°ä¼šå†³å®šå®ƒçš„è¡Œä¸ºï¼š<ul>
<li>å¦‚æœå‚æ•°å°äº 0ï¼Œæ— é™æœŸç­‰å¾…æ–‡ä»¶æè¿°ç¬¦å°±ç»ªï¼›</li>
<li>å¦‚æœå‚æ•°ç­‰äº 0ï¼Œéé˜»å¡åœ°è½®è¯¢ç½‘ç»œï¼›</li>
<li>å¦‚æœå‚æ•°å¤§äº 0ï¼Œé˜»å¡ç‰¹å®šæ—¶é—´è½®è¯¢ç½‘ç»œï¼›</li>
</ul>
</li>
<li><code>runtime.netpollBreak</code> â€” å”¤é†’ç½‘ç»œè½®è¯¢å™¨ï¼Œä¾‹å¦‚ï¼šè®¡æ—¶å™¨å‘å‰ä¿®æ”¹æ—¶é—´æ—¶ä¼šé€šè¿‡è¯¥å‡½æ•°ä¸­æ–­ç½‘ç»œè½®è¯¢å™¨</li>
<li><code>runtime.netpollIsPollDescriptor</code> â€” åˆ¤æ–­æ–‡ä»¶æè¿°ç¬¦æ˜¯å¦è¢«è½®è¯¢å™¨ä½¿ç”¨</li>
</ul>
<h2 id="æ•°æ®ç»“æ„"><a href="#æ•°æ®ç»“æ„" class="headerlink" title="æ•°æ®ç»“æ„"></a>æ•°æ®ç»“æ„</h2><p><strong>netFD</strong></p>
<p><code>net.Listen(&quot;tcp&quot;, &quot;:8888&quot;)</code> æ–¹æ³•è¿”å›äº†ä¸€ä¸ª *TCPListenerï¼Œå®ƒæ˜¯ä¸€ä¸ªå®ç°äº† <code>net.Listener</code> æ¥å£çš„ structï¼Œè€Œé€šè¿‡ <code>listener.Accept()</code> æ¥æ”¶çš„æ–°è¿æ¥ *TCPConn åˆ™æ˜¯ä¸€ä¸ªå®ç°äº† <code>net.Conn</code> æ¥å£çš„ structï¼Œå®ƒå†…åµŒäº† <code>net.conn</code> structã€‚ä¸ç®¡æ˜¯ Listener çš„ Accept è¿˜æ˜¯ Conn çš„ Read/Write æ–¹æ³•ï¼Œéƒ½æ˜¯åŸºäºä¸€ä¸ª <code>netFD</code> çš„æ•°æ®ç»“æ„çš„æ“ä½œï¼Œ <code>netFD</code> æ˜¯ä¸€ä¸ªç½‘ç»œæè¿°ç¬¦ï¼Œç±»ä¼¼äº Linux çš„æ–‡ä»¶æè¿°ç¬¦çš„æ¦‚å¿µï¼ŒnetFD ä¸­åŒ…å«ä¸€ä¸ª poll.FD æ•°æ®ç»“æ„ï¼Œè€Œ poll.FD ä¸­åŒ…å«ä¸¤ä¸ªé‡è¦çš„æ•°æ®ç»“æ„ <code>Sysfd</code> å’Œ <code>pollDesc</code>ï¼Œ <code>Sysfd</code> æ˜¯çœŸæ­£çš„ç³»ç»Ÿæ–‡ä»¶æè¿°ç¬¦ï¼Œ<code>pollDesc</code>å¯¹æ˜¯åº•å±‚äº‹ä»¶é©±åŠ¨çš„å°è£…ï¼Œæ‰€æœ‰çš„è¯»å†™è¶…æ—¶ç­‰æ“ä½œéƒ½æ˜¯é€šè¿‡è°ƒç”¨<code>pollDesc</code>çš„å¯¹åº”æ–¹æ³•å®ç°çš„ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Network file descriptor.</span></span><br><span class="line"><span class="comment">// ç½‘ç»œæè¿°ç¬¦</span></span><br><span class="line"><span class="keyword">type</span> netFD <span class="keyword">struct</span> &#123;</span><br><span class="line">	pfd poll.FD</span><br><span class="line"></span><br><span class="line">	<span class="comment">// immutable until Close</span></span><br><span class="line">	family      <span class="keyword">int</span></span><br><span class="line">	sotype      <span class="keyword">int</span></span><br><span class="line">	isConnected <span class="keyword">bool</span> <span class="comment">// handshake completed or use of association with peer</span></span><br><span class="line">	net         <span class="keyword">string</span></span><br><span class="line">	laddr       Addr</span><br><span class="line">	raddr       Addr</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FD is a file descriptor. The net and os packages use this type as a</span></span><br><span class="line"><span class="comment">// field of a larger type representing a network connection or OS file.</span></span><br><span class="line"><span class="keyword">type</span> FD <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// Lock sysfd and serialize access to Read and Write methods.</span></span><br><span class="line">	fdmu fdMutex</span><br><span class="line"></span><br><span class="line">	<span class="comment">// System file descriptor. Immutable until Close.</span></span><br><span class="line">	<span class="comment">// çœŸæ­£çš„ç³»ç»Ÿæ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line">	Sysfd <span class="keyword">int</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// I/O poller.</span></span><br><span class="line">	<span class="comment">// å¯¹æ˜¯åº•å±‚äº‹ä»¶é©±åŠ¨çš„å°è£…ï¼Œæ‰€æœ‰çš„è¯»å†™è¶…æ—¶ç­‰æ“ä½œéƒ½æ˜¯é€šè¿‡è°ƒç”¨pollDescçš„å¯¹åº”æ–¹æ³•å®ç°çš„ã€‚</span></span><br><span class="line">	pd pollDesc</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Writev cache.</span></span><br><span class="line">	iovecs *[]syscall.Iovec</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Semaphore signaled when file is closed.</span></span><br><span class="line">	csema <span class="keyword">uint32</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Non-zero if this file has been set to blocking mode.</span></span><br><span class="line">	isBlocking <span class="keyword">uint32</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Whether this is a streaming descriptor, as opposed to a</span></span><br><span class="line">	<span class="comment">// packet-based descriptor like a UDP socket. Immutable.</span></span><br><span class="line">	IsStream <span class="keyword">bool</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Whether a zero byte read indicates EOF. This is false for a</span></span><br><span class="line">	<span class="comment">// message based socket connection.</span></span><br><span class="line">	ZeroReadIsEOF <span class="keyword">bool</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Whether this is a file rather than a network socket.</span></span><br><span class="line">	isFile <span class="keyword">bool</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>pollDesc</strong></p>
<p>pollDesc æ˜¯åº•å±‚äº‹ä»¶é©±åŠ¨çš„å°è£…ï¼ŒnetFD é€šè¿‡å®ƒæ¥å®Œæˆå„ç§ I/O ç›¸å…³çš„æ“ä½œï¼Œå®ƒçš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// åº•å±‚äº‹ä»¶é©±åŠ¨çš„å°è£…ï¼ŒnetFD é€šè¿‡å®ƒæ¥å®Œæˆå„ç§ I/O ç›¸å…³çš„æ“ä½œ</span><br><span class="line">type pollDesc struct &#123;</span><br><span class="line">	runtimeCtx uintptr</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œçš„ struct åªåŒ…å«äº†ä¸€ä¸ªæŒ‡é’ˆï¼Œè€Œé€šè¿‡ pollDesc çš„ init æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°å®ƒå…·ä½“çš„å®šä¹‰æ˜¯åœ¨ <code>runtime.pollDesc</code> è¿™é‡Œï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// netFD.init ä¼šè°ƒç”¨ poll.FD.Init å¹¶æœ€ç»ˆè°ƒç”¨åˆ° pollDesc.initï¼Œ</span></span><br><span class="line"><span class="comment">// å®ƒä¼šåˆ›å»º epoll å®ä¾‹å¹¶æŠŠ listener fd åŠ å…¥ç›‘å¬é˜Ÿåˆ—</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pd *pollDesc)</span> <span class="title">init</span><span class="params">(fd *FD)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="comment">// runtime_pollServerInit é€šè¿‡ `go:linkname` é“¾æ¥åˆ°å…·ä½“çš„å®ç°å‡½æ•° poll_runtime_pollServerInitï¼Œ</span></span><br><span class="line">	<span class="comment">// æ¥ç€å†è°ƒç”¨ netpollGenericInitï¼Œç„¶åä¼šæ ¹æ®ä¸åŒçš„ç³»ç»Ÿå¹³å°å»è°ƒç”¨ç‰¹å®šçš„ netpollinit æ¥åˆ›å»º epoll å®ä¾‹</span></span><br><span class="line">	serverInit.Do(runtime_pollServerInit)</span><br><span class="line">	<span class="comment">// runtime_pollOpen å†…éƒ¨è°ƒç”¨äº† netpollopen æ¥å°† listener fd æ³¨å†Œåˆ° epoll å®ä¾‹ä¸­ï¼Œå¦å¤–ï¼Œå®ƒä¼šåˆå§‹åŒ–ä¸€ä¸ª pollDesc å¹¶è¿”å›</span></span><br><span class="line">	ctx, errno := runtime_pollOpen(<span class="keyword">uintptr</span>(fd.Sysfd))</span><br><span class="line">	<span class="keyword">if</span> errno != <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> ctx != <span class="number">0</span> &#123;</span><br><span class="line">			runtime_pollUnblock(ctx)</span><br><span class="line">			runtime_pollClose(ctx)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> errnoErr(syscall.Errno(errno))</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// æŠŠçœŸæ­£åˆå§‹åŒ–å®Œæˆçš„ pollDesc å®ä¾‹èµ‹å€¼ç»™å½“å‰çš„ pollDesc ä»£è¡¨è‡ªèº«çš„æŒ‡é’ˆï¼Œ</span></span><br><span class="line">	<span class="comment">// åç»­ä½¿ç”¨ç›´æ¥é€šè¿‡è¯¥æŒ‡é’ˆæ“ä½œ</span></span><br><span class="line">	pd.runtimeCtx = ctx</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Network poller descriptor.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// No heap pointers.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//go:notinheap</span></span><br><span class="line"><span class="keyword">type</span> pollDesc <span class="keyword">struct</span> &#123;</span><br><span class="line">	link *pollDesc <span class="comment">// in pollcache, protected by pollcache.lock</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// The lock protects pollOpen, pollSetDeadline, pollUnblock and deadlineimpl operations.</span></span><br><span class="line">	<span class="comment">// This fully covers seq, rt and wt variables. fd is constant throughout the PollDesc lifetime.</span></span><br><span class="line">	<span class="comment">// pollReset, pollWait, pollWaitCanceled and runtimeÂ·netpollready (IO readiness notification)</span></span><br><span class="line">	<span class="comment">// proceed w/o taking the lock. So closing, everr, rg, rd, wg and wd are manipulated</span></span><br><span class="line">	<span class="comment">// in a lock-free way by all operations.</span></span><br><span class="line">	<span class="comment">// NOTE(dvyukov): the following code uses uintptr to store *g (rg/wg),</span></span><br><span class="line">	<span class="comment">// that will blow up when GC starts moving objects.</span></span><br><span class="line">	lock    mutex <span class="comment">// protects the following fields</span></span><br><span class="line">	fd      <span class="keyword">uintptr</span></span><br><span class="line">	closing <span class="keyword">bool</span></span><br><span class="line">	everr   <span class="keyword">bool</span>    <span class="comment">// marks event scanning error happened</span></span><br><span class="line">	user    <span class="keyword">uint32</span>  <span class="comment">// user settable cookie</span></span><br><span class="line">	rseq    <span class="keyword">uintptr</span> <span class="comment">// protects from stale read timers</span></span><br><span class="line">	<span class="comment">// å–å€¼åˆ†åˆ«å¯èƒ½æ˜¯ pdReadyã€pdWaitã€ç­‰å¾… file descriptor å°±ç»ªçš„ goroutine ä¹Ÿå°±æ˜¯ g æ•°æ®ç»“æ„ä»¥åŠ nilï¼Œå®ƒä»¬æ˜¯å®ç°å”¤é†’ goroutine çš„å…³é”®</span></span><br><span class="line">	rg   <span class="keyword">uintptr</span> <span class="comment">// pdReady, pdWait, G waiting for read or nil</span></span><br><span class="line">	rt   timer   <span class="comment">// read deadline timer (set if rt.f != nil)</span></span><br><span class="line">	rd   <span class="keyword">int64</span>   <span class="comment">// read deadline</span></span><br><span class="line">	wseq <span class="keyword">uintptr</span> <span class="comment">// protects from stale write timers</span></span><br><span class="line">	<span class="comment">// å–å€¼åˆ†åˆ«å¯èƒ½æ˜¯ pdReadyã€pdWaitã€ç­‰å¾… file descriptor å°±ç»ªçš„ goroutine ä¹Ÿå°±æ˜¯ g æ•°æ®ç»“æ„ä»¥åŠ nilï¼Œå®ƒä»¬æ˜¯å®ç°å”¤é†’ goroutine çš„å…³é”®</span></span><br><span class="line">	wg   <span class="keyword">uintptr</span>   <span class="comment">// pdReady, pdWait, G waiting for write or nil</span></span><br><span class="line">	wt   timer     <span class="comment">// write deadline timer</span></span><br><span class="line">	wd   <span class="keyword">int64</span>     <span class="comment">// write deadline</span></span><br><span class="line">	self *pollDesc <span class="comment">// storage for indirect interface. See (*pollDesc).makeArg.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>
    
    
    

    <div>
      
        <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------æœ¬æ–‡ç»“æŸ<i class="fa fa-paw"></i>æ„Ÿè°¢æ‚¨çš„é˜…è¯»-------------</div>
    
</div>

      
    </div>

    <div>
          
            
<div class="my_post_copyright">
  <script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>

  <!-- JSåº“ sweetalert å¯ä¿®æ”¹è·¯å¾„ -->
  <script src="https://cdn.bootcss.com/jquery/2.0.0/jquery.min.js"></script>
  <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
  <p><span>æœ¬æ–‡æ ‡é¢˜:</span><a href="/2021/08/24/IOMultiplexing/">æ·±å…¥ç†è§£Golangç½‘ç»œè½®è¯¢å™¨NetPoller</a></p>
  <p><span>æ–‡ç« ä½œè€…:</span><a href="/" title="è®¿é—® Wxning çš„ä¸ªäººåšå®¢">Wxning</a></p>
  <p><span>å‘å¸ƒæ—¶é—´:</span>2021å¹´08æœˆ24æ—¥ - 17:08</p>
  <p><span>æœ€åæ›´æ–°:</span>2021å¹´08æœˆ26æ—¥ - 14:08</p>
  <p><span>åŸå§‹é“¾æ¥:</span><a href="/2021/08/24/IOMultiplexing/" title="æ·±å…¥ç†è§£Golangç½‘ç»œè½®è¯¢å™¨NetPoller">http://yoursite.com/2021/08/24/IOMultiplexing/</a>
    <span class="copy-path" title="ç‚¹å‡»å¤åˆ¶æ–‡ç« é“¾æ¥"><i class="fa fa-clipboard" data-clipboard-text="http://yoursite.com/2021/08/24/IOMultiplexing/" aria-label="å¤åˆ¶æˆåŠŸï¼"></i></span>
  </p>
  <p><span>è®¸å¯åè®®:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç¦æ­¢æ¼”ç» 4.0 å›½é™…</a> è½¬è½½è¯·ä¿ç•™åŸæ–‡é“¾æ¥åŠä½œè€…ã€‚</p>
</div>
<script>
    var clipboard = new Clipboard('.fa-clipboard');
    $(".fa-clipboard").click(function(){
      clipboard.on('success', function(){
        swal({
          title: "",
          text: 'å¤åˆ¶æˆåŠŸ',
          icon: "success",
          showConfirmButton: true
          });
    });
    });
</script>


          
    </div>

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/golang/" rel="tag"># golang</a>
          
            <a href="/tags/golang-source/" rel="tag"># golang source</a>
          
            <a href="/tags/network/" rel="tag"># network</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/11/28/scheduler/" rel="next" title="æ·±å…¥ç†è§£Kubernetessä¹‹è°ƒåº¦å™¨">
                <i class="fa fa-chevron-left"></i> æ·±å…¥ç†è§£Kubernetessä¹‹è°ƒåº¦å™¨
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="lv-container" data-id="city" data-uid="MTAyMC80NTE2Ny8yMTY4NA=="></div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            æ–‡ç« ç›®å½•
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            ç«™ç‚¹æ¦‚è§ˆ
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.gif" alt="Wxning">
            
              <p class="site-author-name" itemprop="name">Wxning</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">39</span>
                  <span class="site-state-item-name">æ—¥å¿—</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">43</span>
                  <span class="site-state-item-name">åˆ†ç±»</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">35</span>
                  <span class="site-state-item-name">æ ‡ç­¾</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/wxning1107" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#é˜»å¡I-Oä¸éé˜»å¡I-O"><span class="nav-number">1.</span> <span class="nav-text">é˜»å¡I/Oä¸éé˜»å¡I/O</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#I-Oå¤šè·¯å¤ç”¨"><span class="nav-number">2.</span> <span class="nav-text">I/Oå¤šè·¯å¤ç”¨</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#select-amp-poll"><span class="nav-number">3.</span> <span class="nav-text">select &amp; poll</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#epoll"><span class="nav-number">4.</span> <span class="nav-text">epoll</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#go-netPoller"><span class="nav-number">5.</span> <span class="nav-text">go netPoller</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ç½‘ç»œè½®è¯¢å™¨æ¥å£"><span class="nav-number">6.</span> <span class="nav-text">ç½‘ç»œè½®è¯¢å™¨æ¥å£</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#æ•°æ®ç»“æ„"><span class="nav-number">7.</span> <span class="nav-text">æ•°æ®ç»“æ„</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Wxning</span>

  
</div>


  <div class="powered-by">ç”± <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> å¼ºåŠ›é©±åŠ¨</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">ä¸»é¢˜ &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i> è®¿é—®äººæ•°
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      äºº
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i> æ€»è®¿é—®é‡
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      æ¬¡
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  












  





  

  

  

  
  

  

  

  

</body>
</html>
